---
title: "NFDS model with COGtriangles and manual sequence clusters"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r}
# install.packages("drat") # -- if you don't have drat installed
# drat:::add("ncov-ic")
# install.packages("odin.dust")
library(odin.dust)
#install.packages("mcstate")
library(mcstate)
# Package for derivative-free fitting in R:
library(dfoptim)
```

# import data sets from data processing:
```{r}
Mass_Samples_accCodes <- readRDS(file = "Mass_Samples_accCodes.rds")
intermed_gene_presence_absence_consensus <- readRDS(file = "intermed_gene_presence_absence_consensus.rds")
intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
model_start_pop <- readRDS(file = "model_start_pop.rds")
delta_ranking <- readRDS(file = "delta_ranking.rds")
mass_cluster_freq_1 <- readRDS(file = "mass_cluster_freq_1.rds")
mass_cluster_freq_2 <- readRDS(file = "mass_cluster_freq_2.rds")
mass_cluster_freq_3 <- readRDS(file = "mass_cluster_freq_3.rds")
mass_VT <- readRDS(file = "mass_VT.rds")
```


```{r}
WF_nG_h_vP <- odin.dust::odin_dust("NFDS_Model.R")
# copy of WrightFisherModel/WrightFisher_newData_nGenotypes_haploid_PopsizeVariablePois.R
```

#define parameters for the model:
```{r}
mass_clusters <- length(unique(Mass_Samples_accCodes$SequenceCluster))
avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)

params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = delta_ranking, m = 0.0052207254, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1321567425, vacc_time = 0)
```

### Running the model:
```{r}
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = params_n_vP,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
# try using dfoptim with likelihood
ll_pois <- function(obs, model) {
  exp_noise <- 1e6

  if (is.na(obs)) {
    # Creates vector of zeros in ll with same length, if no data
    ll_obs <- numeric(length(model))
  } else {
    lambda <- model + rexp(n = length(model), rate = exp_noise)
    ll_obs <- dpois(x = obs, lambda = lambda, log = TRUE)
  }
  ll_obs
}

combined_compare <- function(state, observed, pars = NULL) {
  result <- 0
  #data_size <- sum(mass_cluster_freq_1)
  #model_size = 15000
  data_size <- sum(observed)
  model_size = sum(state)
  
  for (i in 1:length(observed)){
    result <- result + ll_pois(observed[i], state[i]/model_size * data_size)
  }
  result
}

fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = delta_ranking, m = params[4], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],mass_cluster_freq_2) + combined_compare(x[,1,73],mass_cluster_freq_3)
}

```

```{r}
optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.326448072 0.001129911 0.384818488 0.011920907 0.187427953

#$value
#[1] -193.3568
```


```{r}
end_params <- rep(0,5)
end_error <- 3
for (i in 1:10) {
  start_params <- runif(5)
  optim_fit <- nmkb(start_params, fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
  if(optim_fit$value < end_error){
    end_error <- optim_fit$value
    end_params <- optim_fit$par
  }
}

#> end_error
#[1] -367.9466
#> end_params
#[1] 0.8745946 0.9441601 0.3326991 0.8484669 0.6790299

# these are not great values --> maybe this fitting does not work as well as hoped and gets stuck in local optimum
```

### prev version COGtriangles gene clusters for comparison
# these are the pre-processed data files that I was using last summer

# import data sets from data processing:
```{r}
prev_intermed_gene_presence_absence_consensus <- readRDS(file = "prev_mass_consensus_presence_absence.rds")
prev_intermed_gene_presence_absence_consensus_matrix <- sapply(prev_intermed_gene_presence_absence_consensus[,-1],as.double)
prev_delta_ranking <- readRDS(file = "prev_delta_ranking.rds")
```

#define parameters for the model:
```{r}
prev_params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(prev_intermed_gene_presence_absence_consensus), Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = prev_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = prev_delta_ranking, m = 0.0052207254, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1321567425, vacc_time = 0)
```

### Running the model:
```{r}
prev_WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = prev_params_n_vP,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
prev_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(prev_intermed_gene_presence_absence_consensus), Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = prev_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = prev_delta_ranking, m = params[4], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],mass_cluster_freq_2) + combined_compare(x[,1,73],mass_cluster_freq_3)
}
```

```{r}
prev_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), prev_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.091127278 0.001265479 0.133685351 0.008260285 0.035640495

#$value
#[1] -205.9497
```


### PopPUNK

# import PopPUNK data sets

```{r}
PopPUNK_clusters <- readRDS("PopPUNK_clusters.rds")
PP_intermed_gene_presence_absence_consensus <- readRDS(file = "PP_intermed_gene_presence_absence_consensus.rds")
PP_intermed_gene_presence_absence_consensus_matrix <- sapply(PP_intermed_gene_presence_absence_consensus[-1,-1],as.double)
PP_model_start_pop <- readRDS(file = "PP_model_start_pop.rds")
#delta_ranking <- readRDS(file = "delta_ranking.rds")
PP_mass_cluster_freq_1 <- readRDS(file = "PP_mass_cluster_freq_1.rds")
PP_mass_cluster_freq_2 <- readRDS(file = "PP_mass_cluster_freq_2.rds")
PP_mass_cluster_freq_3 <- readRDS(file = "PP_mass_cluster_freq_3.rds")
PP_mass_VT <- readRDS(file = "PP_mass_VT.rds")
```

```{r}
PP_mass_clusters <- length(unique(PopPUNK_clusters$Cluster))
PP_avg_cluster_freq <- rep(1/PP_mass_clusters, PP_mass_clusters)
```

```{r}
WF_PP <- odin.dust::odin_dust("NFDS_Model.R")
```

```{r}
PP_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = delta_ranking, m = params[4], migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_PP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3)
}
```

```{r}
PP_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), PP_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.30823650 0.04393502 0.33582177 0.12021641 0.35791045


#$value
#[1] -294.1526
```


### ggCaller with manual Sequence Clusters
# import data sets from data processing:
```{r}
Mass_Samples_accCodes <- readRDS(file = "Mass_Samples_accCodes.rds")
ggC_intermed_gene_presence_absence_consensus <- readRDS(file = "ggC_intermed_gene_presence_absence_consensus.rds")
ggC_intermed_gene_presence_absence_consensus_matrix <- sapply(ggC_intermed_gene_presence_absence_consensus[-1,-1],as.double)
model_start_pop <- readRDS(file = "model_start_pop.rds")
ggC_delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
mass_cluster_freq_1 <- readRDS(file = "mass_cluster_freq_1.rds")
mass_cluster_freq_2 <- readRDS(file = "mass_cluster_freq_2.rds")
mass_cluster_freq_3 <- readRDS(file = "mass_cluster_freq_3.rds")
mass_VT <- readRDS(file = "mass_VT.rds")
```

```{r}
WF_ggC <- odin.dust::odin_dust("NFDS_Model.R")
# copy of WrightFisherModel/WrightFisher_newData_nGenotypes_haploid_PopsizeVariablePois.R
```

#define parameters for the model:
```{r}
mass_clusters <- length(unique(Mass_Samples_accCodes$SequenceCluster))
avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)

params_ggC <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(ggC_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = ggC_delta_ranking, m = 0.0052207254, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1321567425, vacc_time = 0)
```

### Running the model:
```{r}
ggC_WFmodel <- WF_ggC$new(pars = params_ggC,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
ggC_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(ggC_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = ggC_delta_ranking, m = params[4], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_ggC$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],mass_cluster_freq_2) + combined_compare(x[,1,73],mass_cluster_freq_3)
}

```

```{r}
ggC_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), ggC_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.21366993 0.00176741 0.19665062 0.00977433 0.14496577

#$value
#[1] -184.6705

#better value than COGtriangles + manual seq clusters and COGtriangles + PopPUNK clusters!
```

### ggCaller + PopPUNK

```{r}
PopPUNK_clusters <- readRDS("PopPUNK_clusters.rds")
ggCPP_intermed_gene_presence_absence_consensus <- readRDS(file = "ggCPP_intermed_gene_presence_absence_consensus.rds")
ggCPP_intermed_gene_presence_absence_consensus_matrix <- sapply(ggCPP_intermed_gene_presence_absence_consensus[-1,-1],as.double)
PP_model_start_pop <- readRDS(file = "PP_model_start_pop.rds")
ggC_delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
PP_mass_cluster_freq_1 <- readRDS(file = "PP_mass_cluster_freq_1.rds")
PP_mass_cluster_freq_2 <- readRDS(file = "PP_mass_cluster_freq_2.rds")
PP_mass_cluster_freq_3 <- readRDS(file = "PP_mass_cluster_freq_3.rds")
PP_mass_VT <- readRDS(file = "PP_mass_VT.rds")
```

```{r}
PP_mass_clusters <- length(unique(PopPUNK_clusters$Cluster))
PP_avg_cluster_freq <- rep(1/PP_mass_clusters, PP_mass_clusters)
```

# Fitting the model:

```{r}
ggCPP_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = ggC_delta_ranking, m = params[4], migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_ggC$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3) 
}
```

```{r}
ggCPP_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), ggCPP_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.138193890 0.008439717 0.199494193 0.024378998 0.155166177

#$value
#[1] -263.3126

# A little worse than ggCaller + manual seq clusters
# but might not be comparable
```

### Visualise Fits:

```{r}
source("CreateLollipopPlot.R")
```

```{r}

#fit_params <- c(2.400584e-01, 9.981659e-05, 2.948024e-01, 7.317635e-03, 9.683020e-02)
#better_fit_params <- c(2.400549e-01, 9.981205e-05, 2.948120e-01, 7.317485e-03, 9.683313e-02)
fit_params <- optim_fit$par
all_params <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = fit_params[1], sigma_w = fit_params[2], prop_f = fit_params[3], delta = delta_ranking, m = fit_params[4], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = fit_params[5], vacc_time = 0)
WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
model_val1 <- x[,1,1]
model_val2 <- x[,1,37]
model_val3 <- x[,1,73]

model1_VT <- model_val1[which(mass_VT==1)]
model1_NVT <- model_val1[which(mass_VT==0)]
model2_VT <- model_val2[which(mass_VT==1)]
model2_NVT <- model_val2[which(mass_VT==0)]
model3_VT <- model_val3[which(mass_VT==1)]
model3_NVT <- model_val3[which(mass_VT==0)]


### COGtriangles and manual sequence clusters
lollipop_cluster_freqs(plot_title = "Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_1[which(mass_VT==1)]/sum(mass_cluster_freq_1), data2 = mass_cluster_freq_2[which(mass_VT==1)]/sum(mass_cluster_freq_2), data3= mass_cluster_freq_3[which(mass_VT==1)]/sum(mass_cluster_freq_3), model1 = model1_VT/sum(model_val1), model2 = model2_VT/sum(model_val2), model3 = model3_VT/sum(model_val3))
lollipop_cluster_freqs(plot_title = "Non-Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_1[which(mass_VT==0)]/sum(mass_cluster_freq_1), data2 = mass_cluster_freq_2[which(mass_VT==0)]/sum(mass_cluster_freq_2), data3= mass_cluster_freq_3[which(mass_VT==0)]/sum(mass_cluster_freq_3), model1 = model1_NVT/sum(model_val1), model2 = model2_NVT/sum(model_val2), model3 = model3_NVT/sum(model_val3))
```

```{r}
### COGtriangles and PopPUNK clusters
PP_fit_params <- PP_optim_fit$par
all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = PP_fit_params[1], sigma_w = PP_fit_params[2], prop_f = PP_fit_params[3], delta = delta_ranking, m = PP_fit_params[4], migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = PP_fit_params[5], vacc_time = 0)
WFmodel_PP <- WF_PP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(WFmodel_PP$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel_PP$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
PP_model_val1 <- x[,1,1]
PP_model_val2 <- x[,1,37]
PP_model_val3 <- x[,1,73]

PP_model1_VT <- PP_model_val1[which(PP_mass_VT==1)]
PP_model1_NVT <- PP_model_val1[which(PP_mass_VT==0)]
PP_model2_VT <- PP_model_val2[which(PP_mass_VT==1)]
PP_model2_NVT <- PP_model_val2[which(PP_mass_VT==0)]
PP_model3_VT <- PP_model_val3[which(PP_mass_VT==1)]
PP_model3_NVT <- PP_model_val3[which(PP_mass_VT==0)]

### COGtriangles and manual sequence clusters
lollipop_cluster_freqs(plot_title = "Vaccine Types, PopPUNK Clusters", data1 = PP_mass_cluster_freq_1[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_1), data2 = PP_mass_cluster_freq_2[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_2), data3= PP_mass_cluster_freq_3[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_3), model1 = PP_model1_VT/sum(PP_model_val1), model2 = PP_model2_VT/sum(PP_model_val2), model3 = PP_model3_VT/sum(PP_model_val3))
lollipop_cluster_freqs(plot_title = "Non-Vaccine Types, PopPUNK Clusters",data1 = PP_mass_cluster_freq_1[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_1), data2 = PP_mass_cluster_freq_2[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_2), data3= PP_mass_cluster_freq_3[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_3), model1 = PP_model1_NVT/sum(PP_model_val1), model2 = PP_model2_NVT/sum(PP_model_val2), model3 = PP_model3_NVT/sum(PP_model_val3))
```

#ggC plot data

```{r}

ggC_fit_params <- ggC_optim_fit$par
all_params <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(ggC_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_consensus_matrix, sigma_f = ggC_fit_params[1], sigma_w = ggC_fit_params[2], prop_f = ggC_fit_params[3], delta = ggC_delta_ranking, m = ggC_fit_params[4], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = ggC_fit_params[5], vacc_time = 0)
ggC_WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(ggC_WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- ggC_WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
ggC_model_val1 <- x[,1,1]
ggC_model_val2 <- x[,1,37]
ggC_model_val3 <- x[,1,73]

ggC_model1_VT <- ggC_model_val1[which(mass_VT==1)]
ggC_model1_NVT <- ggC_model_val1[which(mass_VT==0)]
ggC_model2_VT <- ggC_model_val2[which(mass_VT==1)]
ggC_model2_NVT <- ggC_model_val2[which(mass_VT==0)]
ggC_model3_VT <- ggC_model_val3[which(mass_VT==1)]
ggC_model3_NVT <- ggC_model_val3[which(mass_VT==0)]

```

#ggCPP plot data

```{r}

ggCPP_fit_params <- ggCPP_optim_fit$par
all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = ggCPP_fit_params[1], sigma_w = ggCPP_fit_params[2], prop_f = ggCPP_fit_params[3], delta = ggC_delta_ranking, m = ggCPP_fit_params[4], migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = ggCPP_fit_params[5], vacc_time = 0)
ggCPP_WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(ggCPP_WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- ggCPP_WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
ggCPP_model_val1 <- x[,1,1]
ggCPP_model_val2 <- x[,1,37]
ggCPP_model_val3 <- x[,1,73]

ggCPP_model1_VT <- ggCPP_model_val1[which(PP_mass_VT==1)]
ggCPP_model1_NVT <- ggCPP_model_val1[which(PP_mass_VT==0)]
ggCPP_model2_VT <- ggCPP_model_val2[which(PP_mass_VT==1)]
ggCPP_model2_NVT <- ggCPP_model_val2[which(PP_mass_VT==0)]
ggCPP_model3_VT <- ggCPP_model_val3[which(PP_mass_VT==1)]
ggCPP_model3_NVT <- ggCPP_model_val3[which(PP_mass_VT==0)]

```

```{r}
# Plot NVTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Non-Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_1[which(mass_VT==0)]/sum(mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = model1_NVT/sum(model_val1), model_name_2 = "ggCaller", model2 = ggC_model1_NVT/sum(ggC_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Non-Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_2[which(mass_VT==0)]/sum(mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = model2_NVT/sum(model_val2), model_name_2 = "ggCaller", model2 = ggC_model2_NVT/sum(ggC_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Non-Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_3[which(mass_VT==0)]/sum(mass_cluster_freq_3), model_name_1 = "COGtriangles", model1 = model3_NVT/sum(model_val3), model_name_2 = "ggCaller", model2 = ggC_model3_NVT/sum(ggC_model_val3))
```

```{r}
# Plot VTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_1[which(mass_VT==1)]/sum(mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = model1_VT/sum(model_val1), model_name_2 = "ggCaller", model2 = ggC_model1_VT/sum(ggC_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_2[which(mass_VT==1)]/sum(mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = model2_VT/sum(model_val2), model_name_2 = "ggCaller", model2 = ggC_model2_VT/sum(ggC_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_3[which(mass_VT==1)]/sum(mass_cluster_freq_3), model_name_1 = "COGtriangles", model1 = model3_VT/sum(model_val3), model_name_2 = "ggCaller", model2 = ggC_model3_VT/sum(ggC_model_val3))
```

### PopPUNK clusters:
```{r}
# Plot NVTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Non-Vaccine Types, PopPUNK Clusters",data1 = PP_mass_cluster_freq_1[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = PP_model1_NVT/sum(PP_model_val1), model_name_2 = "ggCaller", model2 = ggCPP_model1_NVT/sum(ggCPP_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Non-Vaccine Types, PopPUNK  Clusters",data1 = PP_mass_cluster_freq_2[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = PP_model2_NVT/sum(PP_model_val2), model_name_2 = "ggCaller", model2 = ggCPP_model2_NVT/sum(ggCPP_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Non-Vaccine Types, PopPUNK  Clusters",data1 = PP_mass_cluster_freq_2[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = PP_model3_NVT/sum(PP_model_val3), model_name_2 = "ggCaller", model2 = ggCPP_model3_NVT/sum(ggCPP_model_val3))
```

```{r}
# Plot VTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Vaccine Types, PopPUNK Clusters",data1 = PP_mass_cluster_freq_1[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = PP_model1_VT/sum(PP_model_val1), model_name_2 = "ggCaller", model2 = ggCPP_model1_VT/sum(ggCPP_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Vaccine Types, PopPUNK Clusters",data1 = PP_mass_cluster_freq_2[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = PP_model2_VT/sum(PP_model_val2), model_name_2 = "ggCaller", model2 = ggCPP_model2_VT/sum(ggCPP_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Vaccine Types, PopPUNK Clusters",data1 = PP_mass_cluster_freq_2[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = PP_model3_VT/sum(PP_model_val3), model_name_2 = "ggCaller", model2 = ggCPP_model3_VT/sum(ggCPP_model_val3))
```

### Plot VTs and NVT together in one plot
```{r}
#ggCPP_model_val1
lollipop_cluster_freqs_VTandNVT(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = ggCPP_model_val1/sum(ggCPP_model_val1), PP_mass_VT)
lollipop_cluster_freqs_VTandNVT(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = ggCPP_model_val2/sum(ggCPP_model_val2), PP_mass_VT)
lollipop_cluster_freqs_VTandNVT(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = ggCPP_model_val3/sum(ggCPP_model_val3), PP_mass_VT)
```



### THOUGHTS ABOUT THE COMPARABILITY OF LIKELIHOODS
# Question: Does the likelihood decrease with the number of clusters?
# Answer: 

# these two are not the same
# dpois(x = 10, lambda = 11) + dpois(x = 10, lambda = 9)
#dpois(x = 10, lambda = 11, log = TRUE) + dpois(x = 5, lambda = 4, log = TRUE) + dpois(x = 4, lambda = 4, log = TRUE)
# these two are:
# sum(abs(10-11)+sum(9-10))
# sum(abs(10-11)+sum(abs(5-4))+sum(abs(4-4)))


# sum(abs(model_val2/sum(model_val2) - mass_cluster_freq_2/sum(mass_cluster_freq_2))) + sum(abs(model_val3/sum(model_val3) - mass_cluster_freq_3/sum(mass_cluster_freq_3)))
#[1] 0.9182114
#sum(abs(PP_model_val2/sum(PP_model_val2) - PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2))) + sum(abs(PP_model_val3/sum(PP_model_val3) - PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3)))
# [1] 0.9997534
#sum(abs(ggCPP_model_val2/sum(ggCPP_model_val2) - PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2))) + sum(abs(ggCPP_model_val3/sum(ggCPP_model_val3) - PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3)))
# [1] 0.846745
# sum(abs(ggC_model_val2/sum(ggC_model_val2) - mass_cluster_freq_2/sum(mass_cluster_freq_2))) + sum(abs(ggC_model_val3/sum(ggC_model_val3) - mass_cluster_freq_3/sum(mass_cluster_freq_3)))
# [1] 0.7446736


### filter PopPUNK clusters for max(size(cluster))>1
```{r}
filt_PP_mass_cluster_freq_1 <- readRDS(file = "filt_PP_mass_cluster_freq_1.rds")
filt_PP_mass_cluster_freq_2 <- readRDS(file = "filt_PP_mass_cluster_freq_2.rds")
filt_PP_mass_cluster_freq_3 <- readRDS(file = "filt_PP_mass_cluster_freq_3.rds")
filt_PP_intermed_gene_presence_absence_consensus <- readRDS(file = "filt_PP_intermed_gene_presence_absence_consensus.rds")
filt_PP_intermed_gene_presence_absence_consensus_matrix <-sapply(filt_PP_intermed_gene_presence_absence_consensus[-1,-1],as.double)
filt_PP_mass_VT <- readRDS( file = "filt_PP_mass_VT.rds")
filt_PP_model_start_pop <- readRDS(file = "filt_PP_model_start_pop.rds")
filt_PP_mass_clusters <- length(filt_PP_mass_cluster_freq_1)
filt_PP_avg_cluster_freq <- PP_avg_cluster_freq[apply(matrix(c(PP_mass_cluster_freq_1,PP_mass_cluster_freq_2, PP_mass_cluster_freq_3),nrow=3,ncol=length(PP_mass_cluster_freq_1),byrow = TRUE),2,max)>1]
```

```{r}
filt_PP_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = filt_PP_mass_clusters,  gene_no = nrow(filt_PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(filt_PP_model_start_pop), Pop_eq = as.double(filt_PP_model_start_pop), capacity = sum(filt_PP_model_start_pop), Genotypes = filt_PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = delta_ranking, m = params[4], migVec = filt_PP_avg_cluster_freq, vaccTypes = filt_PP_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_PP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3) 
  #sum((x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))^2) + sum((x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3)))^2)
  #sum(abs(x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))) + sum(abs(x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3))))
}
```

```{r}
filt_PP_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), filt_PP_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.299432553 0.002611058 0.410155291 0.131020909 0.216579505

#$value
#[1] -276.0369

# slight improvement over unfiltered PopPUNK + COGtriangles
```

# ggCaller with filtered PopPUNK
```{r}
filt_ggCPP_intermed_gene_presence_absence_consensus <-readRDS(file = "filt_ggCPP_intermed_gene_presence_absence_consensus.rds")
filt_ggCPP_intermed_gene_presence_absence_consensus_matrix <-sapply(filt_ggCPP_intermed_gene_presence_absence_consensus[-1,-1],as.double)
```

```{r}
filt_ggCPP_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = filt_PP_mass_clusters,  gene_no = nrow(filt_ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(filt_PP_model_start_pop), Pop_eq = as.double(filt_PP_model_start_pop), capacity = sum(filt_PP_model_start_pop), Genotypes = filt_ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = ggC_delta_ranking, m = params[4], migVec = filt_PP_avg_cluster_freq, vaccTypes = filt_PP_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_PP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3) 
  #sum((x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))^2) + sum((x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3)))^2)
  #sum(abs(x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))) + sum(abs(x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3))))
}
```

```{r}
filt_ggCPP_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), filt_ggCPP_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.052109427 0.001694954 0.497849841 0.069497537 0.148361001

#$value
#[1] -278.0763

# not an improvement compared to unfiltered PopPUNK + ggCaller
```

```{r}
### COGtriangles and PopPUNK clusters
filt_PP_fit_params <- filt_PP_optim_fit$par
all_params <- list(dt = 1/36, species_no = filt_PP_mass_clusters,  gene_no = nrow(filt_PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(filt_PP_model_start_pop), Pop_eq = as.double(filt_PP_model_start_pop), capacity = sum(filt_PP_model_start_pop), Genotypes = filt_PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = filt_PP_fit_params[1], sigma_w = filt_PP_fit_params[2], prop_f = filt_PP_fit_params[3], delta = delta_ranking, m = filt_PP_fit_params[4], migVec = filt_PP_avg_cluster_freq, vaccTypes = filt_PP_mass_VT, v = filt_PP_fit_params[5], vacc_time = 0)
WFmodel_PP <- WF_PP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(WFmodel_PP$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel_PP$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
filt_PP_model_val1 <- x[,1,1]
filt_PP_model_val2 <- x[,1,37]
filt_PP_model_val3 <- x[,1,73]

filt_PP_model1_VT <- filt_PP_model_val1[which(filt_PP_mass_VT==1)]
filt_PP_model1_NVT <- filt_PP_model_val1[which(filt_PP_mass_VT==0)]
filt_PP_model2_VT <- filt_PP_model_val2[which(filt_PP_mass_VT==1)]
filt_PP_model2_NVT <- filt_PP_model_val2[which(filt_PP_mass_VT==0)]
filt_PP_model3_VT <- filt_PP_model_val3[which(filt_PP_mass_VT==1)]
filt_PP_model3_NVT <- filt_PP_model_val3[which(filt_PP_mass_VT==0)]
```

#filtered ggCPP plot data

```{r}

filt_ggCPP_fit_params <- filt_ggCPP_optim_fit$par
all_params <- list(dt = 1/36, species_no = filt_PP_mass_clusters,  gene_no = nrow(filt_ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(filt_PP_model_start_pop), Pop_eq = as.double(filt_PP_model_start_pop), capacity = sum(filt_PP_model_start_pop), Genotypes = filt_ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = filt_ggCPP_fit_params[1], sigma_w = filt_ggCPP_fit_params[2], prop_f = filt_ggCPP_fit_params[3], delta = ggC_delta_ranking, m = filt_ggCPP_fit_params[4], migVec = filt_PP_avg_cluster_freq, vaccTypes = filt_PP_mass_VT, v = filt_ggCPP_fit_params[5], vacc_time = 0)
ggCPP_WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(ggCPP_WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- ggCPP_WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
filt_ggCPP_model_val1 <- x[,1,1]
filt_ggCPP_model_val2 <- x[,1,37]
filt_ggCPP_model_val3 <- x[,1,73]

filt_ggCPP_model1_VT <- filt_ggCPP_model_val1[which(filt_PP_mass_VT==1)]
filt_ggCPP_model1_NVT <- filt_ggCPP_model_val1[which(filt_PP_mass_VT==0)]
filt_ggCPP_model2_VT <- filt_ggCPP_model_val2[which(filt_PP_mass_VT==1)]
filt_ggCPP_model2_NVT <- filt_ggCPP_model_val2[which(filt_PP_mass_VT==0)]
filt_ggCPP_model3_VT <- filt_ggCPP_model_val3[which(filt_PP_mass_VT==1)]
filt_ggCPP_model3_NVT <- filt_ggCPP_model_val3[which(filt_PP_mass_VT==0)]

```

### filtered PopPUNK clusters:
```{r}
# Plot NVTs
lollipop_cluster_freqs_3points(year = "2001", plot_title = "Non-Vaccine Types, PopPUNK Clusters",data1 = filt_PP_mass_cluster_freq_1[which(filt_PP_mass_VT==0)]/sum(filt_PP_mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = filt_PP_model1_NVT/sum(filt_PP_model_val1), model_name_2 = "ggCaller", model2 = filt_ggCPP_model1_NVT/sum(filt_ggCPP_model_val1))
lollipop_cluster_freqs_3points(year = "2004",plot_title = "Non-Vaccine Types, PopPUNK  Clusters",data1 = filt_PP_mass_cluster_freq_2[which(filt_PP_mass_VT==0)]/sum(filt_PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = filt_PP_model2_NVT/sum(filt_PP_model_val2), model_name_2 = "ggCaller", model2 = filt_ggCPP_model2_NVT/sum(filt_ggCPP_model_val2))
lollipop_cluster_freqs_3points(year = "2007",plot_title = "Non-Vaccine Types, PopPUNK  Clusters",data1 = filt_PP_mass_cluster_freq_2[which(filt_PP_mass_VT==0)]/sum(filt_PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = filt_PP_model3_NVT/sum(filt_PP_model_val3), model_name_2 = "ggCaller", model2 = filt_ggCPP_model3_NVT/sum(filt_ggCPP_model_val3))
```

```{r}
# Plot VTs
lollipop_cluster_freqs_3points(year = "2001", plot_title = "Vaccine Types, PopPUNK Clusters",data1 = filt_PP_mass_cluster_freq_1[which(filt_PP_mass_VT==1)]/sum(filt_PP_mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = filt_PP_model1_VT/sum(filt_PP_model_val1), model_name_2 = "ggCaller", model2 = filt_ggCPP_model1_VT/sum(filt_ggCPP_model_val1))
lollipop_cluster_freqs_3points(year = "2004",plot_title = "Vaccine Types, PopPUNK Clusters",data1 = filt_PP_mass_cluster_freq_2[which(filt_PP_mass_VT==1)]/sum(filt_PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = filt_PP_model2_VT/sum(filt_PP_model_val2), model_name_2 = "ggCaller", model2 = filt_ggCPP_model2_VT/sum(filt_ggCPP_model_val2))
lollipop_cluster_freqs_3points(year = "2007",plot_title = "Vaccine Types, PopPUNK Clusters",data1 = filt_PP_mass_cluster_freq_2[which(filt_PP_mass_VT==1)]/sum(filt_PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = filt_PP_model3_VT/sum(filt_PP_model_val3), model_name_2 = "ggCaller", model2 = filt_ggCPP_model3_VT/sum(filt_ggCPP_model_val3))
```


## data exploration: how much do the vt-frequencies within clusters change?
```{r}
PP_mass_clusters <- length(unique(PopPUNK_clusters$Cluster))
meanPP_VT_2001 <- rep(0, PP_mass_clusters)
meanPP_VT_2004 <- rep(0, PP_mass_clusters)
meanPP_VT_2007 <- rep(0, PP_mass_clusters)
for (i in 1:PP_mass_clusters){
     meanPP_VT_2001[i] <- mean(as.integer(PopPUNK_clusters[PopPUNK_clusters$SeqYear == 2001 & PopPUNK_clusters$Cluster == i,"VT"]=="VT"))
}
for (i in 1:PP_mass_clusters){
     meanPP_VT_2004[i] <- mean(as.integer(PopPUNK_clusters[PopPUNK_clusters$SeqYear == 2004 & PopPUNK_clusters$Cluster == i,"VT"]=="VT"))
}
for (i in 1:PP_mass_clusters){
     meanPP_VT_2007[i] <- mean(as.integer(PopPUNK_clusters[PopPUNK_clusters$SeqYear == 2007 & PopPUNK_clusters$Cluster == i,"VT"]=="VT"))
}
plot(meanPP_VT_2001)
points(meanPP_VT_2004, col = "#E69F00")
points(meanPP_VT_2007, col = "#56B4E9")
```

```{r}
# checking the ones that are somewhere btw 0 and 1 in 2001:
meanPP_VT_2001
meanPP_VT_2001[2]
meanPP_VT_2004[2]
meanPP_VT_2007[2]
meanPP_VT_2001[22]
meanPP_VT_2004[22]
meanPP_VT_2007[22]

# so, at least for the PopPUNK clusters there are really only two sequence clusters that start at intermediate VT-frequency. 
# it might be interesting to see whether the fit improves if I am trying to pay respect to these two clusters, but I am not expecting to get a fit that is that much better
```

### Investigate serotype vs. sequence clusters

# check serotypes and manual sequence clusters - how much overlap is there between them?
```{r}
length(unique(Mass_Samples_accCodes$Serotype)) # 32
length(unique(Mass_Samples_accCodes$SequenceCluster)) # 41
serotype_diversity <- rep(0, mass_clusters)
for (i in 1:mass_clusters) {
  serotype_diversity[i] <- length(unique(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster==i-1,]$Serotype))
}
# serotype_diversity
# [1] 8 3 1 2 1 4 3 1 4 4 1 1 1 3 1 2 1 2 3 1 1 2 1 2 1 2 2 1 1 1 2 1 1 1 2 1 1 1 1 3 1
# so, the clusters consist of 1 - 8 different serotypes
cluster_diversity <- rep(0, length(unique(Mass_Samples_accCodes$Serotype)))
for (i in 1:length(unique(Mass_Samples_accCodes$Serotype))) {
  cluster_diversity[i] <- length(unique(Mass_Samples_accCodes[Mass_Samples_accCodes$Serotype==unique(Mass_Samples_accCodes$Serotype)[i],]$SequenceCluster))
}
# cluster_diversity
# [1] 3 2 2 2 5 3 2 8 1 1 1 1 4 2 2 2 1 2 4 3 6 4 4 1 1 1 1 2 1 1 2 1
# the serotypes consist of 1-8 sequence clusters
```

```{r}
# first impression is that serotype and cluster definitions are quite different
# install.packages("Polychrome")
library(Polychrome)
# build-in color palette
Glasbey = glasbey.colors(32)
#swatch(Glasbey)
names(Glasbey) <- unique(Mass_Samples_accCodes$Serotype)


ggplot(Mass_Samples_accCodes, aes(fill=Serotype, y=1, x=SequenceCluster)) + 
  geom_bar(position='stack', stat='identity')


ggplot(Mass_Samples_accCodes, aes(fill=SequenceCluster, y=1, x=Serotype)) + 
  geom_bar(position='stack', stat='identity')
```

# now use the serotypes instead of clusters
# import data sets from data processing:
```{r}
#Mass_Samples_accCodes <- readRDS(file = "Mass_Samples_accCodes.rds")
Sero_intermed_gene_presence_absence_consensus <- readRDS(file = "Sero_intermed_gene_presence_absence_consensus.rds")
Sero_intermed_gene_presence_absence_consensus_matrix <- sapply(Sero_intermed_gene_presence_absence_consensus[-1,-1],as.double)
Sero_model_start_pop <- readRDS(file = "Sero_model_start_pop.rds")
#delta_ranking <- readRDS(file = "delta_ranking.rds")
Sero_freq_1 <- readRDS(file = "Sero_freq_1.rds")
Sero_freq_2<- readRDS(file = "Sero_freq_2.rds")
Sero_freq_3 <- readRDS(file = "Sero_freq_3.rds")
Sero_mass_VT <- readRDS(file = "Sero_mass_VT.rds")
```

#define parameters for the model:
```{r}
mass_serotypes <- length(unique(Mass_Samples_accCodes$Serotype))
avg_sero_freq <- rep(1/mass_serotypes, mass_serotypes)

params_n_vP <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(Sero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = Sero_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = delta_ranking, m = 0.0052207254, migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = 0.1321567425, vacc_time = 0)
```

```{r}
sero_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(Sero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = Sero_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = delta_ranking, m = params[4], migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],Sero_freq_2) + combined_compare(x[,1,73],Sero_freq_3) 
}

```

```{r}
sero_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), sero_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.38251173 0.00518133 0.31922936 0.03974063 0.23900668

#$value
#[1] -205.9478
```

```{r}

sero_fit_params <- sero_optim_fit$par
all_params <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(Sero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = Sero_intermed_gene_presence_absence_consensus_matrix, sigma_f = sero_fit_params[1], sigma_w = sero_fit_params[2], prop_f = sero_fit_params[3], delta = delta_ranking, m = sero_fit_params[4], migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = sero_fit_params[5], vacc_time = 0)
WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
sero_model_val1 <- x[,1,1]
sero_model_val2 <- x[,1,37]
sero_model_val3 <- x[,1,73]

sero_model1_VT <- sero_model_val1[which(Sero_mass_VT==1)]
sero_model1_NVT <- sero_model_val1[which(Sero_mass_VT==0)]
sero_model2_VT <- sero_model_val2[which(Sero_mass_VT==1)]
sero_model2_NVT <- sero_model_val2[which(Sero_mass_VT==0)]
sero_model3_VT <- sero_model_val3[which(Sero_mass_VT==1)]
sero_model3_NVT <- sero_model_val3[which(Sero_mass_VT==0)]
```

### ggCaller and serotypes:

```{r}
#Mass_Samples_accCodes <- readRDS(file = "Mass_Samples_accCodes.rds")
ggCsero_intermed_gene_presence_absence_consensus <- readRDS(file = "ggCsero_intermed_gene_presence_absence_consensus.rds")
ggCsero_intermed_gene_presence_absence_consensus_matrix <- sapply(ggCsero_intermed_gene_presence_absence_consensus[-1,-1],as.double)
Sero_model_start_pop <- readRDS(file = "Sero_model_start_pop.rds")
#delta_ranking <- readRDS(file = "delta_ranking.rds")
#Sero_freq_1 <- readRDS(file = "Sero_freq_1.rds")
#Sero_freq_2<- readRDS(file = "Sero_freq_2.rds")
#Sero_freq_3 <- readRDS(file = "Sero_freq_3.rds")
#Sero_mass_VT <- readRDS(file = "Sero_mass_VT.rds")
```

# import data sets from data processing:
```{r}
ggC_delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
```

#define parameters for the model:
```{r}
ggCsero_params_n_vP <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(ggCsero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = ggCsero_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = ggC_delta_ranking, m = 0.0052207254, migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = 0.1321567425, vacc_time = 0)
```


```{r}
ggCsero_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(ggCsero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = ggCsero_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = ggC_delta_ranking, m = params[4], migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],Sero_freq_2) + combined_compare(x[,1,73],Sero_freq_3) 
  #sum((x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))^2) + sum((x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3)))^2)
  #sum(abs(x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))) + sum(abs(x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3))))
}

```

```{r}
ggCsero_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), ggCsero_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.413061811 0.006497421 0.099712391 0.062105898 0.323338547


#$value
#[1] -209.249

#better value than COGtriangles + manual seq clusters and COGtriangles + PopPUNK clusters!
```

#ggCsero plot data

```{r}
ggCsero_fit_params <- ggCsero_optim_fit$par
all_params <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(ggCsero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = ggCsero_intermed_gene_presence_absence_consensus_matrix, sigma_f = ggCsero_fit_params[1], sigma_w = ggCsero_fit_params[2], prop_f = ggCsero_fit_params[3], delta = ggC_delta_ranking, m = ggCsero_fit_params[4], migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = ggCsero_fit_params[5], vacc_time = 0)
ggC_WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(ggC_WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- ggC_WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
ggCsero_model_val1 <- x[,1,1]
ggCsero_model_val2 <- x[,1,37]
ggCsero_model_val3 <- x[,1,73]

ggCsero_model1_VT <- ggCsero_model_val1[which(Sero_mass_VT==1)]
ggCsero_model1_NVT <- ggCsero_model_val1[which(Sero_mass_VT==0)]
ggCsero_model2_VT <- ggCsero_model_val2[which(Sero_mass_VT==1)]
ggCsero_model2_NVT <- ggCsero_model_val2[which(Sero_mass_VT==0)]
ggCsero_model3_VT <- ggCsero_model_val3[which(Sero_mass_VT==1)]
ggCsero_model3_NVT <- ggCsero_model_val3[which(Sero_mass_VT==0)]
```

# Create new Lollipop plots that split the COGtriangles and ggCaller into two rows
```{r}
# Plot NVTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Non-Vaccine Types, Serotypes",data1 = Sero_freq_1[which(Sero_mass_VT==0)]/sum(Sero_freq_1), model_name_1 = "COGtriangles",model1 = sero_model1_NVT/sum(sero_model_val1), model_name_2 = "ggCaller", model2 = ggCsero_model1_NVT/sum(ggCsero_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Non-Vaccine Types, Serotypes",data1 = Sero_freq_2[which(Sero_mass_VT==0)]/sum(Sero_freq_2), model_name_1 = "COGtriangles", model1 = sero_model2_NVT/sum(sero_model_val2), model_name_2 = "ggCaller", model2 = ggCsero_model2_NVT/sum(ggCsero_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Non-Vaccine Types, Serotypes",data1 = Sero_freq_3[which(Sero_mass_VT==0)]/sum(Sero_freq_3), model_name_1 = "COGtriangles", model1 = sero_model3_NVT/sum(sero_model_val3), model_name_2 = "ggCaller", model2 = ggCsero_model3_NVT/sum(ggCsero_model_val3))
```


```{r}
# Plot VTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Vaccine Types, Serotypes",data1 = Sero_freq_1[which(Sero_mass_VT==1)]/sum(Sero_freq_1), model_name_1 = "COGtriangles",model1 = sero_model1_VT/sum(sero_model_val1), model_name_2 = "ggCaller", model2 = ggCsero_model1_VT/sum(ggCsero_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Vaccine Types, Serotypes",data1 = Sero_freq_2[which(Sero_mass_VT==1)]/sum(Sero_freq_2), model_name_1 = "COGtriangles", model1 = sero_model2_VT/sum(sero_model_val2), model_name_2 = "ggCaller", model2 = ggCsero_model2_VT/sum(ggCsero_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Vaccine Types, Serotypes",data1 = Sero_freq_3[which(Sero_mass_VT==1)]/sum(Sero_freq_3), model_name_1 = "COGtriangles", model1 = sero_model3_VT/sum(sero_model_val3), model_name_2 = "ggCaller", model2 = ggCsero_model3_VT/sum(ggCsero_model_val3))
```

### create model version with 616 compartments (one per individual sequence)
```{r}
mass_seq_freq_1 <- readRDS("mass_seq_freq_1.rds")
mass_seq_freq_2 <- readRDS("mass_seq_freq_2.rds")
mass_seq_freq_3 <- readRDS("mass_seq_freq_3.rds")
seq_model_start_pop <- readRDS("seq_model_start_pop.rds")
seq_model_start_pop_2 <- readRDS("seq_model_start_pop_2.rds")
mass_seq_VT <- readRDS("mass_seq_VT.rds")
```

# COGtriangles version
```{r}
intermed_gene_presence_absence <- readRDS("intermed_gene_presence_absence.rds")
intermed_gene_presence_absence_matrix <- sapply(intermed_gene_presence_absence[-1,-1],as.double)
```

```{r}
mass_seqs <- nrow(Mass_Samples_accCodes)
avg_mass_seqs <- rep(1/mass_seqs, mass_seqs)

seq_params_n_vP <- list(dt = 1/36, species_no = mass_seqs,  gene_no = nrow(intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = intermed_gene_presence_absence_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = delta_ranking, m = 0.0052207254, migVec = avg_mass_seqs, vaccTypes = mass_seq_VT, v = 0.1321567425, vacc_time = 0)

```{r}
seq_WFmodel <- WF_nG_h_vP$new(pars = seq_params_n_vP,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
seq_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_seqs,  gene_no = nrow(intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = intermed_gene_presence_absence_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = delta_ranking, m = params[4], migVec = avg_mass_seqs, vaccTypes = as.double(mass_seq_VT), v = params[5], vacc_time = 0)
  WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))
  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],as.double(mass_seq_freq_2)) + combined_compare(x[,1,73],as.double(mass_seq_freq_3))
}
```

```{r}
seq_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), seq_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.2874219386 0.0006232399 0.0193643503 0.6749873251 0.9720733640

#$value
#[1] -916.9239
```

```{r}
seq_fit_dfoptim_2 <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_seqs,  gene_no = nrow(intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop_2), Pop_eq = as.double(seq_model_start_pop_2), capacity = sum(seq_model_start_pop_2), Genotypes = intermed_gene_presence_absence_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = delta_ranking, m = params[4], migVec = avg_mass_seqs, vaccTypes = as.double(mass_seq_VT), v = params[5], vacc_time = 0)
  WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))
  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],as.double(mass_seq_freq_2)) + combined_compare(x[,1,73],as.double(mass_seq_freq_3))
}
```

```{r}
seq_optim_fit_2 <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), seq_fit_dfoptim_2, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.00447771 0.00124846 0.47304656 0.74062053 0.05294554

#$value
#[1] -928.5971

### does even a little worse
# and the parameter values are completely different
# I think I need to change my objective function - it should still be based on the cluster frequencies - I don't really care about getting the exact sequences correct
```

### NULL MODEL
```{r}
WF_null <- odin.dust::odin_dust("null_NFDS_Model.R")
```

# Fitting the model:

```{r}
fitting_closure <- function(all_other_params, data1, data2){
  null_fit_dfoptim <- function(fit_params){
  params <- c(all_other_params, m = fit_params[1], v = fit_params[2])
  null_WFmodel <- WF_null$new(pars = params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(null_WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- null_WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],data1) + combined_compare(x[,1,73],data2) 
}
}
```

```{r}
null_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters, Pop_ini = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, vacc_time = 0)

fit_null_ggCPP <- fitting_closure(null_ggCPP_params, PP_mass_cluster_freq_2, PP_mass_cluster_freq_3)

null_ggCPP_optim_fit <- nmkb(c(0.03, 0.05), fit_null_ggCPP, lower=c(0,0), upper=c(1,1), control = c(maximize = TRUE))
#$par
#[1] 0.01172671 0.01913524

#$value
#[1] -295.7375

# A little worse than ggCaller + PopPUNK non-null (but actually not so much worse...)
```

```{r}
null_man_params <- list(dt = 1/36, species_no = mass_clusters, Pop_ini = as.double(model_start_pop), capacity = sum(model_start_pop), migVec = avg_cluster_freq, vaccTypes = mass_VT, vacc_time = 0)

fit_null_man <- fitting_closure(null_man_params, mass_cluster_freq_2, mass_cluster_freq_3)

null_man_optim_fit <- nmkb(c(0.03, 0.05), fit_null_man, lower=c(0,0), upper=c(1,1), control = c(maximize = TRUE))
#$par
#[1] 0.008636252 0.024126479

#$value
#[1] -239.5123
```

# try simulated annealing instead of dfoptim
```{r}
# install.packages("optimization")
library(optimization)


null_man_sa <- optim_sa(fun = fit_null_man, start = c(0.008636252, 0.024126479), maximization = TRUE, trace = TRUE,lower=c(0,0), upper=c(1,1), control = c(rf = 2))
#$par
#[1] 0.01 0.04

#$function_value
#[1] -252.2131
```

```{r}
start_m <- rep(0,10)
start_v <- rep(0,10)
end_m <- rep(0,10)
end_v <- rep(0,10)
end_error <- rep(0,10)
for (i in 1:10) {
  start_params <- runif(2)
  null_man_sa <- optim_sa(fun = fit_null_man, start = start_params, maximization = TRUE, trace = FALSE,lower=c(0,0), upper=c(1,1), control = c(rf = 3, r = 0.8))
  end_error[i] <- null_man_sa$function_value
  end_m[i] <- null_man_sa$par[1]
  end_v[i] <- null_man_sa$par[2]
  start_m[i] <- start_params[1]
  start_v[i] <- start_params[2]
}

# best:
# -241.3298
# end params
# 0.006305697 0.01630453
# start params
# 0.98630570 0.8363045314
```

```{r}
NFDS_fitting_closure <- function(all_other_params, data1, data2){
  fit_dfoptim <- function(fit_params){
  params <- c(all_other_params, sigma_f = fit_params[1], sigma_w = fit_params[2], prop_f = fit_params[3], m = fit_params[4], v = fit_params[5])
  WFmodel <- WF_nG_h_vP$new(pars = params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],data1) + combined_compare(x[,1,73],data2) 
}
}
```

```{r}
ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, delta = ggC_delta_ranking, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, vacc_time = 0)

ggCPP_fitting <- NFDS_fitting_closure(ggCPP_params, PP_mass_cluster_freq_2, PP_mass_cluster_freq_3)

start_params <- c(0.15, 0.05, 0.25, 0.03, 0.05)

null_man_sa <- optim_sa(fun = ggCPP_fitting, start = start_params, maximization = TRUE, trace = TRUE,lower=c(0.05,0,0,0,0), upper=c(1,0.05,1,1,1), control = c(rf = 3, r = 0.8))

# took really long (10 mins?)
# and produced weird results:
# $par
#[1] 0.68 0.01 0.10 0.04 0.16

#$function_value
#[1] -274.9081

# 42 iterations (not so much for so much time?)
# maybe issue with sigma_w and sigma_f? maybe I should force the smaller one to be small

#$par
#[1] 0.12 0.00 0.49 0.04 0.25

#$function_value
#[1] -246.5182
```


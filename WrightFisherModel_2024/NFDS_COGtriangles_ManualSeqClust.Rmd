---
title: "NFDS model with COGtriangles and manual sequence clusters"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r}
# install.packages("drat") # -- if you don't have drat installed
# drat:::add("ncov-ic")
# install.packages("odin.dust")
library(odin.dust)
#install.packages("mcstate")
library(mcstate)
# Package for derivative-free fitting in R:
library(dfoptim)
```

# import data sets from data processing:
```{r}
Mass_Samples_accCodes <- readRDS(file = "Mass_Samples_accCodes.rds")
intermed_gene_presence_absence_consensus <- readRDS(file = "intermed_gene_presence_absence_consensus.rds")
intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
model_start_pop <- readRDS(file = "model_start_pop.rds")
delta_ranking <- readRDS(file = "delta_ranking.rds")
inv_delta_ranking <- readRDS(file = "inv_delta_ranking.rds")
mass_cluster_freq_1 <- readRDS(file = "mass_cluster_freq_1.rds")
mass_cluster_freq_2 <- readRDS(file = "mass_cluster_freq_2.rds")
mass_cluster_freq_3 <- readRDS(file = "mass_cluster_freq_3.rds")
mass_VT <- readRDS(file = "mass_VT.rds")
```


```{r}
WF_nG_h_vP <- odin.dust::odin_dust("NFDS_Model.R")
# copy of WrightFisherModel/WrightFisher_newData_nGenotypes_haploid_PopsizeVariablePois.R
```

#define parameters for the model:
```{r}
mass_clusters <- length(unique(Mass_Samples_accCodes$SequenceCluster))
avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)

params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = delta_ranking, m = 0.0052207254, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1321567425, vacc_time = 0)

params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.1789665082, sigma_w = 0.0006039627, prop_f = 0.3669067334 , delta = delta_ranking, m = 0.0078524723 , migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1103623064, vacc_time = 0)
```

### Running the model:
```{r}
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = params_n_vP,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
# try using dfoptim with likelihood
ll_pois <- function(obs, model) {
  exp_noise <- 1e6

  if (is.na(obs)) {
    # Creates vector of zeros in ll with same length, if no data
    ll_obs <- numeric(length(model))
  } else {
    lambda <- model + rexp(n = length(model), rate = exp_noise)
    ll_obs <- dpois(x = obs, lambda = lambda, log = TRUE)
  }
  ll_obs
}

combined_compare <- function(state, observed, pars = NULL) {
  result <- 0
  #data_size <- sum(mass_cluster_freq_1)
  #model_size = 15000
  data_size <- sum(observed)
  model_size = sum(state)
  
  for (i in 1:length(observed)){
    result <- result + ll_pois(observed[i], state[i]/model_size * data_size)
  }
  result
}

fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = delta_ranking, m = params[4], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],mass_cluster_freq_2) + combined_compare(x[,1,73],mass_cluster_freq_3)
}

```

```{r}
optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.326448072 0.001129911 0.384818488 0.011920907 0.187427953

#$value
#[1] -193.3568
```


```{r}
end_params <- rep(0,5)
end_error <- 3
for (i in 1:10) {
  start_params <- runif(5)
  optim_fit <- nmkb(start_params, fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
  if(optim_fit$value < end_error){
    end_error <- optim_fit$value
    end_params <- optim_fit$par
  }
}

#> end_error
#[1] -367.9466
#> end_params
#[1] 0.8745946 0.9441601 0.3326991 0.8484669 0.6790299

# these are not great values --> maybe this fitting does not work as well as hoped and gets stuck in local optimum
```

### prev version COGtriangles gene clusters for comparison
# these are the pre-processed data files that I was using last summer

# import data sets from data processing:
```{r}
prev_intermed_gene_presence_absence_consensus <- readRDS(file = "prev_mass_consensus_presence_absence.rds")
prev_intermed_gene_presence_absence_consensus_matrix <- sapply(prev_intermed_gene_presence_absence_consensus[,-1],as.double)
prev_delta_ranking <- readRDS(file = "prev_delta_ranking.rds")
```

#define parameters for the model:
```{r}
prev_params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(prev_intermed_gene_presence_absence_consensus), Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = prev_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = prev_delta_ranking, m = 0.0052207254, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1321567425, vacc_time = 0)
```

### Running the model:
```{r}
prev_WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = prev_params_n_vP,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
prev_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(prev_intermed_gene_presence_absence_consensus), Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = prev_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = prev_delta_ranking, m = params[4], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],mass_cluster_freq_2) + combined_compare(x[,1,73],mass_cluster_freq_3)
}
```

```{r}
prev_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), prev_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.091127278 0.001265479 0.133685351 0.008260285 0.035640495

#$value
#[1] -205.9497
```


### PopPUNK

# import PopPUNK data sets

```{r}
PopPUNK_clusters <- readRDS("PopPUNK_clusters.rds")
PP_intermed_gene_presence_absence_consensus <- readRDS(file = "PP_intermed_gene_presence_absence_consensus.rds")
PP_intermed_gene_presence_absence_consensus_matrix <- sapply(PP_intermed_gene_presence_absence_consensus[-1,-1],as.double)
PP_model_start_pop <- readRDS(file = "PP_model_start_pop.rds")
#delta_ranking <- readRDS(file = "delta_ranking.rds")
PP_mass_cluster_freq_1 <- readRDS(file = "PP_mass_cluster_freq_1.rds")
PP_mass_cluster_freq_2 <- readRDS(file = "PP_mass_cluster_freq_2.rds")
PP_mass_cluster_freq_3 <- readRDS(file = "PP_mass_cluster_freq_3.rds")
PP_mass_VT <- readRDS(file = "PP_mass_VT.rds")
```

```{r}
PP_mass_clusters <- length(unique(PopPUNK_clusters$Cluster))
PP_avg_cluster_freq <- rep(1/PP_mass_clusters, PP_mass_clusters)
```

```{r}
WF_PP <- odin.dust::odin_dust("NFDS_Model.R")
```

```{r}
PP_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = delta_ranking, m = params[4], migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_PP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3)
}
```

```{r}
PP_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), PP_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.30823650 0.04393502 0.33582177 0.12021641 0.35791045


#$value
#[1] -294.1526
```


### ggCaller with manual Sequence Clusters
# import data sets from data processing:
```{r}
Mass_Samples_accCodes <- readRDS(file = "Mass_Samples_accCodes.rds")
ggC_intermed_gene_presence_absence_consensus <- readRDS(file = "ggC_intermed_gene_presence_absence_consensus.rds")
ggC_intermed_gene_presence_absence_consensus_matrix <- sapply(ggC_intermed_gene_presence_absence_consensus[-1,-1],as.double)
model_start_pop <- readRDS(file = "model_start_pop.rds")
ggC_delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
ggC_inv_delta_ranking <- readRDS(file = "ggC_inv_delta_ranking.rds")
mass_cluster_freq_1 <- readRDS(file = "mass_cluster_freq_1.rds")
mass_cluster_freq_2 <- readRDS(file = "mass_cluster_freq_2.rds")
mass_cluster_freq_3 <- readRDS(file = "mass_cluster_freq_3.rds")
mass_VT <- readRDS(file = "mass_VT.rds")
```

```{r}
WF_ggC <- odin.dust::odin_dust("NFDS_Model.R")
# copy of WrightFisherModel/WrightFisher_newData_nGenotypes_haploid_PopsizeVariablePois.R
```

#define parameters for the model:
```{r}
mass_clusters <- length(unique(Mass_Samples_accCodes$SequenceCluster))
avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)

params_ggC <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(ggC_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = ggC_delta_ranking, m = 0.0052207254, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1321567425, vacc_time = 0)
```

### Running the model:
```{r}
ggC_WFmodel <- WF_ggC$new(pars = params_ggC,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
ggC_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(ggC_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = ggC_delta_ranking, m = params[4], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_ggC$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],mass_cluster_freq_2) + combined_compare(x[,1,73],mass_cluster_freq_3)
}

```

```{r}
ggC_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), ggC_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.21366993 0.00176741 0.19665062 0.00977433 0.14496577

#$value
#[1] -184.6705

#better value than COGtriangles + manual seq clusters and COGtriangles + PopPUNK clusters!
```

### ggCaller + PopPUNK

```{r}
PopPUNK_clusters <- readRDS("PopPUNK_clusters.rds")
ggCPP_intermed_gene_presence_absence_consensus <- readRDS(file = "ggCPP_intermed_gene_presence_absence_consensus.rds")
ggCPP_intermed_gene_presence_absence_consensus_matrix <- sapply(ggCPP_intermed_gene_presence_absence_consensus[-1,-1],as.double)
PP_model_start_pop <- readRDS(file = "PP_model_start_pop.rds")
ggC_delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
PP_mass_cluster_freq_1 <- readRDS(file = "PP_mass_cluster_freq_1.rds")
PP_mass_cluster_freq_2 <- readRDS(file = "PP_mass_cluster_freq_2.rds")
PP_mass_cluster_freq_3 <- readRDS(file = "PP_mass_cluster_freq_3.rds")
PP_mass_VT <- readRDS(file = "PP_mass_VT.rds")
```

```{r}
PP_mass_clusters <- length(unique(PopPUNK_clusters$Cluster))
PP_avg_cluster_freq <- rep(1/PP_mass_clusters, PP_mass_clusters)
```

# Fitting the model:

```{r}
ggCPP_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = ggC_delta_ranking, m = params[4], migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_ggC$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3) 
}
```

```{r}
ggCPP_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), ggCPP_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.138193890 0.008439717 0.199494193 0.024378998 0.155166177

#$value
#[1] -263.3126

# A little worse than ggCaller + manual seq clusters
# but might not be comparable
```

### Visualise Fits:

```{r}
source("CreateLollipopPlot.R")
```

```{r}

#fit_params <- c(2.400584e-01, 9.981659e-05, 2.948024e-01, 7.317635e-03, 9.683020e-02)
#better_fit_params <- c(2.400549e-01, 9.981205e-05, 2.948120e-01, 7.317485e-03, 9.683313e-02)
fit_params <- optim_fit$par
all_params <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = fit_params[1], sigma_w = fit_params[2], prop_f = fit_params[3], delta = delta_ranking, m = fit_params[4], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = fit_params[5], vacc_time = 0)
WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
model_val1 <- x[,1,1]
model_val2 <- x[,1,37]
model_val3 <- x[,1,73]

model1_VT <- model_val1[which(mass_VT==1)]
model1_NVT <- model_val1[which(mass_VT==0)]
model2_VT <- model_val2[which(mass_VT==1)]
model2_NVT <- model_val2[which(mass_VT==0)]
model3_VT <- model_val3[which(mass_VT==1)]
model3_NVT <- model_val3[which(mass_VT==0)]


### COGtriangles and manual sequence clusters
lollipop_cluster_freqs(plot_title = "Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_1[which(mass_VT==1)]/sum(mass_cluster_freq_1), data2 = mass_cluster_freq_2[which(mass_VT==1)]/sum(mass_cluster_freq_2), data3= mass_cluster_freq_3[which(mass_VT==1)]/sum(mass_cluster_freq_3), model1 = model1_VT/sum(model_val1), model2 = model2_VT/sum(model_val2), model3 = model3_VT/sum(model_val3))
lollipop_cluster_freqs(plot_title = "Non-Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_1[which(mass_VT==0)]/sum(mass_cluster_freq_1), data2 = mass_cluster_freq_2[which(mass_VT==0)]/sum(mass_cluster_freq_2), data3= mass_cluster_freq_3[which(mass_VT==0)]/sum(mass_cluster_freq_3), model1 = model1_NVT/sum(model_val1), model2 = model2_NVT/sum(model_val2), model3 = model3_NVT/sum(model_val3))
```

```{r}
### COGtriangles and PopPUNK clusters
PP_fit_params <- PP_optim_fit$par
all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = PP_fit_params[1], sigma_w = PP_fit_params[2], prop_f = PP_fit_params[3], delta = delta_ranking, m = PP_fit_params[4], migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = PP_fit_params[5], vacc_time = 0)
WFmodel_PP <- WF_PP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(WFmodel_PP$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel_PP$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
PP_model_val1 <- x[,1,1]
PP_model_val2 <- x[,1,37]
PP_model_val3 <- x[,1,73]

PP_model1_VT <- PP_model_val1[which(PP_mass_VT==1)]
PP_model1_NVT <- PP_model_val1[which(PP_mass_VT==0)]
PP_model2_VT <- PP_model_val2[which(PP_mass_VT==1)]
PP_model2_NVT <- PP_model_val2[which(PP_mass_VT==0)]
PP_model3_VT <- PP_model_val3[which(PP_mass_VT==1)]
PP_model3_NVT <- PP_model_val3[which(PP_mass_VT==0)]

### COGtriangles and manual sequence clusters
lollipop_cluster_freqs(plot_title = "Vaccine Types, PopPUNK Clusters", data1 = PP_mass_cluster_freq_1[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_1), data2 = PP_mass_cluster_freq_2[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_2), data3= PP_mass_cluster_freq_3[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_3), model1 = PP_model1_VT/sum(PP_model_val1), model2 = PP_model2_VT/sum(PP_model_val2), model3 = PP_model3_VT/sum(PP_model_val3))
lollipop_cluster_freqs(plot_title = "Non-Vaccine Types, PopPUNK Clusters",data1 = PP_mass_cluster_freq_1[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_1), data2 = PP_mass_cluster_freq_2[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_2), data3= PP_mass_cluster_freq_3[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_3), model1 = PP_model1_NVT/sum(PP_model_val1), model2 = PP_model2_NVT/sum(PP_model_val2), model3 = PP_model3_NVT/sum(PP_model_val3))
```

#ggC plot data

```{r}

ggC_fit_params <- ggC_optim_fit$par
all_params <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(ggC_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_consensus_matrix, sigma_f = ggC_fit_params[1], sigma_w = ggC_fit_params[2], prop_f = ggC_fit_params[3], delta = ggC_delta_ranking, m = ggC_fit_params[4], migVec = avg_cluster_freq, vaccTypes = mass_VT, v = ggC_fit_params[5], vacc_time = 0)
ggC_WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(ggC_WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- ggC_WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
ggC_model_val1 <- x[,1,1]
ggC_model_val2 <- x[,1,37]
ggC_model_val3 <- x[,1,73]

ggC_model1_VT <- ggC_model_val1[which(mass_VT==1)]
ggC_model1_NVT <- ggC_model_val1[which(mass_VT==0)]
ggC_model2_VT <- ggC_model_val2[which(mass_VT==1)]
ggC_model2_NVT <- ggC_model_val2[which(mass_VT==0)]
ggC_model3_VT <- ggC_model_val3[which(mass_VT==1)]
ggC_model3_NVT <- ggC_model_val3[which(mass_VT==0)]

```

#ggCPP plot data

```{r}

ggCPP_fit_params <- ggCPP_optim_fit$par
ggCPP_fit_params <- c(0.138193890,0.008439717, 0.199494193, 0.024378998, 0.155166177)


all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = ggCPP_fit_params[1], sigma_w = ggCPP_fit_params[2], prop_f = ggCPP_fit_params[3], delta = ggC_delta_ranking, m = ggCPP_fit_params[4], migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = ggCPP_fit_params[5], vacc_time = 0)
ggCPP_WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(ggCPP_WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- ggCPP_WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
ggCPP_model_val1 <- x[,1,1]
ggCPP_model_val2 <- x[,1,37]
ggCPP_model_val3 <- x[,1,73]

ggCPP_model1_VT <- ggCPP_model_val1[which(PP_mass_VT==1)]
ggCPP_model1_NVT <- ggCPP_model_val1[which(PP_mass_VT==0)]
ggCPP_model2_VT <- ggCPP_model_val2[which(PP_mass_VT==1)]
ggCPP_model2_NVT <- ggCPP_model_val2[which(PP_mass_VT==0)]
ggCPP_model3_VT <- ggCPP_model_val3[which(PP_mass_VT==1)]
ggCPP_model3_NVT <- ggCPP_model_val3[which(PP_mass_VT==0)]

```

```{r}
# Plot NVTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Non-Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_1[which(mass_VT==0)]/sum(mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = model1_NVT/sum(model_val1), model_name_2 = "ggCaller", model2 = ggC_model1_NVT/sum(ggC_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Non-Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_2[which(mass_VT==0)]/sum(mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = model2_NVT/sum(model_val2), model_name_2 = "ggCaller", model2 = ggC_model2_NVT/sum(ggC_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Non-Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_3[which(mass_VT==0)]/sum(mass_cluster_freq_3), model_name_1 = "COGtriangles", model1 = model3_NVT/sum(model_val3), model_name_2 = "ggCaller", model2 = ggC_model3_NVT/sum(ggC_model_val3))
```

```{r}
# Plot VTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_1[which(mass_VT==1)]/sum(mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = model1_VT/sum(model_val1), model_name_2 = "ggCaller", model2 = ggC_model1_VT/sum(ggC_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_2[which(mass_VT==1)]/sum(mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = model2_VT/sum(model_val2), model_name_2 = "ggCaller", model2 = ggC_model2_VT/sum(ggC_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Vaccine Types, manual Seq Clusters",data1 = mass_cluster_freq_3[which(mass_VT==1)]/sum(mass_cluster_freq_3), model_name_1 = "COGtriangles", model1 = model3_VT/sum(model_val3), model_name_2 = "ggCaller", model2 = ggC_model3_VT/sum(ggC_model_val3))
```

### PopPUNK clusters:
```{r}
# Plot NVTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Non-Vaccine Types, PopPUNK Clusters",data1 = PP_mass_cluster_freq_1[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = PP_model1_NVT/sum(PP_model_val1), model_name_2 = "ggCaller", model2 = ggCPP_model1_NVT/sum(ggCPP_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Non-Vaccine Types, PopPUNK  Clusters",data1 = PP_mass_cluster_freq_2[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = PP_model2_NVT/sum(PP_model_val2), model_name_2 = "ggCaller", model2 = ggCPP_model2_NVT/sum(ggCPP_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Non-Vaccine Types, PopPUNK  Clusters",data1 = PP_mass_cluster_freq_2[which(PP_mass_VT==0)]/sum(PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = PP_model3_NVT/sum(PP_model_val3), model_name_2 = "ggCaller", model2 = ggCPP_model3_NVT/sum(ggCPP_model_val3))
```

```{r}
# Plot VTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Vaccine Types, PopPUNK Clusters",data1 = PP_mass_cluster_freq_1[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = PP_model1_VT/sum(PP_model_val1), model_name_2 = "ggCaller", model2 = ggCPP_model1_VT/sum(ggCPP_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Vaccine Types, PopPUNK Clusters",data1 = PP_mass_cluster_freq_2[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = PP_model2_VT/sum(PP_model_val2), model_name_2 = "ggCaller", model2 = ggCPP_model2_VT/sum(ggCPP_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Vaccine Types, PopPUNK Clusters",data1 = PP_mass_cluster_freq_2[which(PP_mass_VT==1)]/sum(PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = PP_model3_VT/sum(PP_model_val3), model_name_2 = "ggCaller", model2 = ggCPP_model3_VT/sum(ggCPP_model_val3))
```

### Plot VTs and NVT together in one plot
```{r}
#ggCPP_model_val1
lollipop_cluster_freqs_VTandNVT(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = ggCPP_model_val1/sum(ggCPP_model_val1), PP_mass_VT)
lollipop_cluster_freqs_VTandNVT(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = ggCPP_model_val2/sum(ggCPP_model_val2), PP_mass_VT)
lollipop_cluster_freqs_VTandNVT(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = ggCPP_model_val3/sum(ggCPP_model_val3), PP_mass_VT)
```



### THOUGHTS ABOUT THE COMPARABILITY OF LIKELIHOODS
# Question: Does the likelihood decrease with the number of clusters?
# Answer: 

# these two are not the same
# dpois(x = 10, lambda = 11) + dpois(x = 10, lambda = 9)
#dpois(x = 10, lambda = 11, log = TRUE) + dpois(x = 5, lambda = 4, log = TRUE) + dpois(x = 4, lambda = 4, log = TRUE)
# these two are:
# sum(abs(10-11)+sum(9-10))
# sum(abs(10-11)+sum(abs(5-4))+sum(abs(4-4)))


# sum(abs(model_val2/sum(model_val2) - mass_cluster_freq_2/sum(mass_cluster_freq_2))) + sum(abs(model_val3/sum(model_val3) - mass_cluster_freq_3/sum(mass_cluster_freq_3)))
#[1] 0.9182114
#sum(abs(PP_model_val2/sum(PP_model_val2) - PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2))) + sum(abs(PP_model_val3/sum(PP_model_val3) - PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3)))
# [1] 0.9997534
#sum(abs(ggCPP_model_val2/sum(ggCPP_model_val2) - PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2))) + sum(abs(ggCPP_model_val3/sum(ggCPP_model_val3) - PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3)))
# [1] 0.846745
# sum(abs(ggC_model_val2/sum(ggC_model_val2) - mass_cluster_freq_2/sum(mass_cluster_freq_2))) + sum(abs(ggC_model_val3/sum(ggC_model_val3) - mass_cluster_freq_3/sum(mass_cluster_freq_3)))
# [1] 0.7446736


### filter PopPUNK clusters for max(size(cluster))>1
```{r}
filt_PP_mass_cluster_freq_1 <- readRDS(file = "filt_PP_mass_cluster_freq_1.rds")
filt_PP_mass_cluster_freq_2 <- readRDS(file = "filt_PP_mass_cluster_freq_2.rds")
filt_PP_mass_cluster_freq_3 <- readRDS(file = "filt_PP_mass_cluster_freq_3.rds")
filt_PP_intermed_gene_presence_absence_consensus <- readRDS(file = "filt_PP_intermed_gene_presence_absence_consensus.rds")
filt_PP_intermed_gene_presence_absence_consensus_matrix <-sapply(filt_PP_intermed_gene_presence_absence_consensus[-1,-1],as.double)
filt_PP_mass_VT <- readRDS( file = "filt_PP_mass_VT.rds")
filt_PP_model_start_pop <- readRDS(file = "filt_PP_model_start_pop.rds")
filt_PP_mass_clusters <- length(filt_PP_mass_cluster_freq_1)
filt_PP_avg_cluster_freq <- PP_avg_cluster_freq[apply(matrix(c(PP_mass_cluster_freq_1,PP_mass_cluster_freq_2, PP_mass_cluster_freq_3),nrow=3,ncol=length(PP_mass_cluster_freq_1),byrow = TRUE),2,max)>1]
```

```{r}
filt_PP_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = filt_PP_mass_clusters,  gene_no = nrow(filt_PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(filt_PP_model_start_pop), Pop_eq = as.double(filt_PP_model_start_pop), capacity = sum(filt_PP_model_start_pop), Genotypes = filt_PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = delta_ranking, m = params[4], migVec = filt_PP_avg_cluster_freq, vaccTypes = filt_PP_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_PP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3) 
  #sum((x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))^2) + sum((x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3)))^2)
  #sum(abs(x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))) + sum(abs(x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3))))
}
```

```{r}
filt_PP_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), filt_PP_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.299432553 0.002611058 0.410155291 0.131020909 0.216579505

#$value
#[1] -276.0369

# slight improvement over unfiltered PopPUNK + COGtriangles
```

# ggCaller with filtered PopPUNK
```{r}
filt_ggCPP_intermed_gene_presence_absence_consensus <-readRDS(file = "filt_ggCPP_intermed_gene_presence_absence_consensus.rds")
filt_ggCPP_intermed_gene_presence_absence_consensus_matrix <-sapply(filt_ggCPP_intermed_gene_presence_absence_consensus[-1,-1],as.double)
```

```{r}
filt_ggCPP_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = filt_PP_mass_clusters,  gene_no = nrow(filt_ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(filt_PP_model_start_pop), Pop_eq = as.double(filt_PP_model_start_pop), capacity = sum(filt_PP_model_start_pop), Genotypes = filt_ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = ggC_delta_ranking, m = params[4], migVec = filt_PP_avg_cluster_freq, vaccTypes = filt_PP_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_PP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],PP_mass_cluster_freq_2) + combined_compare(x[,1,73],PP_mass_cluster_freq_3) 
  #sum((x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))^2) + sum((x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3)))^2)
  #sum(abs(x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))) + sum(abs(x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3))))
}
```

```{r}
filt_ggCPP_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), filt_ggCPP_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.052109427 0.001694954 0.497849841 0.069497537 0.148361001

#$value
#[1] -278.0763

# not an improvement compared to unfiltered PopPUNK + ggCaller
```

```{r}
### COGtriangles and PopPUNK clusters
filt_PP_fit_params <- filt_PP_optim_fit$par
all_params <- list(dt = 1/36, species_no = filt_PP_mass_clusters,  gene_no = nrow(filt_PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(filt_PP_model_start_pop), Pop_eq = as.double(filt_PP_model_start_pop), capacity = sum(filt_PP_model_start_pop), Genotypes = filt_PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = filt_PP_fit_params[1], sigma_w = filt_PP_fit_params[2], prop_f = filt_PP_fit_params[3], delta = delta_ranking, m = filt_PP_fit_params[4], migVec = filt_PP_avg_cluster_freq, vaccTypes = filt_PP_mass_VT, v = filt_PP_fit_params[5], vacc_time = 0)
WFmodel_PP <- WF_PP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(WFmodel_PP$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel_PP$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
filt_PP_model_val1 <- x[,1,1]
filt_PP_model_val2 <- x[,1,37]
filt_PP_model_val3 <- x[,1,73]

filt_PP_model1_VT <- filt_PP_model_val1[which(filt_PP_mass_VT==1)]
filt_PP_model1_NVT <- filt_PP_model_val1[which(filt_PP_mass_VT==0)]
filt_PP_model2_VT <- filt_PP_model_val2[which(filt_PP_mass_VT==1)]
filt_PP_model2_NVT <- filt_PP_model_val2[which(filt_PP_mass_VT==0)]
filt_PP_model3_VT <- filt_PP_model_val3[which(filt_PP_mass_VT==1)]
filt_PP_model3_NVT <- filt_PP_model_val3[which(filt_PP_mass_VT==0)]
```

#filtered ggCPP plot data

```{r}

filt_ggCPP_fit_params <- filt_ggCPP_optim_fit$par
all_params <- list(dt = 1/36, species_no = filt_PP_mass_clusters,  gene_no = nrow(filt_ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(filt_PP_model_start_pop), Pop_eq = as.double(filt_PP_model_start_pop), capacity = sum(filt_PP_model_start_pop), Genotypes = filt_ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = filt_ggCPP_fit_params[1], sigma_w = filt_ggCPP_fit_params[2], prop_f = filt_ggCPP_fit_params[3], delta = ggC_delta_ranking, m = filt_ggCPP_fit_params[4], migVec = filt_PP_avg_cluster_freq, vaccTypes = filt_PP_mass_VT, v = filt_ggCPP_fit_params[5], vacc_time = 0)
ggCPP_WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(ggCPP_WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- ggCPP_WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
filt_ggCPP_model_val1 <- x[,1,1]
filt_ggCPP_model_val2 <- x[,1,37]
filt_ggCPP_model_val3 <- x[,1,73]

filt_ggCPP_model1_VT <- filt_ggCPP_model_val1[which(filt_PP_mass_VT==1)]
filt_ggCPP_model1_NVT <- filt_ggCPP_model_val1[which(filt_PP_mass_VT==0)]
filt_ggCPP_model2_VT <- filt_ggCPP_model_val2[which(filt_PP_mass_VT==1)]
filt_ggCPP_model2_NVT <- filt_ggCPP_model_val2[which(filt_PP_mass_VT==0)]
filt_ggCPP_model3_VT <- filt_ggCPP_model_val3[which(filt_PP_mass_VT==1)]
filt_ggCPP_model3_NVT <- filt_ggCPP_model_val3[which(filt_PP_mass_VT==0)]

```

### filtered PopPUNK clusters:
```{r}
# Plot NVTs
lollipop_cluster_freqs_3points(year = "2001", plot_title = "Non-Vaccine Types, PopPUNK Clusters",data1 = filt_PP_mass_cluster_freq_1[which(filt_PP_mass_VT==0)]/sum(filt_PP_mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = filt_PP_model1_NVT/sum(filt_PP_model_val1), model_name_2 = "ggCaller", model2 = filt_ggCPP_model1_NVT/sum(filt_ggCPP_model_val1))
lollipop_cluster_freqs_3points(year = "2004",plot_title = "Non-Vaccine Types, PopPUNK  Clusters",data1 = filt_PP_mass_cluster_freq_2[which(filt_PP_mass_VT==0)]/sum(filt_PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = filt_PP_model2_NVT/sum(filt_PP_model_val2), model_name_2 = "ggCaller", model2 = filt_ggCPP_model2_NVT/sum(filt_ggCPP_model_val2))
lollipop_cluster_freqs_3points(year = "2007",plot_title = "Non-Vaccine Types, PopPUNK  Clusters",data1 = filt_PP_mass_cluster_freq_2[which(filt_PP_mass_VT==0)]/sum(filt_PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = filt_PP_model3_NVT/sum(filt_PP_model_val3), model_name_2 = "ggCaller", model2 = filt_ggCPP_model3_NVT/sum(filt_ggCPP_model_val3))
```

```{r}
# Plot VTs
lollipop_cluster_freqs_3points(year = "2001", plot_title = "Vaccine Types, PopPUNK Clusters",data1 = filt_PP_mass_cluster_freq_1[which(filt_PP_mass_VT==1)]/sum(filt_PP_mass_cluster_freq_1), model_name_1 = "COGtriangles",model1 = filt_PP_model1_VT/sum(filt_PP_model_val1), model_name_2 = "ggCaller", model2 = filt_ggCPP_model1_VT/sum(filt_ggCPP_model_val1))
lollipop_cluster_freqs_3points(year = "2004",plot_title = "Vaccine Types, PopPUNK Clusters",data1 = filt_PP_mass_cluster_freq_2[which(filt_PP_mass_VT==1)]/sum(filt_PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = filt_PP_model2_VT/sum(filt_PP_model_val2), model_name_2 = "ggCaller", model2 = filt_ggCPP_model2_VT/sum(filt_ggCPP_model_val2))
lollipop_cluster_freqs_3points(year = "2007",plot_title = "Vaccine Types, PopPUNK Clusters",data1 = filt_PP_mass_cluster_freq_2[which(filt_PP_mass_VT==1)]/sum(filt_PP_mass_cluster_freq_2), model_name_1 = "COGtriangles", model1 = filt_PP_model3_VT/sum(filt_PP_model_val3), model_name_2 = "ggCaller", model2 = filt_ggCPP_model3_VT/sum(filt_ggCPP_model_val3))
```


## data exploration: how much do the vt-frequencies within clusters change?
```{r}
PP_mass_clusters <- length(unique(PopPUNK_clusters$Cluster))
meanPP_VT_2001 <- rep(0, PP_mass_clusters)
meanPP_VT_2004 <- rep(0, PP_mass_clusters)
meanPP_VT_2007 <- rep(0, PP_mass_clusters)
for (i in 1:PP_mass_clusters){
     meanPP_VT_2001[i] <- mean(as.integer(PopPUNK_clusters[PopPUNK_clusters$SeqYear == 2001 & PopPUNK_clusters$Cluster == i,"VT"]=="VT"))
}
for (i in 1:PP_mass_clusters){
     meanPP_VT_2004[i] <- mean(as.integer(PopPUNK_clusters[PopPUNK_clusters$SeqYear == 2004 & PopPUNK_clusters$Cluster == i,"VT"]=="VT"))
}
for (i in 1:PP_mass_clusters){
     meanPP_VT_2007[i] <- mean(as.integer(PopPUNK_clusters[PopPUNK_clusters$SeqYear == 2007 & PopPUNK_clusters$Cluster == i,"VT"]=="VT"))
}
plot(meanPP_VT_2001)
points(meanPP_VT_2004, col = "#E69F00")
points(meanPP_VT_2007, col = "#56B4E9")
```

```{r}
# checking the ones that are somewhere btw 0 and 1 in 2001:
meanPP_VT_2001
meanPP_VT_2001[2]
meanPP_VT_2004[2]
meanPP_VT_2007[2]
meanPP_VT_2001[22]
meanPP_VT_2004[22]
meanPP_VT_2007[22]

# so, at least for the PopPUNK clusters there are really only two sequence clusters that start at intermediate VT-frequency. 
# it might be interesting to see whether the fit improves if I am trying to pay respect to these two clusters, but I am not expecting to get a fit that is that much better
```

# similarly for the manSeqClusters"
```{r}
meanManSQ_VT_2001 <- rep(0, mass_clusters)
meanManSQ_VT_2004 <- rep(0, mass_clusters)
meanManSQ_VT_2007 <- rep(0, mass_clusters)
for (i in 1:mass_clusters){
     meanManSQ_VT_2001[i] <- mean(as.integer(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster == i-1 & Mass_Samples_accCodes$`Year of Isolation`==2001,"Vaccine Type"]=="VT"))
}
for (i in 1:mass_clusters){
     meanManSQ_VT_2004[i] <- mean(as.integer(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster == i-1 & Mass_Samples_accCodes$`Year of Isolation`==2004,"Vaccine Type"]=="VT"))
}
for (i in 1:mass_clusters){
     meanManSQ_VT_2007[i] <- mean(as.integer(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster == i-1 & Mass_Samples_accCodes$`Year of Isolation`==2007,"Vaccine Type"]=="VT"))
}

# there are 3 clusters that begin with intermediate-VT frequency
meanManSQ_VT_2001[1]
meanManSQ_VT_2004[1]
meanManSQ_VT_2007[1]
meanManSQ_VT_2001[2]
meanManSQ_VT_2004[2]
meanManSQ_VT_2007[2]
meanManSQ_VT_2001[10]
meanManSQ_VT_2004[10]
meanManSQ_VT_2007[10]
```




### Investigate serotype vs. sequence clusters

# check serotypes and manual sequence clusters - how much overlap is there between them?
```{r}
length(unique(Mass_Samples_accCodes$Serotype)) # 32
length(unique(Mass_Samples_accCodes$SequenceCluster)) # 41
serotype_diversity <- rep(0, mass_clusters)
for (i in 1:mass_clusters) {
  serotype_diversity[i] <- length(unique(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster==i-1,]$Serotype))
}
# serotype_diversity
# [1] 8 3 1 2 1 4 3 1 4 4 1 1 1 3 1 2 1 2 3 1 1 2 1 2 1 2 2 1 1 1 2 1 1 1 2 1 1 1 1 3 1
# so, the clusters consist of 1 - 8 different serotypes
cluster_diversity <- rep(0, length(unique(Mass_Samples_accCodes$Serotype)))
for (i in 1:length(unique(Mass_Samples_accCodes$Serotype))) {
  cluster_diversity[i] <- length(unique(Mass_Samples_accCodes[Mass_Samples_accCodes$Serotype==unique(Mass_Samples_accCodes$Serotype)[i],]$SequenceCluster))
}
# cluster_diversity
# [1] 3 2 2 2 5 3 2 8 1 1 1 1 4 2 2 2 1 2 4 3 6 4 4 1 1 1 1 2 1 1 2 1
# the serotypes consist of 1-8 sequence clusters
```

```{r}
# first impression is that serotype and cluster definitions are quite different
# install.packages("Polychrome")
library(Polychrome)
# build-in color palette
Glasbey = glasbey.colors(32)
#swatch(Glasbey)
names(Glasbey) <- unique(Mass_Samples_accCodes$Serotype)


ggplot(Mass_Samples_accCodes, aes(fill=Serotype, y=1, x=SequenceCluster)) + 
  geom_bar(position='stack', stat='identity')


ggplot(Mass_Samples_accCodes, aes(fill=SequenceCluster, y=1, x=Serotype)) + 
  geom_bar(position='stack', stat='identity')
```

# now use the serotypes instead of clusters
# import data sets from data processing:
```{r}
#Mass_Samples_accCodes <- readRDS(file = "Mass_Samples_accCodes.rds")
Sero_intermed_gene_presence_absence_consensus <- readRDS(file = "Sero_intermed_gene_presence_absence_consensus.rds")
Sero_intermed_gene_presence_absence_consensus_matrix <- sapply(Sero_intermed_gene_presence_absence_consensus[-1,-1],as.double)
Sero_model_start_pop <- readRDS(file = "Sero_model_start_pop.rds")
#delta_ranking <- readRDS(file = "delta_ranking.rds")
Sero_freq_1 <- readRDS(file = "Sero_freq_1.rds")
Sero_freq_2<- readRDS(file = "Sero_freq_2.rds")
Sero_freq_3 <- readRDS(file = "Sero_freq_3.rds")
Sero_mass_VT <- readRDS(file = "Sero_mass_VT.rds")
```

#define parameters for the model:
```{r}
mass_serotypes <- length(unique(Mass_Samples_accCodes$Serotype))
avg_sero_freq <- rep(1/mass_serotypes, mass_serotypes)

params_n_vP <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(Sero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = Sero_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = delta_ranking, m = 0.0052207254, migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = 0.1321567425, vacc_time = 0)
```

```{r}
sero_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(Sero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = Sero_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = delta_ranking, m = params[4], migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],Sero_freq_2) + combined_compare(x[,1,73],Sero_freq_3) 
}

```

```{r}
sero_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), sero_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.38251173 0.00518133 0.31922936 0.03974063 0.23900668

#$value
#[1] -205.9478
```

```{r}

sero_fit_params <- sero_optim_fit$par
all_params <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(Sero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = Sero_intermed_gene_presence_absence_consensus_matrix, sigma_f = sero_fit_params[1], sigma_w = sero_fit_params[2], prop_f = sero_fit_params[3], delta = delta_ranking, m = sero_fit_params[4], migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = sero_fit_params[5], vacc_time = 0)
WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
sero_model_val1 <- x[,1,1]
sero_model_val2 <- x[,1,37]
sero_model_val3 <- x[,1,73]

sero_model1_VT <- sero_model_val1[which(Sero_mass_VT==1)]
sero_model1_NVT <- sero_model_val1[which(Sero_mass_VT==0)]
sero_model2_VT <- sero_model_val2[which(Sero_mass_VT==1)]
sero_model2_NVT <- sero_model_val2[which(Sero_mass_VT==0)]
sero_model3_VT <- sero_model_val3[which(Sero_mass_VT==1)]
sero_model3_NVT <- sero_model_val3[which(Sero_mass_VT==0)]
```

### ggCaller and serotypes:

```{r}
#Mass_Samples_accCodes <- readRDS(file = "Mass_Samples_accCodes.rds")
ggCsero_intermed_gene_presence_absence_consensus <- readRDS(file = "ggCsero_intermed_gene_presence_absence_consensus.rds")
ggCsero_intermed_gene_presence_absence_consensus_matrix <- sapply(ggCsero_intermed_gene_presence_absence_consensus[-1,-1],as.double)
Sero_model_start_pop <- readRDS(file = "Sero_model_start_pop.rds")
#delta_ranking <- readRDS(file = "delta_ranking.rds")
#Sero_freq_1 <- readRDS(file = "Sero_freq_1.rds")
#Sero_freq_2<- readRDS(file = "Sero_freq_2.rds")
#Sero_freq_3 <- readRDS(file = "Sero_freq_3.rds")
#Sero_mass_VT <- readRDS(file = "Sero_mass_VT.rds")
```

# import data sets from data processing:
```{r}
ggC_delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
```

#define parameters for the model:
```{r}
ggCsero_params_n_vP <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(ggCsero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = ggCsero_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = ggC_delta_ranking, m = 0.0052207254, migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = 0.1321567425, vacc_time = 0)
```


```{r}
ggCsero_fit_dfoptim <- function(params){
  all_params <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(ggCsero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = ggCsero_intermed_gene_presence_absence_consensus_matrix, sigma_f = params[1], sigma_w = params[2], prop_f = params[3], delta = ggC_delta_ranking, m = params[4], migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = params[5], vacc_time = 0)
  WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],Sero_freq_2) + combined_compare(x[,1,73],Sero_freq_3) 
  #sum((x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))^2) + sum((x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3)))^2)
  #sum(abs(x[,1,37]/sum(x[,1,37]) - (mass_cluster_freq_2/sum(mass_cluster_freq_2)))) + sum(abs(x[,1,73]/sum(x[,1,73]) - (mass_cluster_freq_3/sum(mass_cluster_freq_3))))
}

```

```{r}
ggCsero_optim_fit <- nmkb(c(0.15, 0.05, 0.25, 0.03, 0.05), ggCsero_fit_dfoptim, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))
#$par
#[1] 0.413061811 0.006497421 0.099712391 0.062105898 0.323338547


#$value
#[1] -209.249

#better value than COGtriangles + manual seq clusters and COGtriangles + PopPUNK clusters!
```

#ggCsero plot data

```{r}
ggCsero_fit_params <- ggCsero_optim_fit$par
all_params <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(ggCsero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = ggCsero_intermed_gene_presence_absence_consensus_matrix, sigma_f = ggCsero_fit_params[1], sigma_w = ggCsero_fit_params[2], prop_f = ggCsero_fit_params[3], delta = ggC_delta_ranking, m = ggCsero_fit_params[4], migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = ggCsero_fit_params[5], vacc_time = 0)
ggC_WFmodel <- WF_nG_h_vP$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
n_particles <- 10L
n_times <- 73
x <- array(NA, dim = c(ggC_WFmodel$info()$len, n_particles, n_times))
for (t in seq_len(n_times)) {
  x[ , , t] <- ggC_WFmodel$run(t)
}
time <- x[1, 1, ]
x <- x[-1, , ]
  
ggCsero_model_val1 <- x[,1,1]
ggCsero_model_val2 <- x[,1,37]
ggCsero_model_val3 <- x[,1,73]

ggCsero_model1_VT <- ggCsero_model_val1[which(Sero_mass_VT==1)]
ggCsero_model1_NVT <- ggCsero_model_val1[which(Sero_mass_VT==0)]
ggCsero_model2_VT <- ggCsero_model_val2[which(Sero_mass_VT==1)]
ggCsero_model2_NVT <- ggCsero_model_val2[which(Sero_mass_VT==0)]
ggCsero_model3_VT <- ggCsero_model_val3[which(Sero_mass_VT==1)]
ggCsero_model3_NVT <- ggCsero_model_val3[which(Sero_mass_VT==0)]
```

# Create new Lollipop plots that split the COGtriangles and ggCaller into two rows
```{r}
# Plot NVTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Non-Vaccine Types, Serotypes",data1 = Sero_freq_1[which(Sero_mass_VT==0)]/sum(Sero_freq_1), model_name_1 = "COGtriangles",model1 = sero_model1_NVT/sum(sero_model_val1), model_name_2 = "ggCaller", model2 = ggCsero_model1_NVT/sum(ggCsero_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Non-Vaccine Types, Serotypes",data1 = Sero_freq_2[which(Sero_mass_VT==0)]/sum(Sero_freq_2), model_name_1 = "COGtriangles", model1 = sero_model2_NVT/sum(sero_model_val2), model_name_2 = "ggCaller", model2 = ggCsero_model2_NVT/sum(ggCsero_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Non-Vaccine Types, Serotypes",data1 = Sero_freq_3[which(Sero_mass_VT==0)]/sum(Sero_freq_3), model_name_1 = "COGtriangles", model1 = sero_model3_NVT/sum(sero_model_val3), model_name_2 = "ggCaller", model2 = ggCsero_model3_NVT/sum(ggCsero_model_val3))
```


```{r}
# Plot VTs
lollipop_cluster_freqs_2x2points(year = "2001", plot_title = "Vaccine Types, Serotypes",data1 = Sero_freq_1[which(Sero_mass_VT==1)]/sum(Sero_freq_1), model_name_1 = "COGtriangles",model1 = sero_model1_VT/sum(sero_model_val1), model_name_2 = "ggCaller", model2 = ggCsero_model1_VT/sum(ggCsero_model_val1))
lollipop_cluster_freqs_2x2points(year = "2004",plot_title = "Vaccine Types, Serotypes",data1 = Sero_freq_2[which(Sero_mass_VT==1)]/sum(Sero_freq_2), model_name_1 = "COGtriangles", model1 = sero_model2_VT/sum(sero_model_val2), model_name_2 = "ggCaller", model2 = ggCsero_model2_VT/sum(ggCsero_model_val2))
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Vaccine Types, Serotypes",data1 = Sero_freq_3[which(Sero_mass_VT==1)]/sum(Sero_freq_3), model_name_1 = "COGtriangles", model1 = sero_model3_VT/sum(sero_model_val3), model_name_2 = "ggCaller", model2 = ggCsero_model3_VT/sum(ggCsero_model_val3))
```

### create model version with 616 compartments (one per individual sequence)
```{r}
mass_seq_freq_1 <- readRDS("mass_seq_freq_1.rds")
mass_seq_freq_2 <- readRDS("mass_seq_freq_2.rds")
mass_seq_freq_3 <- readRDS("mass_seq_freq_3.rds")
seq_model_start_pop <- readRDS("seq_model_start_pop.rds") 
seq_model_start_pop_2 <- readRDS("seq_model_start_pop_2.rds")
# the two start populations differ in the amount of noise that has been added
# the first one has more than the second 
mass_seq_VT <- readRDS("mass_seq_VT.rds")
```

# COGtriangles version
```{r}
intermed_gene_presence_absence <- readRDS("intermed_gene_presence_absence.rds")
intermed_gene_presence_absence_matrix <- sapply(intermed_gene_presence_absence[-1,-1],as.double)
```

```{r}
mass_seqs <- nrow(Mass_Samples_accCodes)
avg_mass_seqs <- rep(1/mass_seqs, mass_seqs)

seq_params_n_vP <- list(dt = 1/36, species_no = mass_seqs,  gene_no = nrow(intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = intermed_gene_presence_absence_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = delta_ranking, m = 0.0052207254, migVec = avg_mass_seqs, vaccTypes = as.double(mass_seq_VT), v = 0.1321567425, vacc_time = 0)

seq_WFmodel <- WF_nG_h_vP$new(pars = seq_params_n_vP,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
Mass_samples_index_dict <- 1:nrow(Mass_Samples_accCodes)
names(Mass_samples_index_dict) <- Mass_Samples_accCodes$`Isolate Name`

# summarize single-sequence clusters into PP clusters
sum_seq_clusters <- function(sequence_clust){
  clustered_seqs <- rep(0, PP_mass_clusters)
  for (i in 1:PP_mass_clusters) {
    clustered_seqs[i] <- sum(sequence_clust[Mass_samples_index_dict[PopPUNK_clusters[PopPUNK_clusters$Cluster==i,]$IsolateName]])
  }
  clustered_seqs
}

#PopPUNK_clusters
PP_combined_compare_616 <- function(state, observed, pars = NULL) {
  result <- 0
  data_size <- sum(observed)
  model_size = sum(state)
  
  # need to summarize the data and the observations into clusters
  clustered_state <- sum_seq_clusters(state)
  clustered_obs <- sum_seq_clusters(observed)
  
  for (i in 1:length(clustered_obs)){
    result <- result + ll_pois(clustered_obs[i], clustered_state[i]/model_size * data_size)
  }
  result
}

NFDS_fitting_closure_616 <- function(all_other_params, data1, data2){
  fit_dfoptim <- function(fit_params){
    params <- c(all_other_params, sigma_f = fit_params[1], sigma_w = fit_params[2], prop_f = fit_params[3], m = fit_params[4], v = fit_params[5])
    WFmodel <- WF_nG_h_vP$new(pars = params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
    n_particles <- 10L
    n_times <- 73
    x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

    for (t in seq_len(n_times)) {
      x[ , , t] <- WFmodel$run(t)
    }
    time <- x[1, 1, ]
    x <- x[-1, , ]
    PP_combined_compare_616(x[,1,37],data1) + PP_combined_compare_616(x[,1,73],data2) 
  }
}
```

```{r}
COGPP_params_616 <- list(dt = 1/36, species_no = mass_seqs,  gene_no = nrow(intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = intermed_gene_presence_absence_matrix, delta = delta_ranking, migVec = avg_mass_seqs, vaccTypes = as.double(mass_seq_VT), vacc_time = 0)

COGPP_fitting_616 <- NFDS_fitting_closure_616(COGPP_params_616, as.double(mass_seq_freq_2), as.double(mass_seq_freq_3))

start_params <- c(0.15, 0.05, 0.25, 0.03, 0.05)

fit_616 <- nmkb(start_params, COGPP_fitting_616, lower=c(0.055,0,0,0,0), upper=c(1,0.055,1,1,1), control = c(maximize = TRUE, trace = TRUE))

#$par
#[1] 0.10461712 0.05499699 0.12309585 0.72932605 0.97526777

#$value
#[1] -188.9444

start_p <- rep(0,10)
start_w <- rep(0,10)
start_prop <- rep(0,10)
end_p <- rep(0,10)
end_w <- rep(0,10)
end_prop <- rep(0,10)
start_m <- rep(0,10)
start_v <- rep(0,10)
end_m <- rep(0,10)
end_v <- rep(0,10)
end_error <- rep(0,10)
for (i in 1:10) {
  start_params <- runif(5)
  fit_616 <- nmkb(start_params, ggCPP_fitting_616, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE, trace = TRUE))
  end_error[i] <- fit_616$value
  end_p[i] <- fit_616$par[1]
  end_w[i] <- fit_616$par[2]
  end_prop[i] <- fit_616$par[3]
  end_m[i] <- fit_616$par[4]
  end_v[i] <- fit_616$par[5]
  
  start_p[i] <- start_params[1]
  start_w[i] <- start_params[2]
  start_prop[i] <- start_params[3]
  start_m[i] <- start_params[4]
  start_v[i] <- start_params[5]
}
```

```{r}
# only seven runs, which already took an hour or so
#> end_error
# [1] -269.2086 -267.4982 -269.9346 -267.8150 -268.5025 -270.1028 -265.8139    0.0000    0.0000    0.0000
#> end_p
# [1] 0.695418564 0.880586639 0.995642865 0.172117022 0.350358448 0.341518580 0.001895943 0.000000000 0.000000000 0.000000000
#> end_w
# [1] 0.09528001 0.16557455 0.97558824 0.26675343 0.37023268 0.90908575 0.08035755 0.00000000 0.00000000 0.00000000
#> end_prop
# [1] 0.919970171 0.001408166 0.424236528 0.340439155 0.388935327 0.998642027 0.822636697 0.000000000 0.000000000 0.000000000
#> end_m
# [1] 0.9092072 0.7310387 0.9928808 0.8810217 0.9177145 0.9542316 0.7865585 0.0000000 0.0000000 0.0000000
#> end_v
# [1] 0.9944368 0.8493109 0.9018145 0.6526372 0.9294109 0.6186854 0.9969169 0.0000000 0.0000000 0.0000000
#> start_p
# [1] 0.1043812 0.5933345 0.9334867 0.3675858 0.4993742 0.2117662 0.2748254 0.0000000 0.0000000 0.0000000
#> start_w
# [1] 0.52289973 0.32520405 0.70701398 0.34342386 0.08975637 0.82618422 0.31166237 0.00000000 0.00000000 0.00000000
#> start_prop
# [1] 0.49302235 0.03924397 0.34615051 0.24132111 0.68209792 0.96136825 0.87793033 0.00000000 0.00000000 0.00000000
#> start_m
# [1] 0.6302457 0.6323589 0.8953097 0.8982296 0.6935370 0.9034749 0.6929284 0.0000000 0.0000000 0.0000000
#> start_v
# [1] 0.8896970 0.7250780 0.3615256 0.2809701 0.3773499 0.4795797 0.9857552 0.0000000 0.0000000 0.0000000
```

```{r}
plot_end_p <- c(0.695418564, 0.880586639, 0.995642865, 0.172117022, 0.350358448, 0.341518580, 0.001895943)
plot_end_w <- c(0.09528001, 0.16557455, 0.97558824, 0.26675343, 0.37023268, 0.90908575, 0.08035755)
plot_end_prop <- c(0.919970171, 0.001408166, 0.424236528, 0.340439155, 0.388935327, 0.998642027, 0.822636697)
plot_end_m <- c(0.9092072, 0.7310387, 0.9928808, 0.8810217, 0.9177145, 0.9542316, 0.7865585)
plot_end_v <- c(0.9944368, 0.8493109, 0.9018145, 0.6526372, 0.9294109, 0.6186854, 0.9969169)

plot_start_p <- c(0.1043812, 0.5933345, 0.9334867, 0.3675858, 0.4993742, 0.2117662, 0.2748254)
plot_start_w <- c(0.52289973, 0.32520405, 0.70701398, 0.34342386, 0.08975637, 0.82618422, 0.31166237)
plot_start_prop <- c(0.49302235, 0.03924397, 0.34615051, 0.24132111, 0.68209792, 0.96136825, 0.87793033)
plot_start_m <- c(0.6302457, 0.6323589, 0.8953097, 0.8982296, 0.6935370, 0.9034749, 0.6929284)
plot_start_v <- c(0.8896970, 0.7250780, 0.3615256, 0.2809701, 0.3773499, 0.4795797, 0.9857552)
plot(1:7, plot_end_p,  pch = 19)
points(plot_end_w, col = "#E69F00", pch = 19)
points(plot_end_prop, col = "#56B4E9", pch = 19)
points(plot_end_m, col = "#009E73", pch = 19)
points(plot_end_v, col = "#F0E442", pch = 19)
lines(plot_end_p)
lines(plot_end_w, col = "#E69F00",)
lines(plot_end_prop, col = "#56B4E9")
lines(plot_end_m, col = "#009E73")
lines(plot_end_v, col = "#F0E442")
points(plot_start_p, pch = 17)
points(plot_start_w, col = "#E69F00", pch = 17)
points(plot_start_prop, col = "#56B4E9", pch = 17)
points(plot_start_m, col = "#009E73", pch = 17)
points(plot_start_v, col = "#F0E442", pch = 17)
```

# evaluate on manual sequence clusters instead
```{r}
# summarize single-sequence clusters into PP clusters
sum_seq_man_clusters <- function(sequence_clust){
  clustered_seqs <- rep(0, mass_clusters)
  for (i in 1:mass_clusters) {
    clustered_seqs[i] <- sum(sequence_clust[which(Mass_Samples_accCodes$SequenceCluster==i)])
  }
  clustered_seqs
}

#manual sequence clusters
combined_compare_616 <- function(state, observed, pars = NULL) {
  result <- 0
  data_size <- sum(observed)
  model_size = sum(state)
  
  # need to summarize the data and the observations into clusters
  clustered_state <- sum_seq_man_clusters(state)
  clustered_obs <- sum_seq_man_clusters(observed)
  
  for (i in 1:length(clustered_obs)){
    result <- result + ll_pois(clustered_obs[i], clustered_state[i]/model_size * data_size)
  }
  result
}

NFDS_fitting_closure_616_man <- function(all_other_params, data1, data2){
  fit_dfoptim <- function(fit_params){
    params <- c(all_other_params, sigma_f = fit_params[1], sigma_w = fit_params[2], prop_f = fit_params[3], m = fit_params[4], v = fit_params[5])
    WFmodel <- WF_nG_h_vP$new(pars = params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
    n_particles <- 10L
    n_times <- 73
    x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

    for (t in seq_len(n_times)) {
      x[ , , t] <- WFmodel$run(t)
    }
    time <- x[1, 1, ]
    x <- x[-1, , ]
    combined_compare_616(x[,1,37],data1) + combined_compare_616(x[,1,73],data2) 
  }
}
```

```{r}
COG_params_616 <- list(dt = 1/36, species_no = mass_seqs,  gene_no = nrow(intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = intermed_gene_presence_absence_matrix, delta = delta_ranking, migVec = avg_mass_seqs, vaccTypes = as.double(mass_seq_VT), vacc_time = 0)

COG_fitting_616 <- NFDS_fitting_closure_616_man(COG_params_616, as.double(mass_seq_freq_2), as.double(mass_seq_freq_3))

start_params <- c(0.15, 0.05, 0.25, 0.03, 0.05)

man_fit_616 <- nmkb(start_params, COG_fitting_616, lower=c(0.055,0,0,0,0), upper=c(1,0.055,1,1,1), control = c(maximize = TRUE, trace = TRUE))

#$par
#[1] 0.0607118499 0.0530314041 0.0001057576 0.7724929778 0.9902405314

#$value
#[1] -142.7887
```

# ggCaller version
```{r}
ggC_intermed_gene_presence_absence <- readRDS("ggC_intermed_gene_presence_absence.rds")
ggC_intermed_gene_presence_absence_matrix <- sapply(ggC_intermed_gene_presence_absence[-1,-1],as.double)
```

```{r}
ggCPP_params_616 <- list(dt = 1/36, species_no = mass_seqs,  gene_no = nrow(ggC_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_matrix, delta = ggC_delta_ranking, migVec = avg_mass_seqs, vaccTypes = as.double(mass_seq_VT), vacc_time = 0)

ggCPP_fitting_616 <- NFDS_fitting_closure_616(ggCPP_params_616, as.double(mass_seq_freq_2), as.double(mass_seq_freq_3))

start_params <- c(0.15, 0.05, 0.25, 0.03, 0.05)

ggCPP_fit_616 <- nmkb(start_params, ggCPP_fitting_616, lower=c(0,0,0,0,0), upper=c(1,1,1,1,1), control = c(maximize = TRUE))

#$par
#[1] 0.005014889 0.022394344 0.822039194 0.557391976 0.834516365

#$value
#[1] -187.8815
```

```{r}
gCC_params_616 <- list(dt = 1/36, species_no = mass_seqs,  gene_no = nrow(ggC_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_matrix, delta = ggC_delta_ranking, migVec = avg_mass_seqs, vaccTypes = as.double(mass_seq_VT), vacc_time = 0)

gCC_fitting_616 <- NFDS_fitting_closure_616_man(gCC_params_616, as.double(mass_seq_freq_2), as.double(mass_seq_freq_3))

start_params <- c(0.15, 0.05, 0.25, 0.03, 0.05)

gCC_man_fit_616 <- nmkb(start_params, gCC_fitting_616, lower=c(0.055,0,0,0,0), upper=c(1,0.055,1,1,1), control = c(maximize = TRUE, trace = TRUE))

#$par
#[1] 0.0550442470 0.0548071213 0.0000829429 0.6642395068 0.9333139271

#$value
#[1] -141.187
```

### NULL MODEL
```{r}
WF_null <- odin.dust::odin_dust("null_NFDS_Model.R")
```

# Fitting the model:

```{r}
fitting_closure <- function(all_other_params, data1, data2){
  null_fit_dfoptim <- function(fit_params){
  params <- c(all_other_params, m = fit_params[1], v = fit_params[2])
  null_WFmodel <- WF_null$new(pars = params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(null_WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- null_WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],data1) + combined_compare(x[,1,73],data2) 
}
}
```

```{r}
null_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters, Pop_ini = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, vacc_time = 0)

fit_null_ggCPP <- fitting_closure(null_ggCPP_params, PP_mass_cluster_freq_2, PP_mass_cluster_freq_3)

null_ggCPP_optim_fit <- nmkb(c(0.03, 0.05), fit_null_ggCPP, lower=c(0,0), upper=c(1,1), control = c(maximize = TRUE))
#$par
#[1] 0.01172671 0.01913524

#$value
#[1] -295.7375

# A little worse than ggCaller + PopPUNK non-null (but actually not so much worse...)
```

```{r}
null_man_params <- list(dt = 1/36, species_no = mass_clusters, Pop_ini = as.double(model_start_pop), capacity = sum(model_start_pop), migVec = avg_cluster_freq, vaccTypes = mass_VT, vacc_time = 0)

fit_null_man <- fitting_closure(null_man_params, mass_cluster_freq_2, mass_cluster_freq_3)

null_man_optim_fit <- nmkb(c(0.03, 0.05), fit_null_man, lower=c(0,0), upper=c(1,1), control = c(maximize = TRUE))
#$par
#[1] 0.008636252 0.024126479

#$value
#[1] -239.5123
```

# try simulated annealing instead of dfoptim
```{r}
# install.packages("optimization")
library(optimization)


null_man_sa <- optim_sa(fun = fit_null_man, start = c(0.008636252, 0.024126479), maximization = TRUE, trace = TRUE,lower=c(0,0), upper=c(1,1), control = c(rf = 2))
#$par
#[1] 0.01 0.04

#$function_value
#[1] -252.2131
```

```{r}
start_m <- rep(0,10)
start_v <- rep(0,10)
end_m <- rep(0,10)
end_v <- rep(0,10)
end_error <- rep(0,10)
for (i in 1:10) {
  start_params <- runif(2)
  null_man_sa <- optim_sa(fun = fit_null_man, start = start_params, maximization = TRUE, trace = FALSE,lower=c(0,0), upper=c(1,1), control = c(rf = 3, r = 0.8))
  end_error[i] <- null_man_sa$function_value
  end_m[i] <- null_man_sa$par[1]
  end_v[i] <- null_man_sa$par[2]
  start_m[i] <- start_params[1]
  start_v[i] <- start_params[2]
}

# best:
# -241.3298
# end params
# 0.006305697 0.01630453
# start params
# 0.98630570 0.8363045314
```

```{r}
NFDS_fitting_closure <- function(all_other_params, data1, data2){
  fit_dfoptim <- function(fit_params){
  params <- c(all_other_params, sigma_f = fit_params[1], sigma_w = fit_params[2], prop_f = fit_params[3], m = fit_params[4], v = fit_params[5])
  WFmodel <- WF_nG_h_vP$new(pars = params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WFmodel$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WFmodel$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],data1) + combined_compare(x[,1,73],data2) 
}
}
```

```{r}
ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, delta = ggC_delta_ranking, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, vacc_time = 0)

ggCPP_fitting <- NFDS_fitting_closure(ggCPP_params, PP_mass_cluster_freq_2, PP_mass_cluster_freq_3)

start_params <- c(0.15, 0.05, 0.25, 0.03, 0.05)

null_man_sa <- optim_sa(fun = ggCPP_fitting, start = start_params, maximization = TRUE, trace = TRUE,lower=c(0.05,0,0,0,0), upper=c(1,0.05,1,1,1), control = c(rf = 2, r = 0.6))

# took really long (10 mins?)
# and produced weird results:
# $par
#[1] 0.25 0.01 0.22 0.02 0.24

#$function_value
#[1] -258.0113

# 42 iterations (not so much for so much time?)
# maybe issue with sigma_w and sigma_f? maybe I should force the smaller one to be small

#$par
#[1] 0.12 0.00 0.49 0.04 0.25

#$function_value
#[1] -246.5182
```

# Visualise cluster frequency changes for ggplot / PopPUNK
```{r}
# plot cluster freq coloured by vacc type, non VT and mixed
#create colour-vector based on VT mean info
plot_VT_colours <- rep("black",PP_mass_clusters)
for (i in 1:PP_mass_clusters){
  if(PP_mass_VT[i] ==1){
    plot_VT_colours[i] <- "#E69F00"
  }
  else if(PP_mass_VT[i] ==0){
    plot_VT_colours[i] <- "#56B4E9"
  }
}


par(mfrow=c(1,1))
op <- par(mar = c(5,7,4,2) + 0.1,mgp=c(3,1,0))
plot(PP_mass_cluster_freq_1 / sum(PP_mass_cluster_freq_1), PP_mass_cluster_freq_3 / sum(PP_mass_cluster_freq_3), axes = FALSE, ann = FALSE, pch = 19, col = plot_VT_colours, cex = 2.5, ylim = c(0,0.18), xlim = c(0,0.18))
#abline(a=0, b=1)
legend("topleft", title = "Clusters", c("VT", "Non-VT"),fill = c("#E69F00", "#56B4E9"), cex = 2.5)
axis(1,cex.axis = 2.5)
axis(2, cex.axis = 2.5)
title(xlab = "Pre-vaccine cluster frequency", cex.lab=2.5)
title(ylab = "Post-vaccine cluster frequency", cex.lab = 2.5,
      line = 4.5)
box()
par(op)
```

```{r}
### ggCaller
ggCaller_gene_presence_absence_2001 <- readRDS(file = "ggCaller_gene_presence_absence_2001.rds")
ggCaller_gene_presence_absence_2004 <- readRDS(file = "ggCaller_gene_presence_absence_2004.rds")
ggCaller_gene_presence_absence_2007 <- readRDS(file = "ggCaller_gene_presence_absence_2007.rds")

gene_cluster_counts_2001 <- apply(ggCaller_gene_presence_absence_2001[-1,-1],1,sum_as_int)/(ncol(ggCaller_gene_presence_absence_2001)-1)
gene_cluster_counts_2007 <- apply(ggCaller_gene_presence_absence_2007[-1,-1],1,sum_as_int)/(ncol(ggCaller_gene_presence_absence_2007)-1)

par(mar=c(5,6,4,1)+.1)
plot((gene_cluster_counts_2001), gene_cluster_counts_2007, pch = 21, xlab = "Pre-vaccine COG frequency", ylab = "Post-vaccine COG frequency",cex.lab=2.5, cex.axis = 2.5, cex = 1.5)

```

### try out finding the important genes for NFDS for ggCPP
```{r}
# create a vector with randomly distributed zeros and ones of the length of the number of genes and the number of ones determined by prop_f
nfds_gene_bool <- rbinom(nrow(ggC_intermed_gene_presence_absence_consensus)-1,1,0.3)
```

```{r}
WF_findGenes <- odin.dust::odin_dust("NFDS_Model_FindGenes.R")
# copy of WrightFisherModel/WrightFisher_newData_nGenotypes_haploid_PopsizeVariablePois.R
```

```{r}
all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.3, delta_bool = as.double(nfds_gene_bool), m = 0.005, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.05, vacc_time = 0)
```

### Running the model:
```{r}
WFmodel_findGenes <- WF_findGenes$new(pars = all_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
# WFmodel_findGenes$run(10)
```

# maybe try fitting with dfoptim?
# create gene_bool_vectors
# idea: create vectors where 25 percent are 1, the rest 0
# then find the genes that are "on" (=1) in the best fits
# 25 percent for ggCaller are 71 genes (1774/25 ~= 71)
```{r}
find_genes_df <- data.frame(matrix(0,nrow = nrow(ggC_intermed_gene_presence_absence_consensus)-1, ncol = 50))
for (i in 1:25) {
  find_genes_df[,i] <- rep(c(rep(0,24),1),75)[i:(nrow(ggC_intermed_gene_presence_absence_consensus)-2 + i)]
  find_genes_df[,i+25] <- c(rep(0,1703),rep(1,71),rep(0,1703))[(1 + (i-1) * 71) : (nrow(ggC_intermed_gene_presence_absence_consensus)-1 + (i-1) * 71)]
}
```

```{r}
fitting_closure_FindGenes <- function(all_other_params, data1, data2){
  null_fit_dfoptim <- function(fit_params){
  params <- c(all_other_params, sigma_f = fit_params[1], m = fit_params[2], v = fit_params[3])
  WF_findGenes_model <- WF_findGenes$new(pars = params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
  n_particles <- 10L
  n_times <- 73
  x <- array(NA, dim = c(WF_findGenes_model$info()$len, n_particles, n_times))

  for (t in seq_len(n_times)) {
    x[ , , t] <- WF_findGenes_model$run(t)
  }
  time <- x[1, 1, ]
  x <- x[-1, , ]
  combined_compare(x[,1,37],data1) + combined_compare(x[,1,73],data2) 
}
}
```

```{r}
FindGenes_all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.3, delta_bool = as.double(nfds_gene_bool), m = 0.005, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.05, vacc_time = 0)

fit_FindGenes_ggCPP <- fitting_closure_FindGenes(FindGenes_all_params, PP_mass_cluster_freq_2, PP_mass_cluster_freq_3)

FindGenes_ggCPP_optim_fit <- nmkb(c(0.15, 0.03, 0.05), fit_FindGenes_ggCPP, lower=c(0,0,0), upper=c(1,1,1), control = c(maximize = TRUE))
```

```{r}
for (i in 1:10){
  FindGenes_all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.3, delta_bool = as.double(find_genes_df[,i]), m = 0.005, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.05, vacc_time = 0)

fit_FindGenes_ggCPP <- fitting_closure_FindGenes(FindGenes_all_params, PP_mass_cluster_freq_2, PP_mass_cluster_freq_3)

FindGenes_ggCPP_optim_fit <- nmkb(c(0.15, 0.03, 0.05), fit_FindGenes_ggCPP, lower=c(0,0,0), upper=c(1,1,1), control = c(maximize = TRUE))
print(FindGenes_ggCPP_optim_fit$par)
print(FindGenes_ggCPP_optim_fit$value)
}
```

### Comparing different models using abs error
```{r}
# COG man seq clusters
params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.1789665082, sigma_w = 0.0006039627, prop_f = 0.3669067334 , delta = delta_ranking, m = 0.0078524723 , migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1103623064, vacc_time = 0)
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = params_n_vP,
                          time = 1,
                          n_particles = 10L,
                          n_threads = 4L,
                          seed = 1L)
simMean2 <- rowMeans(WFmodel_nG_h_vP$run(36)[-1,])
simMean3 <- rowMeans(WFmodel_nG_h_vP$run(72)[-1,])
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMean3/sum(simMean3)))
# [1] 0.407629
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMean3/sum(simMean3))) + sum(abs(mass_cluster_freq_2/sum(mass_cluster_freq_2) - simMean2/sum(simMean2)))
# [1] 0.7558528
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMean3/sum(simMean3)))/mass_clusters
# [1] 0.009942172

### COG PopPUNK
all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.1764665767, sigma_w = 0.0005367709, prop_f = 0.437293239, delta = delta_ranking, m = 0.0114977275, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1135499700, vacc_time = 0)
WFmodel_PP <- WF_nG_h_vP$new(pars = all_params,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanPP2 <- rowMeans(WFmodel_PP$run(36)[-1,])
simMeanPP3 <- rowMeans(WFmodel_PP$run(72)[-1,])
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanPP3/sum(simMeanPP3)))
# [1] 0.4440668
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanPP3/sum(simMeanPP3))) + sum(abs(PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2) - simMeanPP2/sum(simMeanPP2)))
# [1] 0.8750077
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanPP3/sum(simMeanPP3)))/PP_mass_clusters
# [1] 0.007162368

### ggCaller man seq clusters
params_ggC <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(ggC_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.1882242231, sigma_w = 0.0003669121, prop_f = 0.2161135322, delta = ggC_delta_ranking, m = 0.0059668667, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1377344552, vacc_time = 0)
WFmodel_ggCmanSeqCl <- WF_nG_h_vP$new(pars = params_ggC,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggC2 <- rowMeans(WFmodel_ggCmanSeqCl$run(36)[-1,])
simMeanggC3 <- rowMeans(WFmodel_ggCmanSeqCl$run(72)[-1,])
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMeanggC3/sum(simMeanggC3)))
# [1] 0.3908194
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMeanggC3/sum(simMeanggC3))) + sum(abs(mass_cluster_freq_2/sum(mass_cluster_freq_2) - simMeanggC2/sum(simMeanggC2)))
# [1] 0.7078664
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMeanggC3/sum(simMeanggC3)))/mass_clusters
# [1] 0.009532182

### ggCaller PopPUNK
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.1180783495, sigma_w = 0.0004164005, prop_f = 0.3803173188, delta = ggC_delta_ranking, m = 0.0117180887, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1509501052, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3)))
# [1] 0.4220826
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3))) + sum(abs(PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2) - simMeanggCPP2/sum(simMeanggCPP2)))
# [1] 0.8474369
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3)))/PP_mass_clusters
# [1] 0.006807784
```

```{r}
PP_manSeq_clusters_df <- data.frame(matrix(Mass_Samples_accCodes$`Isolate Name`,nrow = nrow(Mass_Samples_accCodes),ncol = 1))
PP_manSeq_clusters_df[,2] <- Mass_Samples_accCodes$SequenceCluster
PP_manSeq_clusters_df[,3] <- PP_Mass_seq_clusters_dict[Mass_Samples_accCodes$`Isolate Name`]
colnames(PP_manSeq_clusters_df) <- c("Isolate_Name","manSeqCl","PP")

# create dictionary to translate between PopPUNK and man seq clusters
PP_to_manSeq_dict <- rep(0,PP_mass_clusters)
for (i in 1:PP_mass_clusters) {
     PP_to_manSeq_dict[i] <- unique(PP_manSeq_clusters_df$manSeqCl[which(PP_manSeq_clusters_df$PP==i)])
}  
names(PP_to_manSeq_dict) <- 1:PP_mass_clusters

# plot man seq cluster composition
PP_manSeqCl_plt_data <- table(PP_manSeq_clusters_df$PP,PP_manSeq_clusters_df$manSeqCl)


#ggplot(PP_manSeq_clusters_df, aes(fill=condition, y=value, x=specie)) + 
#    geom_bar(position="stack", stat="identity")
#library("colorspace")
#install.packages("viridis")
library("viridis") 
barplot(PP_manSeqCl_plt_data, main="PopPUNK cluster distribution in manSeqCl",
   xlab="Manual Sequence CLusters", col = viridis(PP_mass_clusters), legend = rownames(PP_manSeqCl_plt_data),args.legend = c(x = 60, y = 100, ncol=4),ylim = c(0,100), xlim = c(0,60))
```

```{r}
PP_mass_cluster_freq_3_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  PP_mass_cluster_freq_3_asManSeqCl[PP_to_manSeq_dict[i]+1] <- PP_mass_cluster_freq_3_asManSeqCl[PP_to_manSeq_dict[i]+1] + PP_mass_cluster_freq_3[i]
}

PP_mass_cluster_freq_2_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  PP_mass_cluster_freq_2_asManSeqCl[PP_to_manSeq_dict[i]+1] <- PP_mass_cluster_freq_2_asManSeqCl[PP_to_manSeq_dict[i]+1] + PP_mass_cluster_freq_2[i]
}

PP2_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  PP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- PP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanPP2[i]
}
PP3_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  PP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- PP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanPP3[i]
}

ggCPP2_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  ggCPP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- ggCPP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanggCPP2[i]
}
ggCPP3_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  ggCPP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- ggCPP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanggCPP3[i]
}
```

```{r}
# COG man seq clusters
combined_compare(simMean2,mass_cluster_freq_2) + combined_compare(simMean3,mass_cluster_freq_3)
# [1] -192.8827

# COG PopPUNK
combined_compare(PP2_fit_asManSeqCl,PP_mass_cluster_freq_2_asManSeqCl) + combined_compare(PP3_fit_asManSeqCl,PP_mass_cluster_freq_3_asManSeqCl)
#[1] -188.5977

# ggC man seq clusters
combined_compare(simMeanggC2,mass_cluster_freq_2) + combined_compare(simMeanggC3,mass_cluster_freq_3)
#[1] -193.1025

# ggC PopPUNK
combined_compare(ggCPP2_fit_asManSeqCl,PP_mass_cluster_freq_2_asManSeqCl) + 
  combined_compare(ggCPP3_fit_asManSeqCl,PP_mass_cluster_freq_3_asManSeqCl)
#[1] -179.3374
```

### 3-param model
```{r}
# COG man seq clusters
params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.007877661, sigma_w = 0.0, prop_f = 1.0 , delta = delta_ranking, m = 0.008008877, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.048982297, vacc_time = 0)
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = params_n_vP,
                          time = 1,
                          n_particles = 10L,
                          n_threads = 4L,
                          seed = 1L)
simMean2 <- rowMeans(WFmodel_nG_h_vP$run(36)[-1,])
simMean3 <- rowMeans(WFmodel_nG_h_vP$run(72)[-1,])
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMean3/sum(simMean3)))
# [1] 0.6136608
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMean3/sum(simMean3))) + sum(abs(mass_cluster_freq_2/sum(mass_cluster_freq_2) - simMean2/sum(simMean2)))
# [1] 1.025771
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMean3/sum(simMean3)))/mass_clusters
# [1] 0.01496734

### COG PopPUNK
all_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(PP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = PP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.004034883, sigma_w = 0, prop_f = 1, delta = delta_ranking, m = 0.009046951, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.044083001, vacc_time = 0)
WFmodel_PP <- WF_nG_h_vP$new(pars = all_params,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanPP2 <- rowMeans(WFmodel_PP$run(36)[-1,])
simMeanPP3 <- rowMeans(WFmodel_PP$run(72)[-1,])
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanPP3/sum(simMeanPP3)))
# [1] 0.650785
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanPP3/sum(simMeanPP3))) + sum(abs(PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2) - simMeanPP2/sum(simMeanPP2)))
# [1] 1.155241
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanPP3/sum(simMeanPP3)))/PP_mass_clusters
# [1] 0.01049653

### ggCaller man seq clusters
params_ggC <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(ggC_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.01006930, sigma_w = 0, prop_f = 1, delta = ggC_delta_ranking, m = 0.01635317, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.08659896, vacc_time = 0)
WFmodel_ggCmanSeqCl <- WF_nG_h_vP$new(pars = params_ggC,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggC2 <- rowMeans(WFmodel_ggCmanSeqCl$run(36)[-1,])
simMeanggC3 <- rowMeans(WFmodel_ggCmanSeqCl$run(72)[-1,])
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMeanggC3/sum(simMeanggC3)))
# [1] 0.5759087
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMeanggC3/sum(simMeanggC3))) + sum(abs(mass_cluster_freq_2/sum(mass_cluster_freq_2) - simMeanggC2/sum(simMeanggC2)))
# [1] 1.002419
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMeanggC3/sum(simMeanggC3)))/mass_clusters
# [1] 0.01404655

### ggCaller PopPUNK
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.01931485, sigma_w = 0, prop_f = 1, delta = ggC_delta_ranking, m = 0.03104461, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.15977862, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3)))
# [1] 0.6169782
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3))) + sum(abs(PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2) - simMeanggCPP2/sum(simMeanggCPP2)))
# [1] 1.151487
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3)))/PP_mass_clusters
# [1] 0.009951261
```

```{r}

p3_PP2_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  p3_PP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- p3_PP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanPP2[i]
}
p3_PP3_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  p3_PP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- p3_PP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanPP3[i]
}

p3_ggCPP2_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  p3_ggCPP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- p3_ggCPP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanggCPP2[i]
}
p3_ggCPP3_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  p3_ggCPP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- p3_ggCPP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanggCPP3[i]
}

```

```{r}
# COG man seq clusters
combined_compare(simMean2,mass_cluster_freq_2) + combined_compare(simMean3,mass_cluster_freq_3)
# [1] -253.8706

# COG PopPUNK
combined_compare(p3_PP2_fit_asManSeqCl,PP_mass_cluster_freq_2_asManSeqCl) + combined_compare(p3_PP3_fit_asManSeqCl,PP_mass_cluster_freq_3_asManSeqCl)
#[1] -250.98

# ggC man seq clusters
combined_compare(simMeanggC2,mass_cluster_freq_2) + combined_compare(simMeanggC3,mass_cluster_freq_3)
#[1] -251.7234

# ggC PopPUNK
combined_compare(p3_ggCPP2_fit_asManSeqCl,PP_mass_cluster_freq_2_asManSeqCl) + combined_compare(p3_ggCPP3_fit_asManSeqCl,PP_mass_cluster_freq_3_asManSeqCl)
#[1] -250.1021
```

### Null model
```{r}
# COG
null_man_params <- list(dt = 1/36, species_no = mass_clusters, Pop_ini = as.double(model_start_pop), capacity = sum(model_start_pop), migVec = avg_cluster_freq, vaccTypes = mass_VT, vacc_time = 0, m = 0.007792041, v = 0.023544605)
# ggCaller
null_man_params <- list(dt = 1/36, species_no = mass_clusters, Pop_ini = as.double(model_start_pop), capacity = sum(model_start_pop), migVec = avg_cluster_freq, vaccTypes = mass_VT, vacc_time = 0, m = 0.007772363, v = 0.023542031)
null_man_WFmodel <- WF_null$new(pars = null_man_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
simMeanMan2 <- rowMeans(null_man_WFmodel$run(36)[-1,])
simMeanMan3 <- rowMeans(null_man_WFmodel$run(72)[-1,])
# COG man seq clusters
combined_compare(simMeanMan2,mass_cluster_freq_2) + combined_compare(simMeanMan3,mass_cluster_freq_3)
# [1] -251.8277 # COG
# [1] -247.3254 # ggCaller

# COG
null_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters, Pop_ini = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, vacc_time = 0, m = 0.008116513, v = 0.031218082)
# ggCaller
null_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters, Pop_ini = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, vacc_time = 0, m = 0.008118758 , v = 0.031313422)
null_ggCPP_WFmodel <- WF_null$new(pars = null_ggCPP_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
simMeanggCPP2 <- rowMeans(null_ggCPP_WFmodel$run(36)[-1,])
simMeanggCPP3 <- rowMeans(null_ggCPP_WFmodel$run(72)[-1,])
null_ggCPP2_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  null_ggCPP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- null_ggCPP2_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanggCPP2[i]
}
null_ggCPP3_fit_asManSeqCl <- rep(0,mass_clusters)
for (i in 1:PP_mass_clusters) {
  null_ggCPP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] <- null_ggCPP3_fit_asManSeqCl[PP_to_manSeq_dict[i]+1] + simMeanggCPP3[i]
}
# ggC PopPUNK
combined_compare(null_ggCPP2_fit_asManSeqCl,PP_mass_cluster_freq_2_asManSeqCl) + combined_compare(null_ggCPP3_fit_asManSeqCl,PP_mass_cluster_freq_3_asManSeqCl)
# [1] -260.3223 # COG
#[1] -267.9277 # ggCaller
```

### Serotypes
```{r}
# For serotypes, the mapping won't work as well because there are multiple serotypes in some clusters and multiple clusters in some serotypes...
for (i in 1:mass_clusters-1) {
  print(Mass_Samples_accCodes$Serotype[which(Mass_Samples_accCodes$SequenceCluster==i-1)])
}
serotypes_mass <- unique(Mass_Samples_accCodes$Serotype)
for (i in 1:length(serotypes_mass)) {
  print(Mass_Samples_accCodes$SequenceCluster[which(Mass_Samples_accCodes$Serotype==serotypes_mass[i])])
}

# maybe calculating the absolute error is the best that I can do?
# COG man seq clusters
seroCOG_params <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(Sero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = Sero_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.092853976, sigma_w = 0.001272531, prop_f = 0.279026024, delta = delta_ranking, m = 0.003294931, migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = 0.104832549, vacc_time = 0)
seroCOG_WFmodel <- WF_nG_h_vP$new(pars = seroCOG_params,
                          time = 1,
                          n_particles = 10L,
                          n_threads = 4L,
                          seed = 1L)
simMean2 <- rowMeans(seroCOG_WFmodel$run(36)[-1,])
simMean3 <- rowMeans(seroCOG_WFmodel$run(72)[-1,])
sum(abs(Sero_freq_3/sum(Sero_freq_3) - simMean3/sum(simMean3)))
# [1] 0.4791769
sum(abs(Sero_freq_3/sum(Sero_freq_3) - simMean3/sum(simMean3))) + sum(abs(Sero_freq_2/sum(Sero_freq_2) - simMean2/sum(simMean2)))
# [1] 0.8189977
sum(abs(Sero_freq_3/sum(Sero_freq_3) - simMean3/sum(simMean3)))/mass_serotypes
# [1] 0.01497428

ggCsero_params_n_vP <- list(dt = 1/36, species_no = mass_serotypes,  gene_no = nrow(ggCsero_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(Sero_model_start_pop), Pop_eq = as.double(Sero_model_start_pop), capacity = sum(Sero_model_start_pop), Genotypes = ggCsero_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.106580510, sigma_w = 0.001225886, prop_f = 0.350827911, delta = ggC_delta_ranking, m = 0.027188726, migVec = avg_sero_freq, vaccTypes = Sero_mass_VT, v = 0.268750983, vacc_time = 0)
seroggC_WFmodel <- WF_nG_h_vP$new(pars = ggCsero_params_n_vP,
                          time = 1,
                          n_particles = 10L,
                          n_threads = 4L,
                          seed = 1L)
simMean2 <- rowMeans(seroggC_WFmodel$run(36)[-1,])
simMean3 <- rowMeans(seroggC_WFmodel$run(72)[-1,])
sum(abs(Sero_freq_3/sum(Sero_freq_3) - simMean3/sum(simMean3)))
# [1] 0.546132
sum(abs(Sero_freq_3/sum(Sero_freq_3) - simMean3/sum(simMean3))) + sum(abs(Sero_freq_2/sum(Sero_freq_2) - simMean2/sum(simMean2)))
# [1] 0.9233974
sum(abs(Sero_freq_3/sum(Sero_freq_3) - simMean3/sum(simMean3)))/mass_serotypes
# [1] 0.01706663

```

# 616 compartments
```{r}
c616_mass_cluster_freq_1 <- readRDS("mass_seq_freq_1.rds")
c616_mass_cluster_freq_2 <- readRDS(file = "mass_seq_freq_2.rds")
c616_mass_cluster_freq_3 <- readRDS(file = "mass_seq_freq_3.rds")
c616_intermed_gene_presence_absence <- readRDS("intermed_gene_presence_absence.rds")
c616_intermed_gene_presence_absence_matrix <- sapply(c616_intermed_gene_presence_absence[-1,-1],as.double)
seq_model_start_pop <- readRDS("seq_model_start_pop.rds") 
mass_seq_VT <- readRDS("mass_seq_VT.rds")
c616_ggC_intermed_gene_presence_absence <- readRDS("ggC_intermed_gene_presence_absence.rds")
c616_ggC_intermed_gene_presence_absence_matrix <- sapply(c616_ggC_intermed_gene_presence_absence[-1,-1],as.double)
ggC_delta_ranking <- readRDS(file = "ggC_delta_ranking.rds")
delta_ranking <- readRDS(file = "delta_ranking.rds")

man_mass_clusters <- length(unique(seq_clusters$SequenceCluster))
mass_clusters2 <- length(unique(seq_clusters$SequenceCluster))
# summarize single-sequence clusters into PP clusters
sum_seq_man_clusters <- function(sequence_clust){
  clustered_seqs <- rep(0, mass_clusters)
  for (i in 1:mass_clusters) {
    clustered_seqs[i] <- sum(sequence_clust[which(Mass_Samples_accCodes$SequenceCluster==i-1)])
  }
  clustered_seqs
}
  
#observed will be the mass_cluster_freq_2 and _3, not the c616 one
combined_compare_616 <- function(state, observed, pars = NULL) {
  result <- 0
  data_size <- sum(unlist(observed))
  model_size = sum(unlist(state))
    
  # need to summarize the data and the observations into clusters
  clustered_state <- sum_seq_man_clusters(unlist(state))
    
  for (i in 1:mass_clusters){
    result <- result + ll_pois(observed[i], clustered_state[i]/model_size * data_size)
  }
  result
}
```

```{r}
# COG with 616 compartments
seq_clusters <- readRDS("Mass_Samples_accCodes.rds")
avg_cluster_freq <- rep(1/nrow(seq_clusters), nrow(seq_clusters))
# COG fitted with man seq cluster likelihood
c616_params_n_vP <- list(dt = 1/36, species_no = nrow(seq_clusters),  gene_no = nrow(c616_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = c616_intermed_gene_presence_absence_matrix, sigma_f = 0.20840945, sigma_w = 0.02772616, prop_f = 0.90395014, delta = as.double(delta_ranking), m = 0.17328677, migVec = as.double(avg_cluster_freq), vaccTypes = as.double(mass_seq_VT), v = 0.42626268, vacc_time = 0)
# ggC fitted with man seq cluster likelihood
c616_params_n_vP <- list(dt = 1/36, species_no = nrow(seq_clusters),  gene_no = nrow(c616_ggC_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = c616_ggC_intermed_gene_presence_absence_matrix, sigma_f = 0.14764836, sigma_w = 0.02625213, prop_f = 0.27308050, delta = as.double(ggC_delta_ranking), m = 0.14998299, migVec = as.double(avg_cluster_freq), vaccTypes = as.double(mass_seq_VT), v = 0.14154084, vacc_time = 0)
#COG with 616 compartments - fit created using the PP likelihood
c616_params_n_vP <- list(dt = 1/36, species_no = nrow(seq_clusters),  gene_no = nrow(c616_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = c616_intermed_gene_presence_absence_matrix, sigma_f = 0.15123543, sigma_w = 0.00519632, prop_f = 0.30642830, delta = as.double(delta_ranking), m = 0.14821740, migVec = as.double(avg_cluster_freq), vaccTypes = as.double(mass_seq_VT), v = 0.26090610, vacc_time = 0)
# ggC with 616 compartments - fit created using the PP likelihood
c616_params_n_vP <- list(dt = 1/36, species_no = nrow(seq_clusters),  gene_no = nrow(c616_ggC_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = c616_ggC_intermed_gene_presence_absence_matrix, sigma_f = 0.13579085, sigma_w = 0.01279298, prop_f = 0.13540375, delta = as.double(ggC_delta_ranking), m = 0.16166918, migVec = as.double(avg_cluster_freq), vaccTypes = as.double(mass_seq_VT), v = 0.19117939, vacc_time = 0)
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = c616_params_n_vP,
                          time = 1,
                          n_particles = 10L,
                          n_threads = 4L,
                          seed = 1L)
simMean2 <- rowMeans(WFmodel_nG_h_vP$run(36)[-1,])
simMean3 <- rowMeans(WFmodel_nG_h_vP$run(72)[-1,])

combined_compare_616(simMean2,mass_cluster_freq_2) + combined_compare_616(simMean3,mass_cluster_freq_3)
# COG manSeqCl
# [1] -230.2956
# ggC manSeqCl
# [1] -151.6215
# COGPP
# [1] -146.8129
# ggCPP
# [1] -150.4117

```

#Lollipop for normal model together with NULL model
```{r}
### ggCaller PopPUNK
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.1180783495, sigma_w = 0.0004164005, prop_f = 0.3803173188, delta = ggC_delta_ranking, m = 0.0117180887, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1509501052, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])

# Null ggCPP
NullsimMeanggCPP2 <- rowMeans(null_ggCPP_WFmodel$run(36)[-1,])
NullsimMeanggCPP3 <- rowMeans(null_ggCPP_WFmodel$run(72)[-1,])

lollipop_cluster_freqs_2x2_VTandNVT(year = "2004", plot_title = "Full Model vs Null Model", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="NFDS Model", model1 = simMeanggCPP2/sum(simMeanggCPP2), model2 = NullsimMeanggCPP2/sum(NullsimMeanggCPP2), model_name_2 = "Null Model", VT_vec = PP_mass_VT)
lollipop_cluster_freqs_2x2_VTandNVT(year = "2007", plot_title = "Full Model vs Null Model", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="NFDS Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), model2 = NullsimMeanggCPP3/sum(NullsimMeanggCPP3), model_name_2 = "Null Model", VT_vec = PP_mass_VT)


# 3-param
### ggCaller PopPUNK
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.01931485, sigma_w = 0, prop_f = 1, delta = ggC_delta_ranking, m = 0.03104461, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.15977862, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
p3_simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
p3_simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])

lollipop_cluster_freqs_2x2_VTandNVT(year = "2004", plot_title = "3-param Model vs Null Model", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="3-param Model", model1 = p3_simMeanggCPP2/sum(p3_simMeanggCPP2), model2 = NullsimMeanggCPP2/sum(NullsimMeanggCPP2), model_name_2 = "Null Model", VT_vec = PP_mass_VT)
lollipop_cluster_freqs_2x2_VTandNVT(year = "2007", plot_title = "3-param Model vs Null Model", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="3-param Model", model1 = p3_simMeanggCPP3/sum(p3_simMeanggCPP3), model2 = NullsimMeanggCPP3/sum(NullsimMeanggCPP3), model_name_2 = "Null Model", VT_vec = PP_mass_VT)
```

### Plot ggCPP results in lollipop plot
```{r}
#ggCPP_model_val1
lollipop_cluster_freqs_VTandNVT(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = PP_model_start_pop/sum(PP_model_start_pop), PP_mass_VT)
lollipop_cluster_freqs_VTandNVT(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2/sum(simMeanggCPP2), PP_mass_VT)
lollipop_cluster_freqs_VTandNVT(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), PP_mass_VT)
```

### Model version that respects the VT diversity within clusters
```{r}
WF_VT <- odin.dust::odin_dust("NFDS_Model_VT.R")
```

```{r}
ceil_mass_VT <- rep(0, mass_clusters)
for (i in 1:mass_clusters){
  ceil_mass_VT[i] <- ceiling(mean(as.integer(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster == i-1,"Vaccine Type"]=="VT")))
}
ceil_mass_NVT <- rep(0, mass_clusters)
for (i in 1:mass_clusters){
  ceil_mass_NVT[i] <- ceiling(mean(as.integer(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster == i-1,"Vaccine Type"]=="NVT")))
}
mean_mass_VT_2001 <- rep(0, mass_clusters)
for (i in 1:mass_clusters){
  mean_mass_VT_2001[i] <- (mean(as.integer(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster == i-1 & Mass_Samples_accCodes$`Year of Isolation`==2001,"Vaccine Type"]=="VT")))
}
mean_mass_VT_2001[is.nan(mean_mass_VT_2001)] <- 0

mean_mass_VT <- rep(0, mass_clusters)
for (i in 1:mass_clusters){
  mean_mass_VT[i] <- (mean(as.integer(Mass_Samples_accCodes[Mass_Samples_accCodes$SequenceCluster == i-1,"Vaccine Type"]=="VT")))
}

mass_clusters <- length(unique(Mass_Samples_accCodes$SequenceCluster))
#VT_mig <- rep(1/mass_clusters, mass_clusters) * ceil_mass_VT * mass_clusters/sum(ceil_mass_NVT + ceil_mass_VT)
#NVT_mig <- rep(1/mass_clusters, mass_clusters) * (ceil_mass_NVT) * mass_clusters/sum(ceil_mass_NVT + ceil_mass_VT)

NVT_mig <- rep(1/mass_clusters, mass_clusters) * (ceil_mass_NVT)
VT_mig <- rep(1/mass_clusters, mass_clusters) * (1-ceil_mass_NVT)

# NVT, VT
VT_model_start_pop <- matrix(as.double(c(model_start_pop * (1-mean_mass_VT_2001),model_start_pop * mean_mass_VT_2001)), byrow = FALSE, nrow = mass_clusters, ncol = 2)

params_VT <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(intermed_gene_presence_absence_consensus)-1, Pop_ini = VT_model_start_pop, Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = delta_ranking, m = 0.0052207254, migVec = cbind(NVT_mig,VT_mig), vT = c(0,1), v = 0.1321567425, vacc_time = 0)
```

```{r}
WFmodel_VT <- WF_VT$new(pars = params_VT,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
WFmodel_VT$run(36)[(1:42),]
WFmodel_VT$run(36)[(2:42),1] # "normal" version, i.e. VT and NVT together
WFmodel_VT$run(36)[(43:83),1] # NVTs
WFmodel_VT$run(36)[-(1:83),1] # VTs
#  WFmodel_VT$run(36)[(43:83),1] + WFmodel_VT$run(36)[-(1:83),1] # should be the same as WFmodel_VT$run(36)[(2:42),1]
```


### PCA
```{r}
pca_results <- prcomp(t(sapply(ggCPP_intermed_gene_presence_absence_consensus[-1,-1],as.double)))
summary(pca_results)
```

```{r}
var_explained = pca_results$sdev^2 / sum(pca_results$sdev^2)

#library(ggplot2)
ggplot(data = data.frame( comp = 1:length(var_explained), explained_var = var_explained), aes(y=explained_var, x=comp)) + 
  geom_line() + 
  geom_point() +
  xlab("Principal Component") + 
  ylab("Variance Explained") +
  ggtitle("Elbow Plot") +
  ylim(0, 1)
```

```{r}
ggplot(data.frame(pca_results$rotation),aes(PC1, PC2))+ 
  geom_point()
```

```{r}
fviz_eig(pca_results, addlabels = TRUE)
```

### WF model with logistic NFDS function

```{r}
WF_log <- odin.dust::odin_dust("NFDS_Model_logistic.R")
# copy of WrightFisherModel/WrightFisher_newData_nGenotypes_haploid_PopsizeVariablePois.R
```

#define parameters for the model:
```{r}
log_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, L = 0.3735531590, K = 0.2, x0 = (1-0.3669067334), delta = ggC_inv_delta_ranking, m = 0.0078524723, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v =0.1103623064, vacc_time = 0)
```

### Running the model:
```{r}
WFmodel_log <- WF_log$new(pars = log_ggCPP_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
WFmodel_log$run(72)
```

```{r}
plot(0.1789665082/(1 + exp(- 2 * (ggC_inv_delta_ranking - 1774*0.2))))

# sigma_f, sigma_w step function and possible logistic functions to mimic the values
plot(c(rep(0.0006039627, 1774 * (1-0.3669067334)), rep(0.1789665082, 1774 * 0.3669067334)))
lines(0.1789665082/(1 + exp(- 0.2 * (1:1774 - 1774*(1-0.3669067334)))))
lines(0.1789665082/(1 + exp(- 0.02 * (1:1774 - 1774*(1-0.3669067334)))))
lines(0.1789665082/(1 + exp(- 0.01 * (1:1774 - 1774*(1-0.3669067334)))))

#sigma_f = 0.1789665082, sigma_w = 0.0006039627, prop_f = 0.3669067334
#ggCPP fit results in the following logistic values
ggCPP_log_fit <- 0.11292912/(1 + exp(- 4.95113406 * (1:1774 - 1774*(0.62342733))))
max(ggCPP_log_fit)
plot(ggCPP_log_fit)
length(which(ggCPP_log_fit[which(ggCPP_log_fit<0.99 * max(ggCPP_log_fit))]>0.01))
# so there is just 1 element that has an intermediate value.
# question: do I need the steepness value then?
# is there a similar function that does not need the steepness parameter?
# there is a different definition of the logistic function, which is 1/(1 + exp(-x)), I could use that as 1/(1 + exp(- 1 *(x - x0)) or 1/(1 + exp(x0 - x))
plot(1/(1+exp((1774*(0.62342733)-1:1774))))


# comparison ggC + manSeqCl for step function and logistic function
plot(0.309057542/(1 + exp(- 4.681828437 * (1:1774 - 1774*(0.809096221)))))
lines(c(rep(0.0003669121 , 1774 * (1-0.2161135322)), rep(0.1882242231 , 1774 * 0.2161135322)))

# comparison ggC + PP for step function and logistic function
plot(0.11292912/(1 + exp(- 4.95113406 * (1:1774 - 1774*(0.62342733)))), ylim = c(0, 0.12), main = "Comparison ggCPP for step function and logistic function NFDS", xlab = "Genes", ylab = "Selection Strength")
lines(c(rep(0.0004164005 , 1774 * (1-0.3803173188)), rep(0.1180783495 , 1774 * 0.3803173188)), col = "red")
legend(0, 0.1, legend=c("logistic function", "step function"),
       col=c("black", "red"), lty=1, cex=0.8)
```

```{r}
col_clb <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") #8 colorblind friendly colors

plot(0.11292912/(1+exp(4.95113406 *(1774*(0.62342733)-(1:1774)))), main = "Logistic vs Step Function Model Fit with ggCaller and PopPUNK", xlab = "Genes", ylab = "Selection Strength", col = col_clb[1], ylim = c(0, 0.12), cex = 1)
points(0.1144311/(1+exp((1774*(0.6243419)-(1:1774)))), col = col_clb[2], cex = 1)
points(0.03503935/(1+exp(1 *(1774*(0)-(1:1774)))), col = col_clb[3], cex = 1)
points(0.111690097/(1+exp((1774*(0.624229293)-(1:1774)))) + 0.003764143, col = col_clb[4], cex = 1)
points(c(rep(0.0004164005 , 1774 * (1-0.3803173188)), rep(0.1180783495, 1774 * 0.3803173188)), col = col_clb[5], cex = 1)
points(c(rep(0 , 1774 * (1-0.37657870)), rep(0.11313856, 1774 * 0.37657870)), col = col_clb[6], cex = 1)
points(rep(0.01931485 , 1774 * (1)), col = col_clb[7], cex = 1)
legend(0, 0.12, legend=c("Logistic, 5 params", "Logistic, 4 params", "Logistic, 3 params", "Logistic, Y shift","step function, 5 params", "step function, 4 params", "step function, 3 params"),col=col_clb, lty=1, cex=1.2)
```

```{r}
col_clb <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") #8 colorblind friendly colors

plot(0.11292912/(1+exp(4.95113406 *(1774*(0.62342733)-(1:1774)))), main = "Logistic vs Step Function Model Fit with ggCaller and PopPUNK", xlab = "Genes", ylab = "Selection Strength", col = col_clb[1], ylim = c(0, 0.12), cex = 1)
points(c(rep(0.0004164005 , 1774 * (1-0.3803173188)), rep(0.1180783495, 1774 * 0.3803173188)), col = col_clb[5], cex = 1)

legend(0, 0.12, legend=c("Logistic, 5 params", "step function, 5 params"),col=col_clb, lty=1, cex=1.2)
```

```{r}
col_clb <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") #8 colorblind friendly colors

plot(0.21696863/(1+exp(5.03946007 *(1774*(0.57776473)-(1:1774)))), main = "Logistic vs Step Function Model Fit with COG and PopPUNK", xlab = "Genes", ylab = "Selection Strength", col = col_clb[1], ylim = c(0, 0.22), cex = 1)
points(0.21712951/(1+exp((1774*(0.57739554)-(1:1774)))), col = col_clb[2], cex = 1)
points(0.004120443/(1+exp(1 *(1774*(0)-(1:1774)))), col = col_clb[3], cex = 1)
points(c(rep(0.0006359267 , 1774 * (1-0.4202932608)), rep(0.2169393333, 1774 * 0.4202932608)), col = col_clb[4], cex = 1)
points(c(rep(0 , 1774 * (1-0.4207139)), rep(0.2170153, 1774 * 0.4207139)), col = col_clb[5], cex = 1)
points(rep(0.004034883, 1774 * (1)), col = col_clb[6], cex = 1)
legend(0, 0.12, legend=c("Logistic, 5 params", "Logistic, 4 params", "Logistic, 3 params", "step function, 5 params", "step function, 4 params", "step function, 3 params"),
       col=col_clb, lty=1, cex=0.8)
```


# Likelihood ratio test
#  lambda = -2*(x_1-x_2).
# pvalue_testing_null=1-pchisq(lambda,difference_in_degrees_of_freedom) 
```{r}
LL_4param <- -207.7955
LL_5param <- -207.6401
lambda <- -2 * (LL_4param - LL_5param)
pchisq(lambda, 1,lower.tail = FALSE)

# the model with 5 parameters as compared to the model with 4 parameters is not significantly better
# therefore, having the fifth parameter is not meaningful

#AIC_1 = 2*-207.7955 + 2*4
#AIC_2 = 2*-207.6401 + 2*5
```

```{r}
# Step Function Models (original)
# compare 3-param model to 5-param model
# ggCaller and PopPUNK
step_LL_3param <- -334.3289
step_LL_5param <- -263.4791
step_LL_4param <- -262.268
step_LL_null <- -335.0503
lambda <- -2 * (step_LL_3param - step_LL_5param)
pchisq(lambda, 5-3, lower.tail = FALSE)
# significant!
# the 5-param model is significantly better than the 3-param model
lambda <- -2 * (step_LL_3param - step_LL_4param)
pchisq(lambda, 4-3, lower.tail = FALSE)
# significant!
# the 4-param model is significantly better than the 3-param model
lambda <- -2 * (step_LL_4param - step_LL_5param)
pchisq(lambda, 5-4, lower.tail = FALSE)
# not significant: 5-parameter model not significantly better than 4-parameter model
lambda <- -2 * (step_LL_null - step_LL_3param)
pchisq(lambda, 3-2, lower.tail = FALSE)
# not significant: 3-parameter model not significantly better than 2-parameter model
lambda <- -2 * (step_LL_null - step_LL_4param)
pchisq(lambda, 4-2, lower.tail = FALSE)
# significant: 4-param model better than null model
lambda <- -2 * (step_LL_null - step_LL_5param)
pchisq(lambda, 5-2, lower.tail = FALSE)
# significant: 5-param model better than null model
```


```{r}
# Logistic Function Models
# ggCaller and PopPUNK
log_LL_3param <- -335.3469
log_LL_5param <- -262.2021
log_LL_4param <- -262.2601
log_LL_yshift <- -263.3581 # 5 params
step_LL_null <- -335.0503

lambda <- -2 * (log_LL_3param - log_LL_5param)
pchisq(lambda, 5-3, lower.tail = FALSE)
# significant!
# the 5-param model is significantly better than the 3-param model
lambda <- -2 * (log_LL_3param - log_LL_4param)
pchisq(lambda, 4-3, lower.tail = FALSE)
# significant!
# the 4-param model is significantly better than the 3-param model
lambda <- -2 * (log_LL_4param - log_LL_5param)
pchisq(lambda, 5-4, lower.tail = FALSE)
# not significant: 5-parameter model not significantly better than 4-parameter model
lambda <- -2 * (step_LL_null - log_LL_3param)
pchisq(lambda, 3-2, lower.tail = FALSE)
# not significant: 3-parameter model not significantly better than 2-parameter model
lambda <- -2 * (step_LL_null - log_LL_4param)
pchisq(lambda, 4-2, lower.tail = FALSE)
# significant: 4-param model better than null model
lambda <- -2 * (step_LL_null - log_LL_5param)
pchisq(lambda, 5-2, lower.tail = FALSE)
# significant: 5-param model better than null model

# yshift model:
lambda <- -2 * (log_LL_4param - log_LL_yshift)
pchisq(lambda, 5-4, lower.tail = FALSE)
# yshift model not significantly better than 4-param model
lambda <- -2 * (log_LL_3param - log_LL_yshift)
pchisq(lambda, 5-3, lower.tail = FALSE)
# but yshift model better than 3-param model
lambda <- -2 * (step_LL_null - log_LL_yshift)
pchisq(lambda, 5-2, lower.tail = FALSE)
```

# alternative:
# logistic 3-param model
# == fixing x0=0
# plot(0.305665235/(1+exp(-(1:1774))))


# investigate more details of runs, e.g., effective sample size
```{r}
# path to results: 
results_path_15 <- "/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_04_15/"
# saved_det_mcmc2 <- readRDS(paste(results_path, "xxx.rds",sep=""))
# coda::effectiveSize(saved_det_mcmc2)
COGmanSeqCl_det_mcmc2 <- readRDS(paste(results_path_15, "COGtriangles_manSeqClusters_det_mcmc2.rds",sep=""))
coda::effectiveSize(COGmanSeqCl_det_mcmc2)
# log_prior log_likelihood  log_posterior        sigma_f        sigma_w         prop_f 
#       0.00000      432.48728      432.48728      144.33072      323.82097       70.52254 
#            m              v 
#     525.46322      481.06586 

# effective sample size differs a lot between the parameters!
1 - coda::rejectionRate(COGmanSeqCl_det_mcmc2)
# acceptance rate is good
summary(COGmanSeqCl_det_mcmc2)

combinedchains = mcmc.list(coda::as.mcmc(COGmanSeqCl_det_mcmc2[1:20000,-(1:3)]), coda::as.mcmc(COGmanSeqCl_det_mcmc2[20001:40000,-(1:3)]),coda::as.mcmc(COGmanSeqCl_det_mcmc2[40001:60000,-(1:3)]),coda::as.mcmc(COGmanSeqCl_det_mcmc2[60001:80000,-(1:3)]))
gelman.plot(combinedchains)

combinedchains = mcmc.list(coda::as.mcmc(COGmanSeqCl_det_mcmc2[1001:20000,-(1:3)]), coda::as.mcmc(COGmanSeqCl_det_mcmc2[21001:40000,-(1:3)]),coda::as.mcmc(COGmanSeqCl_det_mcmc2[41001:60000,-(1:3)]),coda::as.mcmc(COGmanSeqCl_det_mcmc2[61001:80000,-(1:3)]))
gelman.plot(combinedchains)

combinedchains = mcmc.list(coda::as.mcmc(COGmanSeqCl_det_mcmc2[5001:20000,-(1:3)]), coda::as.mcmc(COGmanSeqCl_det_mcmc2[25001:40000,-(1:3)]),coda::as.mcmc(COGmanSeqCl_det_mcmc2[45001:60000,-(1:3)]),coda::as.mcmc(COGmanSeqCl_det_mcmc2[65001:80000,-(1:3)]))
gelman.plot(combinedchains)

parameter_mean_hpd <- apply(COGmanSeqCl_det_mcmc2[c(5001:20000,25001:40000,45001:60000,65001:80000),-(1:3)], 2, mean)
parameter_mean_hpd
```

```{r}
COGPP_det_mcmc2 <- readRDS(paste(results_path_15, "COGtriangles_PopPUNK_det_mcmc2.rds",sep=""))
coda::effectiveSize(COGPP_det_mcmc2)
# much better effective sample size!
1 - coda::rejectionRate(COGPP_det_mcmc2)

combinedchains = mcmc.list(coda::as.mcmc(COGPP_det_mcmc2[1:20000,-(1:3)]), coda::as.mcmc(COGPP_det_mcmc2[20001:40000,-(1:3)]),coda::as.mcmc(COGPP_det_mcmc2[40001:60000,-(1:3)]),coda::as.mcmc(COGPP_det_mcmc2[60001:80000,-(1:3)]))
gelman.plot(combinedchains)

combinedchains = mcmc.list(coda::as.mcmc(COGPP_det_mcmc2[1001:20000,-(1:3)]), coda::as.mcmc(COGPP_det_mcmc2[21001:40000,-(1:3)]),coda::as.mcmc(COGPP_det_mcmc2[41001:60000,-(1:3)]),coda::as.mcmc(COGPP_det_mcmc2[61001:80000,-(1:3)]))
gelman.plot(combinedchains)

parameter_mean_hpd <- apply(COGPP_det_mcmc2[,-(1:3)], 2, mean)
parameter_mean_hpd

parameter_mean_hpd <- apply(COGPP_det_mcmc2[c(14001:20000, 34001:40000, 54001:60000, 74001:80000),-(1:3)], 2, mean)
parameter_mean_hpd

# maybe thinning
#COGPP_det_mcmc2_thinned <- coda::mcmc(COGPP_det_mcmc2, thin = 2)
```

```{r}
ggCmanSeqCl_det_mcmc2 <- readRDS(paste(results_path_15, "ggCaller_manSeqClusters_det_mcmc2.rds",sep=""))
coda::effectiveSize(ggCmanSeqCl_det_mcmc2)
# effective sample size better than COGmanSeqCl but could be better
1 - coda::rejectionRate(ggCmanSeqCl_det_mcmc2)

combinedchains = mcmc.list(coda::as.mcmc(ggCmanSeqCl_det_mcmc2[1001:20000,-(1:3)]), coda::as.mcmc(ggCmanSeqCl_det_mcmc2[21001:40000,-(1:3)]),coda::as.mcmc(ggCmanSeqCl_det_mcmc2[41001:60000,-(1:3)]),coda::as.mcmc(ggCmanSeqCl_det_mcmc2[61001:80000,-(1:3)]))
gelman.plot(combinedchains)
```

```{r}
ggCPP_det_mcmc2 <- readRDS(paste(results_path_15, "ggCaller_PopPUNK_det_mcmc2.rds",sep=""))
coda::effectiveSize(ggCPP_det_mcmc2)
# effective sample size better than COGmanSeqCl but could be better
1 - coda::rejectionRate(ggCPP_det_mcmc2)

combinedchains = coda::mcmc.list(coda::as.mcmc(ggCPP_det_mcmc2[5001:20000,-(1:3)]), coda::as.mcmc(ggCPP_det_mcmc2[25001:40000,-(1:3)]),coda::as.mcmc(ggCPP_det_mcmc2[45001:60000,-(1:3)]),coda::as.mcmc(ggCPP_det_mcmc2[65001:80000,-(1:3)]))
gelman.plot(combinedchains)

parameter_mean_hpd <- apply(ggCPP_det_mcmc2[c(1001:20000, 21001:40000, 41001:60000, 61001:80000),-(1:3)], 2, mean)
parameter_mean_hpd
mean(ggCPP_det_mcmc2[c(1001:20000, 21001:40000, 41001:60000, 61001:80000),2])

parameter_mean_hpd <- apply(ggCPP_det_mcmc2[c(5001:20000, 25001:40000, 45001:60000, 65001:80000),-(1:3)], 2, mean)
parameter_mean_hpd
mean(ggCPP_det_mcmc2[c(5001:20000, 25001:40000, 45001:60000, 65001:80000),2])


plot(coda::as.mcmc(ggCPP_det_mcmc2[1001:20000,]))
lines(coda::as.mcmc(ggCPP_det_mcmc2[21001:40000,]))

coda::autocorr.plot(ggCPP_det_mcmc2)


library(tigerstats)
combinedchains2 = coda::mcmc.list(coda::as.mcmc(ggCPP_det_mcmc2[1001:20000,-c(1,3)]), coda::as.mcmc(ggCPP_det_mcmc2[21001:40000,-c(1,3)]),coda::as.mcmc(ggCPP_det_mcmc2[41001:60000,-c(1,3)]),coda::as.mcmc(ggCPP_det_mcmc2[61001:80000,-c(1,3)]))
xyplot(combinedchains2)

```

### Log models
```{r}
# 5 params
results_path <- "/Users/llorenz/Documents/PhD_Project/Code/1st_project/WF_plots_postTAC/2024_04_16/"
log_ggCPP_pmcmc2 <- readRDS(paste(results_path, "ggCaller_PopPUNK_log_det_pmcmc_run2.rds",sep=""))
log_ggCPP_det_mcmc2 <- coda::as.mcmc(cbind(log_ggCPP_pmcmc2$probabilities, log_ggCPP_pmcmc2$pars))
coda::effectiveSize(log_ggCPP_det_mcmc2)
# much better effective sample size!
1 - coda::rejectionRate(log_ggCPP_det_mcmc2)

combinedchains = mcmc.list(coda::as.mcmc(log_ggCPP_det_mcmc2[1001:20000,-(1:3)]), coda::as.mcmc(log_ggCPP_det_mcmc2[21001:40000,-(1:3)]),coda::as.mcmc(log_ggCPP_det_mcmc2[41001:60000,-(1:3)]),coda::as.mcmc(log_ggCPP_det_mcmc2[61001:80000,-(1:3)]))
gelman.plot(combinedchains)

combinedchains = mcmc.list(coda::as.mcmc(log_ggCPP_det_mcmc2[5001:20000,-(1:3)]), coda::as.mcmc(log_ggCPP_det_mcmc2[25001:40000,-(1:3)]),coda::as.mcmc(log_ggCPP_det_mcmc2[45001:60000,-(1:3)]),coda::as.mcmc(log_ggCPP_det_mcmc2[65001:80000,-(1:3)]))
gelman.plot(combinedchains)

processed_chains <- mcstate::pmcmc_thin(log_ggCPP_pmcmc2, burnin = 5000, thin = 1)
parameter_mean_hpd <- apply(processed_chains$pars, 2, mean)
parameter_mean_hpd

# 4 params
log4_ggCPP_pmcmc2 <- readRDS(paste(results_path, "ggCaller_PopPUNK_log4_det_pmcmc_run2.rds",sep=""))
log4_ggCPP_det_mcmc2 <- coda::as.mcmc(cbind(log4_ggCPP_pmcmc2$probabilities, log4_ggCPP_pmcmc2$pars))
coda::effectiveSize(log4_ggCPP_det_mcmc2)
# much better effective sample size!
1 - coda::rejectionRate(log4_ggCPP_det_mcmc2)

combinedchains = mcmc.list(coda::as.mcmc(log4_ggCPP_det_mcmc2[1001:20000,-(1:3)]), coda::as.mcmc(log4_ggCPP_det_mcmc2[21001:40000,-(1:3)]),coda::as.mcmc(log4_ggCPP_det_mcmc2[41001:60000,-(1:3)]),coda::as.mcmc(log4_ggCPP_det_mcmc2[61001:80000,-(1:3)]))
gelman.plot(combinedchains)

combinedchains = mcmc.list(coda::as.mcmc(log4_ggCPP_det_mcmc2[5001:20000,-(1:3)]), coda::as.mcmc(log4_ggCPP_det_mcmc2[25001:40000,-(1:3)]),coda::as.mcmc(log4_ggCPP_det_mcmc2[45001:60000,-(1:3)]),coda::as.mcmc(log4_ggCPP_det_mcmc2[65001:80000,-(1:3)]))
gelman.plot(combinedchains)

processed_chains <- mcstate::pmcmc_thin(log4_ggCPP_pmcmc2, burnin = 5000, thin = 2)
parameter_mean_hpd <- apply(processed_chains$pars, 2, mean)
parameter_mean_hpd

library(tigerstats)
log_combinedchains2 = coda::mcmc.list(coda::as.mcmc(log_ggCPP_det_mcmc2[1001:20000,-c(1,3)]), coda::as.mcmc(log_ggCPP_det_mcmc2[21001:40000,-c(1,3)]),coda::as.mcmc(log_ggCPP_det_mcmc2[41001:60000,-c(1,3)]),coda::as.mcmc(log_ggCPP_det_mcmc2[61001:80000,-c(1,3)]))
xyplot(log_combinedchains2)
```


# Visualise Serotype Cluster composition
```{r}
# how to get from manual sequence clusters to serotypes: (example for cluster 0)
unique(Mass_Samples_accCodes$Serotype[which(Mass_Samples_accCodes$SequenceCluster==0)])
# how to get from PP clusters to manual sequence clusters
PP_to_manSeq_dict
# usage together e.g.
unique(Mass_Samples_accCodes$Serotype[which(Mass_Samples_accCodes$SequenceCluster==PP_to_manSeq_dict[1])])


#PP_serotype_comp <- list()
#for (i in 1:PP_mass_clusters) {
#  PP_serotype_comp[[i]] <- unique(Mass_Samples_accCodes$Serotype[which(Mass_Samples_accCodes$SequenceCluster==PP_to_manSeq_dict[i])])
#}

#PP_serotype_comp <- rep(0,PP_mass_clusters)
#for (i in 1:PP_mass_clusters) {
#  PP_serotype_comp[i] <- paste(unique(Mass_Samples_accCodes$Serotype[which(Mass_Samples_accCodes$SequenceCluster==PP_to_manSeq_dict[i])]), collapse = ", ")
#}


### not necessary anymore, I added the Serotype information to the PopPUNK data frame

# use this instead:
#unique(PopPUNK_clusters$Serotype[which(PopPUNK_clusters$Cluster==1)])
PP_serotype_comp <- rep(0,PP_mass_clusters)
for (i in 1:PP_mass_clusters) {
  PP_serotype_comp[i] <- paste(unique(PopPUNK_clusters$Serotype[which(PopPUNK_clusters$Cluster==i)]), collapse = ", ")
}
```

```{r}
source("CreateLollipopPlot.R")


# ggCPP fit (step function model)
### ggCaller PopPUNK
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.1133391187, sigma_w = 0.0003826182, prop_f = 0.3803189582, delta = ggC_delta_ranking, m = 0.0108386117, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1441624728, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = PP_model_start_pop/sum(PP_model_start_pop), PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2/sum(simMeanggCPP2), PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), PP_mass_VT, SeroLabel = PP_serotype_comp)
```

```{r}
# ggCPP fit (logistic function model)
WF_log <- odin.dust::odin_dust("NFDS_Model_logistic.R")
log_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, L = 0.11292912, K = 4.95113406
, x0 = 0.62342733, delta = ggC_inv_delta_ranking, m = 0.01107836, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v =0.14464825, vacc_time = 0)
logWFmodel_ggCPP <- WF_log$new(pars = log_ggCPP_params,
                                   time = 1,
                                   n_particles = 10L,
                                   n_threads = 4L,
                                   seed = 1L)
simMeanggCPP2_log <- rowMeans(logWFmodel_ggCPP$run(36)[-1,])
simMeanggCPP3_log <- rowMeans(logWFmodel_ggCPP$run(72)[-1,])

lollipop_cluster_freqs_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = PP_model_start_pop/sum(PP_model_start_pop), PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2_log/sum(simMeanggCPP2_log), PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3_log/sum(simMeanggCPP3_log), PP_mass_VT, SeroLabel = PP_serotype_comp)

#combined_compare(simMeanggCPP2_log,PP_mass_cluster_freq_2) + combined_compare(simMeanggCPP3_log,PP_mass_cluster_freq_3)
#combined_compare(simMeanggCPP2,PP_mass_cluster_freq_2) + combined_compare(simMeanggCPP3,PP_mass_cluster_freq_3)
```

```{r}
lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "2001", plot_title = "PopPUNK and ggCaller", data_name = "Data", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Step Function", model1 = PP_model_start_pop/sum(PP_model_start_pop), model_name_2 ="Logistic Function", model2 = PP_model_start_pop/sum(PP_model_start_pop), PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "2004", plot_title = "PopPUNK and ggCaller", data_name = "Data", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Step Function", model1 = simMeanggCPP2/sum(simMeanggCPP2), model_name_2 ="Logistic Function", model2 = simMeanggCPP2_log/sum(simMeanggCPP2_log), PP_mass_VT, SeroLabel = PP_serotype_comp)
lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "2007", plot_title = "PopPUNK and ggCaller", data_name = "Data", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Step Function", model1 = simMeanggCPP3/sum(simMeanggCPP3), model_name_2 ="Logistic Function", model2 = simMeanggCPP3_log/sum(simMeanggCPP3_log), PP_mass_VT, SeroLabel = PP_serotype_comp)

```

```{r}
lollipop_cluster_freqs_2x2_VTandNVT_labelSero(year = "all time points", plot_title = "Data only", data_name = "2001", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="2004", model1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_2 ="2007", model2 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), PP_mass_VT, SeroLabel = PP_serotype_comp)
```

```{r}
# think about delta again
# logistic fit doesn't seem to make much sense
# think about using x^3 or so again (and try to find notes from ~ 22nd of August)
plot(sort(ggC_delta_data3)[1:1500])
lines(((0:200)/10000)^3)
0.2

delta_df <- data.frame(cbind(1:length(ggC_delta_data3), sort(ggC_delta_data3)))

lm(log(X2) ~ X1, data = delta_df)

plot(log(sort(ggC_delta_data3)))
lines(-10.338049 + 0.004083 * (1:length(ggC_delta_data3)))

plot((sort(ggC_delta_data3)))
lines(exp(-10.338049 + 0.004083 *  (1:length(ggC_delta_data3))), col = "red")

plot(((ggC_delta_data3)))
points(exp(-10.338049 + 0.004083 *  ((ggC_delta_ranking))), col = "red")

plot((1 + (ggC_delta_data3)), ylim = c(1,1.01))
points(1 + exp(-10.338049 + 0.004083 *  ((ggC_delta_ranking))), col = "red")
points((1 + (3.237743e-05 * exp(0.004083 *  ((ggC_delta_ranking))))), col = "blue")

# this is a fit that replicates the variation
# but I basically want the invers because the more variation the less selection
# can I just use the ggC_inv_delta_ranking?

# the logistic model for comparison:
#points((0.11292912 / (1 + exp(-1 * (ggC_delta_ranking - 0.62342733 * length(ggC_delta_data3))))), col = "blue")
#points((1 / (1 + exp(-1 * (ggC_delta_ranking - 0.62342733 * length(ggC_delta_data3))))), col = "blue")

plot(((ggC_delta_data3)))
points(exp(-10.338049 + 0.004083 *  ((ggC_delta_ranking))), col = "red")

plot((sort(0.5 - ggC_delta_data3)))
points(sort(0.5 - exp(-10.338049 + 0.004083 *  ((ggC_delta_ranking)))), col = "red")
```

# for future reference: (1+L)^... is an approcimation (?) of (1+L)/(1+exp...)
# plot(1 + (0.11292912 / (1 + exp(-1 * (ggC_delta_ranking - 0.62342733 * length(ggC_delta_data3))))), col = "red")
# points((1+0.11292912)^(1 / (1 + exp(-1 * (ggC_delta_ranking - 0.62342733 * length(ggC_delta_data3))))), col = "blue")

### WF model with logistic NFDS function

```{r}
WF_exp <- odin.dust::odin_dust("NFDS_Model_exp.R")
# copy of WrightFisherModel/WrightFisher_newData_nGenotypes_haploid_PopsizeVariablePois.R
```

#define parameters for the model:
```{r}
exp_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, L = 0, x0 = -10, K = 0.004, delta = ggC_delta_ranking, m = 0.0078524723, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v =0.1103623064, vacc_time = 0)
```

### Running the model:
```{r}
WFmodel_exp <- WF_exp$new(pars = exp_ggCPP_params,
                         time = 1,
                         n_particles = 10L,
                         n_threads = 4L,
                         seed = 1L)
```

```{r}
WFmodel_exp$run(2)
```




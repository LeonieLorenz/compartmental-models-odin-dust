WFmodel_PP <- WF_nG_h_vP$new(pars = all_params,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
simMeanPP2 <- rowMeans(WFmodel_PP$run(36)[-1,])
simMeanPP3 <- rowMeans(WFmodel_PP$run(72)[-1,])
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanPP3/sum(simMeanPP3)))
# [1] 0.650785
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanPP3/sum(simMeanPP3))) + sum(abs(PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2) - simMeanPP2/sum(simMeanPP2)))
### ggCaller man seq clusters
params_ggC <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(ggC_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = ggC_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.01006930, sigma_w = 0, prop_f = 1, delta = ggC_delta_ranking, m = 0.01635317, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.08659896, vacc_time = 0)
WFmodel_ggCmanSeqCl <- WF_nG_h_vP$new(pars = params_ggC,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
simMeanggC2 <- rowMeans(WFmodel_ggCmanSeqCl$run(36)[-1,])
simMeanggC3 <- rowMeans(WFmodel_ggCmanSeqCl$run(72)[-1,])
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMeanggC3/sum(simMeanggC3)))
# [1] 0.5759087
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMeanggC3/sum(simMeanggC3))) + sum(abs(mass_cluster_freq_2/sum(mass_cluster_freq_2) - simMeanggC2/sum(simMeanggC2)))
### ggCaller PopPUNK
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.01931485, sigma_w = 0, prop_f = 1, delta = ggC_delta_ranking, m = 0.03104461, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.15977862, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3)))
# [1] 0.6169782
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3))) + sum(abs(PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2) - simMeanggCPP2/sum(simMeanggCPP2)))
prev_mass_cluster_freq_1 <- readRDS(file = "prev_mass_cluster_freq_1.rds")
prev_mass_cluster_freq_1
mass_cluster_freq_1
c616_mass_cluster_freq_1 <- readRDS("mass_seq_freq_1.rds")
c616_mass_cluster_freq_2 <- readRDS(file = "mass_seq_freq_2.rds")
c616_mass_cluster_freq_3 <- readRDS(file = "mass_seq_freq_3.rds")
length(c616_mass_cluster_freq_3)
c616_intermed_gene_presence_absence_consensus <- readRDS("intermed_gene_presence_absence.rds")
c616_intermed_gene_presence_absence_consensus_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
c616_intermed_gene_presence_absence <- readRDS("intermed_gene_presence_absence.rds")
c616_intermed_gene_presence_absence_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
delta_ranking <- readRDS(file = "prev_delta_ranking.rds")
length(delta_ranking)
length(delta_ranking)
prev_intermed_gene_presence_absence_consensus <- readRDS(file = "prev_mass_consensus_presence_absence.rds")
dim(prev_intermed_gene_presence_absence_consensus)
dim(intermed_gene_presence_absence_consensus)
dim(PP_intermed_gene_presence_absence_consensus)
prev_delta_ranking <- readRDS(file = "prev_delta_ranking.rds")
dim(prev_delta_ranking)
prev_delta_ranking <- readRDS(file = "prev_delta_ranking.rds")
length(prev_delta_ranking)
delta_ranking <- readRDS(file = "delta_ranking.rds")
length(delta_ranking)
prev_intermed_gene_presence_absence_consensus <- readRDS(file = "prev_mass_consensus_presence_absence.rds")
prev_intermed_gene_presence_absence_consensus_matrix <- sapply(prev_intermed_gene_presence_absence_consensus[,-1],as.double)
prev_delta_ranking <- readRDS(file = "prev_delta_ranking.rds")
View(prev_intermed_gene_presence_absence_consensus)
View(intermed_gene_presence_absence_consensus)
prev_intermed_gene_presence_absence_consensus <- readRDS(file = "prev_mass_consensus_presence_absence.rds")
prev_intermed_gene_presence_absence_consensus_matrix <- sapply(prev_intermed_gene_presence_absence_consensus[,-1],as.double)
prev_delta_ranking <- readRDS(file = "prev_delta_ranking.rds")
prev_intermed_gene_presence_absence_consensus <- readRDS(file = "prev_mass_consensus_presence_absence.rds")
prev_intermed_gene_presence_absence_consensus_matrix <- sapply(prev_intermed_gene_presence_absence_consensus[,-1],as.double)
prev_delta_ranking <- readRDS(file = "prev_delta_ranking.rds")
#define parameters for the model:
```{r}
### Running the model:
```{r}
prev_params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(prev_intermed_gene_presence_absence_consensus), Pop_ini = as.double(model_start_pop), Pop_eq = as.double(model_start_pop), capacity = sum(model_start_pop), Genotypes = prev_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.2193191513, sigma_w = 0.0007111157, prop_f = 0.3735531590, delta = prev_delta_ranking, m = 0.0052207254, migVec = avg_cluster_freq, vaccTypes = mass_VT, v = 0.1321567425, vacc_time = 0)
prev_WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = prev_params_n_vP,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
c616_mass_cluster_freq_1 <- readRDS("mass_seq_freq_1.rds")
c616_mass_cluster_freq_2 <- readRDS(file = "mass_seq_freq_2.rds")
c616_mass_cluster_freq_3 <- readRDS(file = "mass_seq_freq_3.rds")
c616_intermed_gene_presence_absence <- readRDS("intermed_gene_presence_absence.rds")
c616_intermed_gene_presence_absence_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
seq_model_start_pop <- readRDS("seq_model_start_pop.rds")
man_mass_clusters <- length(unique(seq_clusters$SequenceCluster))
mass_clusters2 <- length(unique(seq_clusters$SequenceCluster))
# summarize single-sequence clusters into PP clusters
sum_seq_man_clusters <- function(sequence_clust){
clustered_seqs <- rep(0, man_mass_clusters)
for (i in 1:man_mass_clusters) {
clustered_seqs[i] <- sum(sequence_clust[which(seq_clusters$SequenceCluster==i)])
}
clustered_seqs
}
#observed will be the mass_cluster_freq_2 and _3, not the c616 one
combined_compare_616 <- function(state, observed, pars = NULL) {
result <- 0
data_size <- sum(unlist(observed))
model_size = sum(unlist(state))
# need to summarize the data and the observations into clusters
clustered_state <- sum_seq_man_clusters(unlist(state))
for (i in 1:man_mass_clusters){
result <- result + ll_pois(observed[[as.character(i)]], clustered_state[i]/model_size * data_size)
}
result
}
mass_seq_VT <- readRDS("mass_seq_VT.rds")
# COG man seq clusters
seq_clusters <- readRDS("Mass_Samples_accCodes.rds")
mass_clusters <- nrow(seq_clusters)
avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)
c616_params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(c616_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = c616_intermed_gene_presence_absence_matrix, sigma_f = 0.20840945, sigma_w = 0.02772616, prop_f = 0.90395014, delta = delta_ranking, m = 0.17328677, migVec = avg_cluster_freq, vaccTypes = mass_seq_VT, v = 0.42626268, vacc_time = 0)
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = c616_params_n_vP,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
mass_seq_VT
mass_VT
avg_cluster_freq
c616_mass_cluster_freq_1 <- readRDS("mass_seq_freq_1.rds")
c616_mass_cluster_freq_2 <- readRDS(file = "mass_seq_freq_2.rds")
c616_mass_cluster_freq_3 <- readRDS(file = "mass_seq_freq_3.rds")
c616_intermed_gene_presence_absence <- readRDS("intermed_gene_presence_absence.rds")
c616_intermed_gene_presence_absence_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
seq_model_start_pop <- readRDS("seq_model_start_pop.rds")
mass_seq_VT <- readRDS("mass_seq_VT.rds")
man_mass_clusters <- length(unique(seq_clusters$SequenceCluster))
mass_clusters2 <- length(unique(seq_clusters$SequenceCluster))
# summarize single-sequence clusters into PP clusters
sum_seq_man_clusters <- function(sequence_clust){
clustered_seqs <- rep(0, man_mass_clusters)
for (i in 1:man_mass_clusters) {
clustered_seqs[i] <- sum(sequence_clust[which(seq_clusters$SequenceCluster==i)])
}
clustered_seqs
}
#observed will be the mass_cluster_freq_2 and _3, not the c616 one
combined_compare_616 <- function(state, observed, pars = NULL) {
result <- 0
data_size <- sum(unlist(observed))
model_size = sum(unlist(state))
# need to summarize the data and the observations into clusters
clustered_state <- sum_seq_man_clusters(unlist(state))
for (i in 1:man_mass_clusters){
result <- result + ll_pois(observed[[as.character(i)]], clustered_state[i]/model_size * data_size)
}
result
}
# COG man seq clusters
seq_clusters <- readRDS("Mass_Samples_accCodes.rds")
mass_clusters <- nrow(seq_clusters)
avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)
c616_params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(c616_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = c616_intermed_gene_presence_absence_matrix, sigma_f = 0.20840945, sigma_w = 0.02772616, prop_f = 0.90395014, delta = delta_ranking, m = 0.17328677, migVec = avg_cluster_freq, vaccTypes = mass_seq_VT, v = 0.42626268, vacc_time = 0)
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = c616_params_n_vP,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
seq_model_start_pop
model_start_pop
nrow(seq_clusters)
c616_params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(c616_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = c616_intermed_gene_presence_absence_matrix, sigma_f = 0.20840945, sigma_w = 0.02772616, prop_f = 0.90395014, delta = as.double(delta_ranking), m = 0.17328677, migVec = as.double(avg_cluster_freq), vaccTypes = as.double(mass_seq_VT), v = 0.42626268, vacc_time = 0)
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = c616_params_n_vP,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
dim(c616_intermed_gene_presence_absence_matrix)
c616_intermed_gene_presence_absence <- readRDS("intermed_gene_presence_absence.rds")
c616_intermed_gene_presence_absence_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
dim(c616_intermed_gene_presence_absence_matrix)
# read in gene presence absence matrix
gene_presence_absence <- readRDS(file = "gene_presence_absence.rds")
dim(gene_presence_absence)
# create time-point specific gene presence absence matrices
Mass_year_dict <- c(rep(2001,length(Mass_Samples_accCodes[Mass_Samples_accCodes$`Year of Isolation`==2001,]$`Isolate Name`)),
rep(2004,length(Mass_Samples_accCodes[Mass_Samples_accCodes$`Year of Isolation`==2004,]$`Isolate Name`)),
rep(2007,length(Mass_Samples_accCodes[Mass_Samples_accCodes$`Year of Isolation`==2007,]$`Isolate Name`)))
names(Mass_year_dict) <- c(Mass_Samples_accCodes[Mass_Samples_accCodes$`Year of Isolation`==2001,]$`Isolate Name`, Mass_Samples_accCodes[Mass_Samples_accCodes$`Year of Isolation`==2004,]$`Isolate Name`, Mass_Samples_accCodes[Mass_Samples_accCodes$`Year of Isolation`==2007,]$`Isolate Name`)
# empty gene presence absence matrix
gene_presence_absence_2001 <- data.frame(matrix(0, nrow = length(cls_files)+1, ncol = length(Mass_Samples_accCodes[Mass_Samples_accCodes$`Year of Isolation`==2001,]$`Isolate Name`)+1))
gene_presence_absence_2001[1,-1] <- (Mass_Samples_accCodes[Mass_Samples_accCodes$`Year of Isolation`==2001,]$`Isolate Name`)
gene_presence_absence_2001[-1,1] <- gene_presence_absence[-1,1]
gene_presence_absence_2001[-1,-1] <- gene_presence_absence[-1,c(FALSE,Mass_year_dict[unlist(gene_presence_absence[1,-1])]==2001)]
gene_presence_absence_2004 <- data.frame(matrix(0, nrow = length(cls_files)+1, ncol = length(Mass_Samples_accCodes[Mass_Samples_accCodes$`Year of Isolation`==2004,]$`Isolate Name`)+1))
gene_presence_absence_2004[1,-1] <- (Mass_Samples_accCodes[Mass_Samples_accCodes$`Year of Isolation`==2004,]$`Isolate Name`)
gene_presence_absence_2004[-1,1] <- gene_presence_absence[-1,1]
gene_presence_absence_2004[-1,-1] <- gene_presence_absence[-1,c(FALSE,Mass_year_dict[unlist(gene_presence_absence[1,-1])]==2004)]
gene_presence_absence_2007 <- data.frame(matrix(0, nrow = length(cls_files)+1, ncol = length(Mass_Samples_accCodes[Mass_Samples_accCodes$`Year of Isolation`==2007,]$`Isolate Name`)+1))
gene_presence_absence_2007[1,-1] <- (Mass_Samples_accCodes[Mass_Samples_accCodes$`Year of Isolation`==2007,]$`Isolate Name`)
gene_presence_absence_2007[-1,1] <- gene_presence_absence[-1,1]
gene_presence_absence_2007[-1,-1] <- gene_presence_absence[-1,c(FALSE,Mass_year_dict[unlist(gene_presence_absence[1,-1])]==2007)]
# Find intermediate frequency genes in 2001 data set
# compute gene frequencies
sum_as_int <- function(x){
sum(as.integer(x))
}
gene_freq_2001 <- rep(0, nrow(gene_presence_absence_2001)-1)
gene_freq_2001 <- apply(gene_presence_absence_2001[-1,-1],1, sum_as_int)
gene_freq_2001 <- gene_freq_2001 / (length(gene_presence_absence_2001[1,-1]))
cog_filter <- as.integer(gene_freq_2001<=0.95 & gene_freq_2001>=0.05)
# intermediate gene presence absence matrices filtered by genes that are present at 5-95% frequency in 2001
intermed_gene_presence_absence_2001 <- data.frame(matrix(0, nrow = sum(cog_filter)+1, ncol = length(Mass_Samples_accCodes[Mass_Samples_accCodes$`Year of Isolation`==2001,]$`Isolate Name`)+1))
intermed_gene_presence_absence_2001 <- gene_presence_absence_2001[c(1,which(cog_filter==1)+1),]
intermed_gene_presence_absence_2004 <- data.frame(matrix(0, nrow = sum(cog_filter)+1, ncol = length(Mass_Samples_accCodes[Mass_Samples_accCodes$`Year of Isolation`==2004,]$`Isolate Name`)+1))
intermed_gene_presence_absence_2004 <- gene_presence_absence_2004[c(1,which(cog_filter==1)+1),]
intermed_gene_presence_absence_2007 <- data.frame(matrix(0, nrow = sum(cog_filter)+1, ncol = length(Mass_Samples_accCodes[Mass_Samples_accCodes$`Year of Isolation`==2007,]$`Isolate Name`)+1))
intermed_gene_presence_absence_2007 <- gene_presence_absence_2007[c(1,which(cog_filter==1)+1),]
intermed_gene_presence_absence <- data.frame(matrix(0, nrow = sum(cog_filter)+1, ncol = length(Mass_Samples_accCodes$`Isolate Name`)+1))
intermed_gene_presence_absence <- gene_presence_absence[c(1,which(cog_filter==1)+1),]
dim(intermed_gene_presence_absence)
#save intermed gene presence absence matrices
saveRDS(intermed_gene_presence_absence, file = "intermed_gene_presence_absence.rds")
#save intermed gene presence absence matrices
saveRDS(intermed_gene_presence_absence, file = "intermed_gene_presence_absence.rds")
saveRDS(intermed_gene_presence_absence_2001, file = "intermed_gene_presence_absence_2001.rds")
saveRDS(intermed_gene_presence_absence_2004, file = "intermed_gene_presence_absence_2004.rds")
saveRDS(intermed_gene_presence_absence_2007, file = "intermed_gene_presence_absence_2007.rds")
c616_mass_cluster_freq_1 <- readRDS("mass_seq_freq_1.rds")
c616_mass_cluster_freq_2 <- readRDS(file = "mass_seq_freq_2.rds")
c616_mass_cluster_freq_3 <- readRDS(file = "mass_seq_freq_3.rds")
c616_intermed_gene_presence_absence <- readRDS("intermed_gene_presence_absence.rds")
c616_intermed_gene_presence_absence_matrix <- sapply(intermed_gene_presence_absence_consensus[-1,-1],as.double)
seq_model_start_pop <- readRDS("seq_model_start_pop.rds")
mass_seq_VT <- readRDS("mass_seq_VT.rds")
man_mass_clusters <- length(unique(seq_clusters$SequenceCluster))
mass_clusters2 <- length(unique(seq_clusters$SequenceCluster))
# summarize single-sequence clusters into PP clusters
sum_seq_man_clusters <- function(sequence_clust){
clustered_seqs <- rep(0, man_mass_clusters)
for (i in 1:man_mass_clusters) {
clustered_seqs[i] <- sum(sequence_clust[which(seq_clusters$SequenceCluster==i)])
}
clustered_seqs
}
#observed will be the mass_cluster_freq_2 and _3, not the c616 one
combined_compare_616 <- function(state, observed, pars = NULL) {
result <- 0
data_size <- sum(unlist(observed))
model_size = sum(unlist(state))
# need to summarize the data and the observations into clusters
clustered_state <- sum_seq_man_clusters(unlist(state))
for (i in 1:man_mass_clusters){
result <- result + ll_pois(observed[[as.character(i)]], clustered_state[i]/model_size * data_size)
}
result
}
# COG man seq clusters
seq_clusters <- readRDS("Mass_Samples_accCodes.rds")
mass_clusters <- nrow(seq_clusters)
avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)
c616_params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(c616_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = c616_intermed_gene_presence_absence_matrix, sigma_f = 0.20840945, sigma_w = 0.02772616, prop_f = 0.90395014, delta = as.double(delta_ranking), m = 0.17328677, migVec = as.double(avg_cluster_freq), vaccTypes = as.double(mass_seq_VT), v = 0.42626268, vacc_time = 0)
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = c616_params_n_vP,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
View(c616_intermed_gene_presence_absence)
dim(c616_intermed_gene_presence_absence)
dim(c616_intermed_gene_presence_absence_matrix)
c616_intermed_gene_presence_absence <- readRDS("intermed_gene_presence_absence.rds")
c616_intermed_gene_presence_absence_matrix <- sapply(c616_intermed_gene_presence_absence[-1,-1],as.double)
seq_model_start_pop <- readRDS("seq_model_start_pop.rds")
mass_seq_VT <- readRDS("mass_seq_VT.rds")
man_mass_clusters <- length(unique(seq_clusters$SequenceCluster))
mass_clusters2 <- length(unique(seq_clusters$SequenceCluster))
# summarize single-sequence clusters into PP clusters
sum_seq_man_clusters <- function(sequence_clust){
clustered_seqs <- rep(0, man_mass_clusters)
for (i in 1:man_mass_clusters) {
clustered_seqs[i] <- sum(sequence_clust[which(seq_clusters$SequenceCluster==i)])
}
clustered_seqs
}
#observed will be the mass_cluster_freq_2 and _3, not the c616 one
combined_compare_616 <- function(state, observed, pars = NULL) {
result <- 0
data_size <- sum(unlist(observed))
model_size = sum(unlist(state))
# need to summarize the data and the observations into clusters
clustered_state <- sum_seq_man_clusters(unlist(state))
for (i in 1:man_mass_clusters){
result <- result + ll_pois(observed[[as.character(i)]], clustered_state[i]/model_size * data_size)
}
result
}
for (i in 1:man_mass_clusters){
result <- result + ll_pois(observed[[as.character(i)]], clustered_state[i]/model_size * data_size)
}
```{r}
# COG man seq clusters
seq_clusters <- readRDS("Mass_Samples_accCodes.rds")
mass_clusters <- nrow(seq_clusters)
avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)
c616_params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(c616_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = c616_intermed_gene_presence_absence_matrix, sigma_f = 0.20840945, sigma_w = 0.02772616, prop_f = 0.90395014, delta = as.double(delta_ranking), m = 0.17328677, migVec = as.double(avg_cluster_freq), vaccTypes = as.double(mass_seq_VT), v = 0.42626268, vacc_time = 0)
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = c616_params_n_vP,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
simMean2 <- rowMeans(WFmodel_nG_h_vP$run(36)[-1,])
simMean3 <- rowMeans(WFmodel_nG_h_vP$run(72)[-1,])
sum(abs(mass_cluster_freq_3/sum(mass_cluster_freq_3) - simMean3/sum(simMean3)))
combined_compare_616(simMean2,mass_cluster_freq_2) + combined_compare_616(simMean3,mass_cluster_freq_3)
length(simMean2)
length(mass_cluster_freq_2)
man_mass_clusters
mass_cluster_freq_2[41]
#observed will be the mass_cluster_freq_2 and _3, not the c616 one
combined_compare_616 <- function(state, observed, pars = NULL) {
result <- 0
data_size <- sum(unlist(observed))
model_size = sum(unlist(state))
# need to summarize the data and the observations into clusters
clustered_state <- sum_seq_man_clusters(unlist(state))
for (i in 1:mass_clusters){
result <- result + ll_pois(observed[i], clustered_state[i]/model_size * data_size)
}
result
}
combined_compare_616(simMean2,mass_cluster_freq_2) + combined_compare_616(simMean3,mass_cluster_freq_3)
# summarize single-sequence clusters into PP clusters
sum_seq_man_clusters <- function(sequence_clust){
clustered_seqs <- rep(0, mass_clusters)
for (i in 1:mass_clusters) {
clustered_seqs[i] <- sum(sequence_clust[which(Mass_Samples_accCodes$SequenceCluster==i-1)])
}
clustered_seqs
}
#observed will be the mass_cluster_freq_2 and _3, not the c616 one
combined_compare_616 <- function(state, observed, pars = NULL) {
result <- 0
data_size <- sum(unlist(observed))
model_size = sum(unlist(state))
# need to summarize the data and the observations into clusters
clustered_state <- sum_seq_man_clusters(unlist(state))
for (i in 1:mass_clusters){
result <- result + ll_pois(observed[i], clustered_state[i]/model_size * data_size)
}
result
}
# COG man seq clusters
seq_clusters <- readRDS("Mass_Samples_accCodes.rds")
mass_clusters <- nrow(seq_clusters)
avg_cluster_freq <- rep(1/mass_clusters, mass_clusters)
c616_params_n_vP <- list(dt = 1/36, species_no = mass_clusters,  gene_no = nrow(c616_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = c616_intermed_gene_presence_absence_matrix, sigma_f = 0.20840945, sigma_w = 0.02772616, prop_f = 0.90395014, delta = as.double(delta_ranking), m = 0.17328677, migVec = as.double(avg_cluster_freq), vaccTypes = as.double(mass_seq_VT), v = 0.42626268, vacc_time = 0)
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = c616_params_n_vP,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
simMean2 <- rowMeans(WFmodel_nG_h_vP$run(36)[-1,])
simMean3 <- rowMeans(WFmodel_nG_h_vP$run(72)[-1,])
combined_compare_616(simMean2,mass_cluster_freq_2) + combined_compare_616(simMean3,mass_cluster_freq_3)
sum_seq_man_clusters(simMean2)
mass_clusters <- length(unique(Mass_Samples_accCodes$SequenceCluster))
c616_mass_cluster_freq_1 <- readRDS("mass_seq_freq_1.rds")
c616_mass_cluster_freq_2 <- readRDS(file = "mass_seq_freq_2.rds")
c616_mass_cluster_freq_3 <- readRDS(file = "mass_seq_freq_3.rds")
c616_intermed_gene_presence_absence <- readRDS("intermed_gene_presence_absence.rds")
c616_intermed_gene_presence_absence_matrix <- sapply(c616_intermed_gene_presence_absence[-1,-1],as.double)
seq_model_start_pop <- readRDS("seq_model_start_pop.rds")
mass_seq_VT <- readRDS("mass_seq_VT.rds")
man_mass_clusters <- length(unique(seq_clusters$SequenceCluster))
mass_clusters2 <- length(unique(seq_clusters$SequenceCluster))
# summarize single-sequence clusters into PP clusters
sum_seq_man_clusters <- function(sequence_clust){
clustered_seqs <- rep(0, mass_clusters)
for (i in 1:mass_clusters) {
clustered_seqs[i] <- sum(sequence_clust[which(Mass_Samples_accCodes$SequenceCluster==i-1)])
}
clustered_seqs
}
#observed will be the mass_cluster_freq_2 and _3, not the c616 one
combined_compare_616 <- function(state, observed, pars = NULL) {
result <- 0
data_size <- sum(unlist(observed))
model_size = sum(unlist(state))
# need to summarize the data and the observations into clusters
clustered_state <- sum_seq_man_clusters(unlist(state))
for (i in 1:mass_clusters){
result <- result + ll_pois(observed[i], clustered_state[i]/model_size * data_size)
}
result
}
# COG man seq clusters
seq_clusters <- readRDS("Mass_Samples_accCodes.rds")
avg_cluster_freq <- rep(1/nrow(seq_clusters), nrow(seq_clusters))
c616_params_n_vP <- list(dt = 1/36, species_no = nrow(seq_clusters),  gene_no = nrow(c616_intermed_gene_presence_absence)-1, Pop_ini = as.double(seq_model_start_pop), Pop_eq = as.double(seq_model_start_pop), capacity = sum(seq_model_start_pop), Genotypes = c616_intermed_gene_presence_absence_matrix, sigma_f = 0.20840945, sigma_w = 0.02772616, prop_f = 0.90395014, delta = as.double(delta_ranking), m = 0.17328677, migVec = as.double(avg_cluster_freq), vaccTypes = as.double(mass_seq_VT), v = 0.42626268, vacc_time = 0)
WFmodel_nG_h_vP <- WF_nG_h_vP$new(pars = c616_params_n_vP,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
simMean2 <- rowMeans(WFmodel_nG_h_vP$run(36)[-1,])
simMean3 <- rowMeans(WFmodel_nG_h_vP$run(72)[-1,])
combined_compare_616(simMean2,mass_cluster_freq_2) + combined_compare_616(simMean3,mass_cluster_freq_3)
sum_seq_man_clusters(simMean2)
mass_cluster_freq_2
seq_model_start_pop
### ggCaller PopPUNK
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.1180783495, sigma_w = 0.0004164005, prop_f = 0.3803173188, delta = ggC_delta_ranking, m = 0.0117180887, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1509501052, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])
source("CreateLollipopPlot.R")
lollipop_cluster_freqs_VTandNVT(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2/sum(simMeanggCPP2), PP_mass_VT)
#ggCPP_model_val1
lollipop_cluster_freqs_VTandNVT(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = PP_model_start_pop/sum(PP_model_start_pop), PP_mass_VT)
lollipop_cluster_freqs_VTandNVT(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2/sum(simMeanggCPP2), PP_mass_VT)
lollipop_cluster_freqs_VTandNVT(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), PP_mass_VT)
# ggCaller
null_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters, Pop_ini = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, vacc_time = 0, m = 0.008118758 , v = 0.031313422)
null_ggCPP_WFmodel <- WF_null$new(pars = null_ggCPP_params,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
simMeanggCPP2 <- rowMeans(null_ggCPP_WFmodel$run(36)[-1,])
simMeanggCPP3 <- rowMeans(null_ggCPP_WFmodel$run(72)[-1,])
#ggCPP_model_val1
lollipop_cluster_freqs_VTandNVT(year = "2001", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_1/sum(PP_mass_cluster_freq_1), model_name_1 ="Model", model1 = PP_model_start_pop/sum(PP_model_start_pop), PP_mass_VT)
lollipop_cluster_freqs_VTandNVT(year = "2004", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="Model", model1 = simMeanggCPP2/sum(simMeanggCPP2), PP_mass_VT)
lollipop_cluster_freqs_VTandNVT(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), PP_mass_VT)
lollipop_cluster_freqs_3points(data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model1 = simMeanggCPP3/sum(simMeanggCPP3), model2 = simMeanggCPP2/sum(simMeanggCPP2)
)
lollipop_cluster_freqs_2x2points(year = "2007",plot_title = "Non-Vaccine Types, Serotypes",data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 = "COGtriangles", model1 = simMeanggCPP3/sum(simMeanggCPP3), model_name_2 = "ggCaller", model2 = simMeanggCPP2/sum(simMeanggCPP2))
# Creating a joint Lollipop plot for VTs and NVTs and two models
lollipop_cluster_freqs_2x2_VTandNVT <- function(year = "year unknown", plot_title = "Generic Plot Title",data1, model_name_1 ="Model 1", model1, model_name_2 ="Model 2", model2, VT_vec){
lollipop_data_1 <- data.frame(
x=1:length(data1),
model_1=model1,
data_1=as.numeric(data1),
Vaccine_Types <- sapply(VT_vec, function(x) if(x==1){"VT"}else{"NVT"}),
data_2=as.numeric(data1),
model_2 =model2
)
# Change baseline
lollipop_plot_1 <- ggplot(lollipop_data_1) +
geom_segment( aes(x=x, xend=x, y=model_1, yend=data_1), color="grey") +
geom_segment( aes(x=x-0.3, xend=x-0.3, y=model_2, yend=data_2), color="grey") +
geom_point( aes(x=x, y=data_1, color="Data",shape = Vaccine_Types), size=3, stroke = 2) +
geom_point( aes(x=x-0.3, y=data_2, color="Data",shape = Vaccine_Types), size=3, stroke = 2) +
geom_point( aes(x=x, y=model_1, color=model_name_1,shape = Vaccine_Types), size=3, stroke = 2) +
geom_point( aes(x=x-0.3, y=model_2, color=model_name_2,shape = Vaccine_Types), size=3, stroke = 2) +
#geom_segment( aes(x=x, xend=x, y=model_1, yend=data_1), color="grey") +
#geom_point( aes(x=x, y=model_1, color=model_name_1, shape = Vaccine_Types), size=3, stroke = 2) +
#geom_point( aes(x=x, y=data_1, color="Data",shape = Vaccine_Types), size=3,  stroke = 2) +
#geom_point( aes(x=x, y=model_1, color=model_name_1), size=5, alpha = 0.7) +
#geom_point( aes(x=x, y=data_1, color="Data"), size=5, alpha = 0.7) +
#geom_point(aes(x=x, y=model_2, color=model_name_2), size=5, alpha = 0.7) +
scale_color_manual(values = c("#E69F00","#56B4E9","#CC79A7"),
guide  = guide_legend(),
name   = "Group") +
scale_shape_manual(values=c(19, 1))+
coord_flip()+
#theme_ipsum() +
theme(legend.position = c(.8,.8),legend.text = element_text(size = 20),legend.title = element_text(size = 20)) +
ggtitle(year) +
ylab("Frequency") +
xlab("Clusters") +
theme(axis.title  = element_text(size = 20), axis.text = element_text(size = 20), plot.title = element_text(size = 25,hjust = 0.5))  +
ylim(0, max(max(lollipop_data_1$model_1)))
grid.arrange(lollipop_plot_1 + scale_y_continuous(limits = c(NA,0.2)) + theme(plot.margin = unit(c(.5,0.5,1,0.5), "cm"),axis.text.y = element_blank()), ncol = 1, nrow=1, top = textGrob(plot_title,gp=gpar(fontsize=20,font=3)))
}
lollipop_cluster_freqs_2x2_VTandNVT(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), model2 = simMeanggCPP2/sum(simMeanggCPP2), PP_mass_VT)
lollipop_cluster_freqs_2x2_VTandNVT(year = "2007", plot_title = "PopPUNK and ggCaller", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), model2 = simMeanggCPP2/sum(simMeanggCPP2), VT_vec = PP_mass_VT)
### ggCaller PopPUNK
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.1180783495, sigma_w = 0.0004164005, prop_f = 0.3803173188, delta = ggC_delta_ranking, m = 0.0117180887, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.1509501052, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3)))
# [1] 0.4220826
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3))) + sum(abs(PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2) - simMeanggCPP2/sum(simMeanggCPP2)))
# [1] 0.8474369
sum(abs(PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3) - simMeanggCPP3/sum(simMeanggCPP3)))/PP_mass_clusters
# ggCaller
null_ggCPP_params <- list(dt = 1/36, species_no = PP_mass_clusters, Pop_ini = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, vacc_time = 0, m = 0.008118758 , v = 0.031313422)
null_ggCPP_WFmodel <- WF_null$new(pars = null_ggCPP_params,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
NullsimMeanggCPP2 <- rowMeans(null_ggCPP_WFmodel$run(36)[-1,])
NullsimMeanggCPP3 <- rowMeans(null_ggCPP_WFmodel$run(72)[-1,])
lollipop_cluster_freqs_2x2_VTandNVT(year = "2007", plot_title = "Full Model vs Null Model", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="NFDS Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), model2 = NullsimMeanggCPP3/sum(NullsimMeanggCPP3), VT_vec = PP_mass_VT)
lollipop_cluster_freqs_2x2_VTandNVT(year = "2007", plot_title = "Full Model vs Null Model", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="NFDS Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), model2 = NullsimMeanggCPP3/sum(NullsimMeanggCPP3), model_name_2 = "NULL Model", VT_vec = PP_mass_VT)
lollipop_cluster_freqs_2x2_VTandNVT(year = "2007", plot_title = "Full Model vs Null Model", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="NFDS Model", model1 = simMeanggCPP3/sum(simMeanggCPP3), model2 = NullsimMeanggCPP3/sum(NullsimMeanggCPP3), model_name_2 = "Null Model", VT_vec = PP_mass_VT)
lollipop_cluster_freqs_2x2_VTandNVT(year = "2004", plot_title = "Full Model vs Null Model", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="NFDS Model", model1 = simMeanggCPP2/sum(simMeanggCPP2), model2 = NullsimMeanggCPP2/sum(NullsimMeanggCPP2), model_name_2 = "Null Model", VT_vec = PP_mass_VT)
# 3-param
### ggCaller PopPUNK
params_ggCPP <- list(dt = 1/36, species_no = PP_mass_clusters,  gene_no = nrow(ggCPP_intermed_gene_presence_absence_consensus)-1, Pop_ini = as.double(PP_model_start_pop), Pop_eq = as.double(PP_model_start_pop), capacity = sum(PP_model_start_pop), Genotypes = ggCPP_intermed_gene_presence_absence_consensus_matrix, sigma_f = 0.01931485, sigma_w = 0, prop_f = 1, delta = ggC_delta_ranking, m = 0.03104461, migVec = PP_avg_cluster_freq, vaccTypes = PP_mass_VT, v = 0.15977862, vacc_time = 0)
WFmodel_ggCPP <- WF_nG_h_vP$new(pars = params_ggCPP,
time = 1,
n_particles = 10L,
n_threads = 4L,
seed = 1L)
p3_simMeanggCPP2 <- rowMeans(WFmodel_ggCPP$run(36)[-1,])
p3_simMeanggCPP3 <- rowMeans(WFmodel_ggCPP$run(72)[-1,])
lollipop_cluster_freqs_2x2_VTandNVT(year = "2004", plot_title = "Full Model vs Null Model", data1 = PP_mass_cluster_freq_2/sum(PP_mass_cluster_freq_2), model_name_1 ="NFDS Model", model1 = p3_simMeanggCPP2/sum(p3_simMeanggCPP2), model2 = NullsimMeanggCPP2/sum(NullsimMeanggCPP2), model_name_2 = "Null Model", VT_vec = PP_mass_VT)
lollipop_cluster_freqs_2x2_VTandNVT(year = "2007", plot_title = "Full Model vs Null Model", data1 = PP_mass_cluster_freq_3/sum(PP_mass_cluster_freq_3), model_name_1 ="NFDS Model", model1 = p3_simMeanggCPP3/sum(p3_simMeanggCPP3), model2 = NullsimMeanggCPP3/sum(NullsimMeanggCPP3), model_name_2 = "Null Model", VT_vec = PP_mass_VT)
